<H1 class=postTitle><A id=cb_post_title_url class=postTitle2 href="http://www.cnblogs.com/vamei/archive/2012/10/11/2720042.html">Python&#26631;&#20934;&#24211;08 &#22810;&#32447;&#31243;&#19982;&#21516;&#27493; (threading&#21253;)</A> </H1>
<DIV class=clear></DIV>
<DIV class=postBody>
<DIV id=cnblogs_post_body>
<P><SPAN style="FONT-FAMILY: courier new, courier">&#20316;&#32773;&#65306;Vamei &#20986;&#22788;&#65306;http://www.cnblogs.com/vamei &#27426;&#36814;&#36716;&#36733;&#65292;&#20063;&#35831;&#20445;&#30041;&#36825;&#27573;&#22768;&#26126;&#12290;&#35874;&#35874;&#65281;</SPAN></P>
<P><SPAN style="FONT-FAMILY: courier new, courier">&nbsp;</SPAN></P>
<P><SPAN style="FONT-FAMILY: courier new, courier">Python&#20027;&#35201;&#36890;&#36807;&#26631;&#20934;&#24211;&#20013;&#30340;<SPAN style="COLOR: #ff0000">threading</SPAN>&#21253;&#26469;&#23454;&#29616;<SPAN style="COLOR: #ff0000">&#22810;&#32447;&#31243;</SPAN>&#12290;&#22312;&#24403;&#20170;<SPAN style="COLOR: #ff0000">&#32593;&#32476;</SPAN>&#26102;&#20195;&#65292;&#27599;&#20010;&#26381;&#21153;&#22120;&#37117;&#20250;&#25509;&#25910;&#21040;&#22823;&#37327;&#30340;&#35831;&#27714;&#12290;&#26381;&#21153;&#22120;&#21487;&#20197;&#21033;&#29992;&#22810;&#32447;&#31243;&#30340;&#26041;&#24335;&#26469;&#22788;&#29702;&#36825;&#20123;&#35831;&#27714;&#65292;&#20197;&#25552;&#39640;&#23545;&#32593;&#32476;&#31471;&#21475;&#30340;&#35835;&#20889;&#25928;&#29575;&#12290;Python&#26159;&#19968;&#31181;&#32593;&#32476;&#26381;&#21153;&#22120;&#30340;&#21518;&#21488;&#24037;&#20316;&#35821;&#35328; (&#27604;&#22914;<A href="http://www.douban.com/people/ztftom/">&#35910;&#29923;&#32593;</A>)&#65292;&#25152;&#20197;&#22810;&#32447;&#31243;&#20063;&#23601;&#24456;&#33258;&#28982;&#34987;Python&#35821;&#35328;&#25903;&#25345;&#12290;</SPAN></P>
<P><SPAN style="FONT-FAMILY: courier new, courier">(&#20851;&#20110;&#22810;&#32447;&#31243;&#30340;&#21407;&#29702;&#21644;C&#23454;&#29616;&#26041;&#27861;&#65292;&#35831;&#21442;&#32771;&#25105;&#20043;&#21069;&#20889;&#30340;<A id=cb_post_title_url class=postTitle2 href="http://www.cnblogs.com/vamei/archive/2012/10/09/2715393.html">Linux&#22810;&#32447;&#31243;&#19982;&#21516;&#27493;</A>&#65292;&#35201;&#20102;&#35299;race condition, mutex&#21644;condition variable&#30340;&#27010;&#24565;)<BR></SPAN></P>
<P><SPAN style="FONT-FAMILY: courier new, courier">&nbsp;</SPAN></P>
<H3><SPAN style="FONT-FAMILY: courier new, courier">&#22810;&#32447;&#31243;&#21806;&#31080;&#20197;&#21450;&#21516;&#27493;</SPAN></H3>
<P><SPAN style="FONT-FAMILY: courier new, courier">&#25105;&#20204;&#20351;&#29992;Python&#26469;&#23454;&#29616;<A id=cb_post_title_url class=postTitle2 href="http://www.cnblogs.com/vamei/archive/2012/10/09/2715393.html">Linux&#22810;&#32447;&#31243;&#19982;&#21516;&#27493;</A>&#25991;&#20013;&#30340;&#21806;&#31080;&#31243;&#24207;&#12290;&#25105;&#20204;&#20351;&#29992;mutex (&#20063;&#23601;&#26159;Python&#20013;&#30340;<SPAN style="COLOR: #ff0000">Lock<SPAN style="COLOR: #000000">&#31867;&#23545;&#35937;</SPAN></SPAN>) &#26469;&#23454;&#29616;&#32447;&#31243;&#30340;&#21516;&#27493;:</SPAN></P>
<DIV class=cnblogs_code>
<DIV class=cnblogs_code_toolbar><SPAN class=cnblogs_code_copy><A title=&#22797;&#21046;&#20195;&#30721; void(0);"><IMG alt=&#22797;&#21046;&#20195;&#30721; src="http://common.cnblogs.com/images/copycode.gif"></A></SPAN></DIV><PRE><SPAN style="FONT-FAMILY: courier new, courier"><SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> A program to simulate selling tickets in multi-thread way</SPAN><SPAN style="COLOR: #008000">
#</SPAN><SPAN style="COLOR: #008000"> Written by Vamei</SPAN>

<SPAN style="COLOR: #0000ff">import</SPAN><SPAN style="COLOR: #000000"> threading
</SPAN><SPAN style="COLOR: #0000ff">import</SPAN><SPAN style="COLOR: #000000"> time
</SPAN><SPAN style="COLOR: #0000ff">import</SPAN><SPAN style="COLOR: #000000"> os

</SPAN><SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> This function could be any function to do other chores.</SPAN>
<SPAN style="COLOR: #0000ff">def</SPAN><SPAN style="COLOR: #000000"> doChore():
    time.sleep(</SPAN>0.5<SPAN style="COLOR: #000000">)

</SPAN><SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Function for each thread</SPAN>
<SPAN style="COLOR: #0000ff">def</SPAN><SPAN style="COLOR: #000000"> booth(tid):
    </SPAN><SPAN style="COLOR: #0000ff">global</SPAN><SPAN style="COLOR: #000000"> i
    </SPAN><SPAN style="COLOR: #0000ff">global</SPAN><SPAN style="COLOR: #000000"> lock<BR>    </SPAN><SPAN style="COLOR: #0000ff">while</SPAN><SPAN style="COLOR: #000000"> True:
        lock.acquire() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Lock; or wait if other thread is holding the lock</SPAN>
        </SPAN><SPAN style="COLOR: #0000ff">if</SPAN> i !=<SPAN style="COLOR: #000000"> 0:
            i </SPAN>= i - 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Sell tickets<BR></SPAN><SPAN style="COLOR: #0000ff">            print</SPAN>(tid,<SPAN style="COLOR: #800000">'</SPAN><SPAN style="COLOR: #800000">:now left:</SPAN><SPAN style="COLOR: #800000">'</SPAN>,i) <SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Tickets left</SPAN>
            doChore() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;<SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Other critical operations</SPAN>
        <SPAN style="COLOR: #0000ff">else</SPAN><SPAN style="COLOR: #000000">:
            </SPAN><SPAN style="COLOR: #0000ff">print</SPAN>(<SPAN style="COLOR: #800000">"</SPAN><SPAN style="COLOR: #800000">Thread_id</SPAN><SPAN style="COLOR: #800000">"</SPAN>,tid,<SPAN style="COLOR: #800000">"</SPAN><SPAN style="COLOR: #800000"> No more tickets</SPAN><SPAN style="COLOR: #800000">"</SPAN><SPAN style="COLOR: #000000">)
            os._exit(0)              </SPAN><SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Exit the whole process immediately</SPAN>
<SPAN style="COLOR: #000000">        lock.release() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Unblock</SPAN>
        doChore() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Non-critical operations</SPAN>

</SPAN><SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Start of the main function</SPAN>
i    = 100                           <SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Available ticket number </SPAN>
lock = threading.Lock()              <SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Lock (i.e., mutex)</SPAN>

<SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Start 10 threads</SPAN>
<SPAN style="COLOR: #0000ff">for</SPAN> k <SPAN style="COLOR: #0000ff">in</SPAN> range(10<SPAN style="COLOR: #000000">):
    new_thread </SPAN>= threading.Thread(target=booth,args=<SPAN style="COLOR: #000000">(k,)) &nbsp; <SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Set up thread; target: the callable (function) to be run, args: the argument for the callable </SPAN>
    new_thread.start()              &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </SPAN><SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> run the thread</SPAN></SPAN></PRE>
<DIV class=cnblogs_code_toolbar><SPAN class=cnblogs_code_copy><A title=&#22797;&#21046;&#20195;&#30721; void(0);"><IMG alt=&#22797;&#21046;&#20195;&#30721; src="http://common.cnblogs.com/images/copycode.gif"></A></SPAN></DIV></DIV>
<P><SPAN style="FONT-FAMILY: courier new, courier">&#25105;&#20204;&#20351;&#29992;&#20102;&#20004;&#20010;&#20840;&#23616;&#21464;&#37327;&#65292;&#19968;&#20010;&#26159;i&#65292;&#29992;&#20197;&#20648;&#23384;&#21097;&#20313;&#31080;&#25968;&#65307;&#19968;&#20010;&#26159;lock&#23545;&#35937;&#65292;&#29992;&#20110;&#21516;&#27493;&#32447;&#31243;&#23545;i&#30340;&#20462;&#25913;&#12290;&#27492;&#22806;&#65292;&#22312;&#26368;&#21518;&#30340;for&#24490;&#29615;&#20013;&#65292;&#25105;&#20204;&#24635;&#20849;&#35774;&#32622;&#20102;10&#20010;&#32447;&#31243;&#12290;&#27599;&#20010;&#32447;&#31243;&#37117;&#25191;&#34892;booth()&#20989;&#25968;&#12290;&#32447;&#31243;&#22312;&#35843;&#29992;start()&#26041;&#27861;&#30340;&#26102;&#20505;&#27491;&#24335;&#21551;&#21160; (&#23454;&#38469;&#19978;&#65292;&#35745;&#31639;&#26426;&#20013;&#26368;&#22810;&#20250;&#26377;11&#20010;&#32447;&#31243;&#65292;&#22240;&#20026;&#20027;&#31243;&#24207;&#26412;&#36523;&#20063;&#20250;&#21344;&#29992;&#19968;&#20010;&#32447;&#31243;)&#12290;Python&#20351;&#29992;<SPAN style="COLOR: #ff0000">threading.Thread</SPAN>&#23545;&#35937;&#26469;&#20195;&#34920;&#32447;&#31243;&#65292;&#29992;<SPAN style="COLOR: #ff0000">threading.Lock</SPAN>&#23545;&#35937;&#26469;&#20195;&#34920;&#19968;&#20010;&#20114;&#26021;&#38145; (mutex)&#12290;</SPAN></P>
<P><SPAN style="FONT-FAMILY: courier new, courier">&#26377;&#20004;&#28857;&#38656;&#35201;&#27880;&#24847;:</SPAN></P>
<UL>
<LI><SPAN style="FONT-FAMILY: courier new, courier">&#25105;&#20204;&#22312;&#20989;&#25968;&#20013;&#20351;&#29992;<SPAN style="COLOR: #ff0000">global</SPAN>&#26469;&#22768;&#26126;&#21464;&#37327;&#20026;&#20840;&#23616;&#21464;&#37327;&#65292;&#20174;&#32780;&#35753;&#22810;&#32447;&#31243;&#20849;&#20139;i&#21644;lock (&#22312;C&#35821;&#35328;&#20013;&#65292;&#25105;&#20204;&#36890;&#36807;&#23558;&#21464;&#37327;&#25918;&#22312;&#25152;&#26377;&#20989;&#25968;&#22806;&#38754;&#26469;&#35753;&#23427;&#25104;&#20026;&#20840;&#23616;&#21464;&#37327;)&#12290;&#22914;&#26524;&#19981;&#36825;&#20040;&#22768;&#26126;&#65292;&#30001;&#20110;i&#21644;lock&#26159;<SPAN style="COLOR: #ff0000">&#19981;&#21487;&#21464;&#25968;&#25454;&#23545;&#35937;</SPAN>&#65292;&#23427;&#20204;&#23558;&#34987;&#24403;&#20316;&#19968;&#20010;&#23616;&#37096;&#21464;&#37327;(&#21442;&#30475;<A id=cb_post_title_url class=postTitle2 href="http://www.cnblogs.com/vamei/archive/2012/07/10/2582795.html">Python&#21160;&#24577;&#31867;&#22411;</A>)&#12290;&#22914;&#26524;&#26159;<SPAN style="COLOR: #ff0000">&#21487;&#21464;&#25968;&#25454;&#23545;&#35937;</SPAN>&#30340;&#35805;&#65292;&#21017;&#19981;&#38656;&#35201;global&#22768;&#26126;&#12290;&#25105;&#20204;&#29978;&#33267;&#21487;&#20197;&#23558;<SPAN style="COLOR: #ff0000">&#21487;&#21464;&#25968;&#25454;&#23545;&#35937;</SPAN>&#20316;&#20026;&#21442;&#25968;&#26469;&#20256;&#36882;&#32473;&#32447;&#31243;&#20989;&#25968;&#12290;&#36825;&#20123;&#32447;&#31243;&#23558;&#20849;&#20139;&#36825;&#20123;&#21487;&#21464;&#25968;&#25454;&#23545;&#35937;&#12290;</SPAN></LI>
<LI><SPAN style="FONT-FAMILY: courier new, courier">&#25105;&#20204;&#22312;booth&#20013;&#20351;&#29992;&#20102;&#20004;&#20010;<SPAN style="COLOR: #ff0000">doChore()</SPAN>&#20989;&#25968;&#12290;&#21487;&#20197;&#22312;&#26410;&#26469;&#25913;&#36827;&#31243;&#24207;&#65292;&#20197;&#20415;&#35753;&#32447;&#31243;&#38500;&#20102;&#36827;&#34892;i=i-1&#20043;&#22806;&#65292;&#20570;&#26356;&#22810;&#30340;&#25805;&#20316;&#65292;&#27604;&#22914;&#25171;&#21360;&#21097;&#20313;&#31080;&#25968;&#65292;&#25214;&#38065;&#65292;&#25110;&#32773;&#21917;&#21475;&#27700;&#20043;&#31867;&#30340;&#12290;&#31532;&#19968;&#20010;doChore()&#20381;&#28982;&#22312;Lock&#20869;&#37096;&#65292;&#25152;&#20197;&#21487;&#20197;&#23433;&#20840;&#22320;<SPAN style="COLOR: #ff0000">&#20351;&#29992;&#20849;&#20139;&#36164;&#28304; </SPAN>(critical operations, &#27604;&#22914;&#25171;&#21360;&#21097;&#20313;&#31080;&#25968;)&#12290;&#31532;&#20108;&#20010;doChore()&#26102;&#65292;Lock&#24050;&#32463;&#34987;&#37322;&#25918;&#65292;&#25152;&#20197;&#19981;&#33021;&#20877;&#21435;&#20351;&#29992;&#20849;&#20139;&#36164;&#28304;&#12290;&#36825;&#26102;&#20505;&#21487;&#20197;&#20570;&#19968;&#20123;<SPAN style="COLOR: #ff0000">&#19981;&#20351;&#29992;&#20849;&#20139;&#36164;&#28304;</SPAN>&#30340;&#25805;&#20316; (non-critical operation, &#27604;&#22914;&#25214;&#38065;&#12289;&#21917;&#27700;)&#12290;&#25105;&#25925;&#24847;&#35753;doChore()&#31561;&#24453;&#20102;0.5&#31186;&#65292;&#20197;&#20195;&#34920;&#36825;&#20123;&#39069;&#22806;&#30340;&#25805;&#20316;&#21487;&#33021;&#33457;&#36153;&#30340;&#26102;&#38388;&#12290;&#20320;&#21487;&#20197;&#23450;&#20041;&#30340;&#20989;&#25968;&#26469;&#20195;&#26367;doChore()&#12290;</SPAN></LI></UL>
<P><SPAN style="FONT-FAMILY: courier new, courier">&nbsp;</SPAN></P>
<H3><SPAN style="FONT-FAMILY: courier new, courier">OOP&#21019;&#24314;&#32447;&#31243;</SPAN></H3>
<P><SPAN style="FONT-FAMILY: courier new, courier">&#19978;&#38754;&#30340;Python&#31243;&#24207;&#38750;&#24120;&#31867;&#20284;&#20110;&#19968;&#20010;&#38754;&#21521;&#36807;&#31243;&#30340;C&#31243;&#24207;&#12290;&#25105;&#20204;&#19979;&#38754;&#20171;&#32461;&#22914;&#20309;&#36890;&#36807;<SPAN style="COLOR: #ff0000">&#38754;&#21521;&#23545;&#35937; </SPAN>(OOP&#65292; object-oriented programming&#65292;&#21442;&#30475;<A id=cb_post_title_url class=postTitle2 href="http://www.cnblogs.com/vamei/archive/2012/06/02/2531515.html">Python&#38754;&#21521;&#23545;&#35937;&#30340;&#22522;&#26412;&#27010;&#24565;</A>&#21644;<A id=cb_post_title_url class=postTitle2 href="http://www.cnblogs.com/vamei/archive/2012/06/02/2532018.html">Python&#38754;&#21521;&#23545;&#35937;&#30340;&#36827;&#19968;&#27493;&#25299;&#23637;</A>) &#30340;&#26041;&#27861;&#23454;&#29616;&#22810;&#32447;&#31243;&#65292;&#20854;&#26680;&#24515;&#26159;&#32487;&#25215;<SPAN style="COLOR: #ff0000">threading.Thread</SPAN>&#31867;&#12290;&#25105;&#20204;&#19978;&#38754;&#30340;for&#24490;&#29615;&#20013;&#24050;&#32463;&#21033;&#29992;&#20102;threading.Thread()&#30340;&#26041;&#27861;&#26469;&#21019;&#24314;&#19968;&#20010;Thread&#23545;&#35937;&#65292;&#24182;&#23558;&#20989;&#25968;booth()&#20197;&#21450;&#20854;&#21442;&#25968;&#20256;&#36882;&#32473;&#25913;&#23545;&#35937;&#65292;&#24182;&#35843;&#29992;start()&#26041;&#27861;&#26469;&#36816;&#34892;&#32447;&#31243;&#12290;OOP&#30340;&#35805;&#65292;&#36890;&#36807;&#20462;&#25913;Thread&#31867;&#30340;<SPAN style="COLOR: #ff0000">run()</SPAN>&#26041;&#27861;&#26469;&#23450;&#20041;&#32447;&#31243;&#25152;&#35201;&#25191;&#34892;&#30340;&#21629;&#20196;&#12290;</SPAN></P>
<DIV class=cnblogs_code>
<DIV class=cnblogs_code_toolbar><SPAN class=cnblogs_code_copy><A title=&#22797;&#21046;&#20195;&#30721; void(0);"><IMG alt=&#22797;&#21046;&#20195;&#30721; src="http://common.cnblogs.com/images/copycode.gif"></A></SPAN></DIV><PRE><SPAN style="FONT-FAMILY: courier new, courier"><SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> A program to simulate selling tickets in multi-thread way</SPAN><SPAN style="COLOR: #008000">
#</SPAN><SPAN style="COLOR: #008000"> Written by Vamei</SPAN>

<SPAN style="COLOR: #0000ff">import</SPAN><SPAN style="COLOR: #000000"> threading
</SPAN><SPAN style="COLOR: #0000ff">import</SPAN><SPAN style="COLOR: #000000"> time
</SPAN><SPAN style="COLOR: #0000ff">import</SPAN><SPAN style="COLOR: #000000"> os

</SPAN><SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> This function could be any function to do other chores.</SPAN>
<SPAN style="COLOR: #0000ff">def</SPAN><SPAN style="COLOR: #000000"> doChore():
    time.sleep(</SPAN>0.5<SPAN style="COLOR: #000000">)

</SPAN><SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Function for each thread</SPAN>
<SPAN style="COLOR: #0000ff">class</SPAN><SPAN style="COLOR: #000000"> BoothThread(threading.Thread):
    </SPAN><SPAN style="COLOR: #0000ff">def</SPAN> <SPAN style="COLOR: #800080">__init__</SPAN><SPAN style="COLOR: #000000">(self, tid, monitor):
        self.tid          </SPAN>=<SPAN style="COLOR: #000000"> tid
        self.monitor </SPAN>=<SPAN style="COLOR: #000000"> monitor<BR>&nbsp; &nbsp; &nbsp; &nbsp; threading.Thread.__init__(self)
    </SPAN><SPAN style="COLOR: #0000ff">def</SPAN><SPAN style="COLOR: #000000"> run(self):
        </SPAN><SPAN style="COLOR: #0000ff">while</SPAN><SPAN style="COLOR: #000000"> True:
           &nbsp;monitor[</SPAN><SPAN style="COLOR: #800000">'</SPAN><SPAN style="COLOR: #800000">lock</SPAN><SPAN style="COLOR: #800000">'</SPAN>].acquire()               &nbsp; &nbsp; &nbsp;      <SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Lock; or wait if other thread is holding the lock</SPAN>
        &nbsp; &nbsp; <SPAN style="COLOR: #0000ff">if</SPAN> monitor[<SPAN style="COLOR: #800000">'</SPAN><SPAN style="COLOR: #800000">tick</SPAN><SPAN style="COLOR: #800000">'</SPAN>] !=<SPAN style="COLOR: #000000"> 0:
                monitor[</SPAN><SPAN style="COLOR: #800000">'</SPAN><SPAN style="COLOR: #800000">tick</SPAN><SPAN style="COLOR: #800000">'</SPAN>] = monitor[<SPAN style="COLOR: #800000">'</SPAN><SPAN style="COLOR: #800000">tick</SPAN><SPAN style="COLOR: #800000">'</SPAN>] - 1          <SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Sell tickets<BR></SPAN><SPAN style="COLOR: #0000ff">                print</SPAN>(self.tid,<SPAN style="COLOR: #800000">'</SPAN><SPAN style="COLOR: #800000">:now left:</SPAN><SPAN style="COLOR: #800000">'</SPAN>,monitor[<SPAN style="COLOR: #800000">'</SPAN><SPAN style="COLOR: #800000">tick</SPAN><SPAN style="COLOR: #800000">'</SPAN>])   <SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Tickets left</SPAN>
                doChore()                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;     <SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Other critical operations</SPAN>
            <SPAN style="COLOR: #0000ff">else</SPAN><SPAN style="COLOR: #000000">:
                </SPAN><SPAN style="COLOR: #0000ff">print</SPAN>(<SPAN style="COLOR: #800000">"</SPAN><SPAN style="COLOR: #800000">Thread_id</SPAN><SPAN style="COLOR: #800000">"</SPAN>,self.tid,<SPAN style="COLOR: #800000">"</SPAN><SPAN style="COLOR: #800000"> No more tickets</SPAN><SPAN style="COLOR: #800000">"</SPAN><SPAN style="COLOR: #000000">)
                os._exit(0)                               &nbsp; &nbsp; &nbsp;</SPAN><SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Exit the whole process immediately</SPAN>
            monitor[<SPAN style="COLOR: #800000">'</SPAN><SPAN style="COLOR: #800000">lock</SPAN><SPAN style="COLOR: #800000">'</SPAN>].release()                     &nbsp; &nbsp; &nbsp;<SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Unblock</SPAN>
            doChore()                                     &nbsp; &nbsp; &nbsp;<SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Non-critical operations</SPAN>

<SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Start of the main function</SPAN>
monitor = {<SPAN style="COLOR: #800000">'</SPAN><SPAN style="COLOR: #800000">tick</SPAN><SPAN style="COLOR: #800000">'</SPAN>:100, <SPAN style="COLOR: #800000">'</SPAN><SPAN style="COLOR: #800000">lock</SPAN><SPAN style="COLOR: #800000">'</SPAN><SPAN style="COLOR: #000000">:threading.Lock()}

</SPAN><SPAN style="COLOR: #008000">#</SPAN><SPAN style="COLOR: #008000"> Start 10 threads</SPAN>
<SPAN style="COLOR: #0000ff">for</SPAN> k <SPAN style="COLOR: #0000ff">in</SPAN> range(10<SPAN style="COLOR: #000000">):
    new_thread </SPAN>=<SPAN style="COLOR: #000000"> BoothThread(k, monitor)
    new_thread.start()</SPAN></SPAN></PRE>
<DIV class=cnblogs_code_toolbar><SPAN class=cnblogs_code_copy><A title=&#22797;&#21046;&#20195;&#30721; void(0);"><IMG alt=&#22797;&#21046;&#20195;&#30721; src="http://common.cnblogs.com/images/copycode.gif"></A></SPAN></DIV></DIV>
<P><SPAN style="FONT-FAMILY: courier new, courier">&#25105;&#20204;&#33258;&#24049;&#23450;&#20041;&#20102;&#19968;&#20010;&#31867;<SPAN style="COLOR: #ff0000">BoothThread</SPAN>, &#36825;&#20010;&#31867;<SPAN style="COLOR: #ff0000">&#32487;&#25215;&#33258;thread.Threading&#31867;</SPAN>&#12290;&#28982;&#21518;&#25105;&#20204;&#25226;&#19978;&#38754;&#30340;booth()&#25152;&#36827;&#34892;&#30340;&#25805;&#20316;&#32479;&#32479;&#25918;&#20837;&#21040;BoothThread&#31867;&#30340;<SPAN style="COLOR: #ff0000">run()</SPAN>&#26041;&#27861;&#20013;&#12290;&#27880;&#24847;&#65292;&#25105;&#20204;&#27809;&#26377;&#20351;&#29992;&#20840;&#23616;&#21464;&#37327;&#22768;&#26126;global&#65292;&#32780;&#26159;&#20351;&#29992;&#20102;&#19968;&#20010;<A href="http://www.cnblogs.com/vamei/archive/2012/06/06/2537436.html"><SPAN style="COLOR: #ff0000">&#35789;&#20856;</SPAN></A>monitor&#23384;&#25918;&#20840;&#23616;&#21464;&#37327;&#65292;&#28982;&#21518;&#25226;&#35789;&#20856;&#20316;&#20026;&#21442;&#25968;&#20256;&#36882;&#32473;&#32447;&#31243;&#20989;&#25968;&#12290;&#30001;&#20110;&#35789;&#20856;&#26159;<SPAN style="COLOR: #ff0000">&#21487;&#21464;&#25968;&#25454;&#23545;&#35937;</SPAN>&#65292;&#25152;&#20197;&#24403;&#23427;&#34987;&#20256;&#36882;&#32473;&#20989;&#25968;&#30340;&#26102;&#20505;&#65292;&#20989;&#25968;&#25152;&#20351;&#29992;&#30340;&#20381;&#28982;&#26159;&#21516;&#19968;&#20010;&#23545;&#35937;&#65292;&#30456;&#24403;&#20110;&#34987;&#22810;&#20010;&#32447;&#31243;&#25152;&#20849;&#20139;&#12290;&#36825;&#20063;&#26159;&#22810;&#32447;&#31243;&#20035;&#33267;&#20110;&#22810;&#36827;&#31243;&#32534;&#31243;&#30340;&#19968;&#20010;&#25216;&#24039; (&#24212;&#23613;&#37327;&#36991;&#20813;&#19978;&#38754;&#30340;global&#22768;&#26126;&#30340;&#29992;&#27861;&#65292;&#22240;&#20026;&#23427;&#24182;&#19981;&#36866;&#29992;&#20110;windows&#24179;&#21488;)&#12290;</SPAN></P>
<P><SPAN style="FONT-FAMILY: courier new, courier">&#19978;&#38754;OOP&#32534;&#31243;&#26041;&#27861;&#19982;&#38754;&#21521;&#36807;&#31243;&#30340;&#32534;&#31243;&#26041;&#27861;&#30456;&#27604;&#65292;&#24182;&#27809;&#26377;&#24102;&#26469;&#22826;&#22823;&#23454;&#36136;&#24615;&#30340;&#24046;&#21035;&#12290;</SPAN></P>
<P>&nbsp;</P>
<H3><SPAN style="FONT-FAMILY: courier new, courier">&#20854;&#20182;</SPAN></H3>
<P><SPAN style="FONT-FAMILY: courier new, courier"><SPAN style="COLOR: #ff0000">threading.Thread</SPAN>&#23545;&#35937;&#65306; &#25105;&#20204;&#24050;&#32463;&#20171;&#32461;&#20102;&#35813;&#23545;&#35937;&#30340;start()&#21644;run(), &#27492;&#22806;&#65306;</SPAN></P>
<UL>
<LI><SPAN style="FONT-FAMILY: courier new, courier"><SPAN style="COLOR: #ff0000">join()</SPAN>&#26041;&#27861;&#65292;&#35843;&#29992;&#35813;&#26041;&#27861;&#30340;&#32447;&#31243;&#23558;&#31561;&#24453;&#30452;&#21040;&#25913;Thread&#23545;&#35937;&#23436;&#25104;&#65292;&#20877;&#24674;&#22797;&#36816;&#34892;&#12290;&#36825;&#19982;&#36827;&#31243;&#38388;&#35843;&#29992;wait()&#20989;&#25968;&#30456;&#31867;&#20284;&#12290;</SPAN><SPAN style="FONT-FAMILY: courier new, courier"><BR></SPAN></LI></UL>
<P>&nbsp;</P>
<P>&#19979;&#38754;&#30340;&#23545;&#35937;&#29992;&#20110;&#22788;&#29702;<SPAN style="COLOR: #ff0000">&#22810;&#32447;&#31243;&#21516;&#27493;<SPAN style="COLOR: #000000">&#12290;&#23545;&#35937;&#19968;&#26086;&#34987;&#24314;&#31435;&#65292;&#21487;&#20197;&#34987;&#22810;&#20010;&#32447;&#31243;&#20849;&#20139;&#65292;&#24182;&#26681;&#25454;&#24773;&#20917;&#38459;&#22622;&#26576;&#20123;&#36827;&#31243;&#12290;&#35831;&#19982;<A id=cb_post_title_url class=postTitle2 href="http://www.cnblogs.com/vamei/archive/2012/10/09/2715393.html">Linux&#22810;&#32447;&#31243;&#19982;&#21516;&#27493;</A>&#20013;&#30340;&#21516;&#27493;&#24037;&#20855;&#21442;&#29031;&#38405;&#35835;&#12290;</SPAN></SPAN></P>
<P><SPAN style="FONT-FAMILY: courier new, courier"><SPAN style="COLOR: #ff0000">threading.Lock</SPAN>&#23545;&#35937;: mutex, &#26377;acquire()&#21644;release()&#26041;&#27861;&#12290;</SPAN></P>
<P><SPAN style="FONT-FAMILY: courier new, courier"><SPAN style="COLOR: #ff0000">threading.Condition</SPAN>&#23545;&#35937;: condition variable&#65292;&#24314;&#31435;&#35813;&#23545;&#35937;&#26102;&#65292;&#20250;&#21253;&#21547;&#19968;&#20010;Lock&#23545;&#35937; (&#22240;&#20026;condition variable&#24635;&#26159;&#21644;mutex&#19968;&#36215;&#20351;&#29992;)&#12290;&#21487;&#20197;&#23545;Condition&#23545;&#35937;&#35843;&#29992;acquire()&#21644;release()&#26041;&#27861;&#65292;&#20197;&#25511;&#21046;&#28508;&#22312;&#30340;Lock&#23545;&#35937;&#12290;&#27492;&#22806;:</SPAN></P>
<UL>
<LI><SPAN style="FONT-FAMILY: courier new, courier"><SPAN style="COLOR: #ff0000">wait()</SPAN>&#26041;&#27861;&#65292;&#30456;&#24403;&#20110;cond_wait()</SPAN></LI>
<LI><SPAN style="FONT-FAMILY: courier new, courier"><SPAN style="COLOR: #ff0000">notify_all()</SPAN>&#65292;&#30456;&#24403;&#19982;cond_broadcast() </SPAN></LI>
<LI><SPAN style="FONT-FAMILY: courier new, courier"><SPAN style="COLOR: #ff0000">nofify()</SPAN>&#65292;&#19982;notify_all()&#21151;&#33021;&#31867;&#20284;&#65292;&#20294;&#21482;&#21796;&#37266;&#19968;&#20010;&#31561;&#24453;&#30340;&#32447;&#31243;&#65292;&#32780;&#19981;&#26159;&#20840;&#37096;</SPAN></LI></UL>
<DL class=class>
<DT><SPAN style="FONT-FAMILY: courier new, courier"><SPAN style="COLOR: #ff0000">threading.Semaphore</SPAN>&#23545;&#35937;: semaphore&#65292;&#20063;&#23601;&#26159;&#35745;&#25968;&#38145;(semaphore&#20256;&#32479;&#24847;&#20041;&#19978;&#26159;&#19968;&#31181;&#36827;&#31243;&#38388;&#21516;&#27493;&#24037;&#20855;&#65292;&#35265;<A id=cb_post_title_url class=postTitle2 href="http://www.cnblogs.com/vamei/archive/2012/10/10/2715398.html">Linux&#36827;&#31243;&#38388;&#36890;&#20449;</A>)&#12290;&#21019;&#24314;&#23545;&#35937;&#30340;&#26102;&#20505;&#65292;&#21487;&#20197;&#20256;&#36882;&#19968;&#20010;&#25972;&#25968;&#20316;&#20026;<SPAN style="COLOR: #ff0000">&#35745;&#25968;&#19978;&#38480;</SPAN> (sema = threading.Semaphore(5))&#12290;&#23427;&#19982;Lock&#31867;&#20284;&#65292;&#20063;&#26377;Lock&#30340;&#20004;&#20010;&#26041;&#27861;&#12290;</SPAN></DT>
<DT><SPAN style="FONT-FAMILY: courier new, courier"><SPAN style="COLOR: #ff0000">threading.Event</SPAN>&#23545;&#35937;: &#19982;threading.Condition&#30456;&#31867;&#20284;&#65292;&#30456;&#24403;&#20110;&#27809;&#26377;&#28508;&#22312;&#30340;Lock&#20445;&#25252;&#30340;condition variable&#12290;&#23545;&#35937;&#26377;True&#21644;False&#20004;&#20010;&#29366;&#24577;&#12290;&#21487;&#20197;&#22810;&#20010;&#32447;&#31243;&#20351;&#29992;wait()&#31561;&#24453;&#65292;&#30452;&#21040;&#26576;&#20010;&#32447;&#31243;&#35843;&#29992;&#35813;&#23545;&#35937;&#30340;<SPAN style="COLOR: #ff0000">set()</SPAN>&#26041;&#27861;&#65292;&#23558;&#23545;&#35937;&#35774;&#32622;&#20026;True&#12290;&#32447;&#31243;&#21487;&#20197;&#35843;&#29992;&#23545;&#35937;&#30340;<SPAN style="COLOR: #ff0000">clear()</SPAN>&#26041;&#27861;&#26469;&#37325;&#32622;&#23545;&#35937;&#20026;False&#29366;&#24577;&#12290;<BR></SPAN></DT>
<DT><SPAN style="FONT-FAMILY: courier new, courier">&nbsp;</SPAN></DT>
<DT><SPAN style="FONT-FAMILY: courier new, courier">&nbsp;</SPAN></DT>
<DT></DT>
<DT></DT>
<DT></DT>
<DT><STRONG>&#32451;&#20064;</STRONG></DT>
<DT>&#21442;&#29031;<SPAN style="COLOR: #ff0000"><SPAN style="COLOR: #000000"><A id=cb_post_title_url class=postTitle2 href="http://www.cnblogs.com/vamei/archive/2012/10/09/2715393.html">Linux&#22810;&#32447;&#31243;&#19982;&#21516;&#27493;</A></SPAN></SPAN>&#20013;&#30340;condition variable&#30340;&#20363;&#23376;&#65292;&#20351;&#29992;Python&#23454;&#29616;&#12290;&#21516;&#26102;&#32771;&#34385;&#20351;&#29992;&#38754;&#21521;&#36807;&#31243;&#21644;&#38754;&#21521;&#23545;&#35937;&#30340;&#32534;&#31243;&#26041;&#27861;&#12290;</DT>
<DT></DT>
<DT></DT>
<DT></DT>
<DT></DT>
<DT></DT>
<DT><SPAN style="FONT-FAMILY: courier new, courier">&#26356;&#22810;&#30340;threading&#30340;&#20869;&#23481;&#35831;&#21442;&#32771;:</SPAN></DT></DL>
<P><SPAN style="FONT-FAMILY: courier new, courier"><A href="http://docs.python.org/library/threading.html">http://docs.python.org/library/threading.html</A></SPAN></P>
<P><SPAN style="FONT-FAMILY: courier new, courier">&nbsp;</SPAN></P>
<H3><SPAN style="FONT-FAMILY: courier new, courier">&#24635;&#32467;<BR></SPAN></H3>
<P><SPAN style="FONT-FAMILY: courier new, courier">threading.Thread<BR></SPAN></P>
<P><SPAN style="FONT-FAMILY: courier new, courier">Lock, Condition, Semaphore, Event<BR></SPAN></P></DIV></DIV>