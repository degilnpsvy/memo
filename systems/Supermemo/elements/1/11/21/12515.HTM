<H2 style="MARGIN: 12pt 0cm 6pt"><SPAN lang=EN-US style="FONT-SIZE: 23pt; mso-bidi-font-size: 18.0pt">Sparse files in Unix</SPAN></H2>
<P class=MsoBodyText style="MARGIN: 0cm 0cm 6pt"><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt">Sparse files are typically handled transparently to the user. But the differences between a normal file and sparse file become apparent in some situations.</SPAN></P>
<H3 style="MARGIN: 12pt 0cm 6pt"><A name=Creation></A><SPAN lang=EN-US style="FONT-SIZE: 19pt; mso-bidi-font-size: 14.0pt">Creation</SPAN></H3>
<P class=MsoBodyText style="MARGIN: 0cm 0cm 6pt"><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"><FONT class=extract>The </FONT><A href="http://en.wikipedia.org/wiki/Unix"><FONT class=extract color=#000080>Unix</FONT></A><FONT class=extract> command</FONT></SPAN></P>
<P class=PreformattedText style="MARGIN: 0cm 0cm 14.15pt"><SPAN lang=EN-US style="FONT-SIZE: 16pt; mso-bidi-font-size: 10.0pt"><FONT class=extract face=&#23435;&#20307;>dd of=sparse-file bs=1k seek=5120 count=0</FONT></SPAN></P>
<P class=MsoBodyText style="MARGIN: 0cm 0cm 6pt"><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"><FONT class=extract>will create a file of five </FONT><A href="http://en.wikipedia.org/wiki/Mebibyte"><FONT class=extract color=#000080>mebibytes</FONT></A><FONT class=extract> in size, but with no data stored on disk (only </FONT><A href="http://en.wikipedia.org/wiki/Metadata"><FONT class=extract color=#000080>metadata</FONT></A><FONT class=extract>). (</FONT><A href="http://en.wikipedia.org/wiki/GNU"><FONT class=extract color=#000080>GNU</FONT></A><FONT class=extract> </FONT><A href="http://en.wikipedia.org/wiki/Dd_(Unix)"><FONT class=extract color=#000080>dd</FONT></A><FONT class=extract> has this behaviour because it calls </FONT></SPAN><FONT class=extract><SPAN class=Teletype><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">ftruncate</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> to set the file size; other implementations may merely create an empty file.)</SPAN></FONT></P>
<P class=MsoBodyText style="MARGIN: 0cm 0cm 6pt"><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"><FONT class=extract>Similarly the truncate command may be used, if available:</FONT></SPAN></P>
<P class=PreformattedText style="MARGIN: 0cm 0cm 14.15pt"><SPAN lang=EN-US style="FONT-SIZE: 16pt; mso-bidi-font-size: 10.0pt"><FONT class=extract face=&#23435;&#20307;>truncate -s 5M &lt;filename&gt;</FONT></SPAN></P>
<H3 style="MARGIN: 12pt 0cm 6pt"><A name=Detection></A><SPAN lang=EN-US style="FONT-SIZE: 19pt; mso-bidi-font-size: 14.0pt"><FONT class=extract>Detection</FONT></SPAN></H3>
<P class=MsoBodyText style="MARGIN: 0cm 0cm 6pt"><FONT class=extract><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt">The </SPAN><SPAN class=Teletype><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">-s</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> option of the </SPAN><SPAN class=Teletype><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">ls</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> command shows the occupied space in blocks, and </SPAN><SPAN class=Teletype><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">-k</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> the apparent size in blocks too:</SPAN></FONT></P>
<P class=PreformattedText style="MARGIN: 0cm 0cm 14.15pt"><SPAN lang=EN-US style="FONT-SIZE: 16pt; mso-bidi-font-size: 10.0pt"><FONT face=&#23435;&#20307;><FONT class=extract>ls -lks sparse-file<SPAN class=Teletype></SPAN></FONT></FONT></SPAN></P>
<P class=MsoBodyText style="MARGIN: 0cm 0cm 6pt"><FONT class=extract><SPAN class=Teletype><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">-h</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> can be used to print both in human readable format.</SPAN></FONT></P>
<P class=MsoBodyText style="MARGIN: 0cm 0cm 6pt"><FONT class=extract><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt">Alternatively, the </SPAN><SPAN class=Teletype><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">du</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> command prints the occupied space, while </SPAN><SPAN class=Teletype><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">ls</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> prints the apparent size. The option </SPAN><SPAN class=Teletype><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">--block-size=1</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> prints the occupied space in bytes instead of blocks, so that it can be compared to the </SPAN><SPAN class=Teletype><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">ls</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> output:</SPAN></FONT></P>
<P class=PreformattedText style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="FONT-SIZE: 16pt; mso-bidi-font-size: 10.0pt"><FONT class=extract face=&#23435;&#20307;>du --block-size=1 sparse-file</FONT></SPAN></P>
<P class=PreformattedText style="MARGIN: 0cm 0cm 14.15pt"><SPAN lang=EN-US style="FONT-SIZE: 16pt; mso-bidi-font-size: 10.0pt"><FONT class=extract face=&#23435;&#20307;>ls -l sparse-file</FONT></SPAN></P>
<H3 style="MARGIN: 12pt 0cm 6pt"><A name=Copying></A><SPAN lang=EN-US style="FONT-SIZE: 19pt; mso-bidi-font-size: 14.0pt"><FONT class=extract>Copying</FONT></SPAN></H3>
<P class=MsoBodyText style="MARGIN: 0cm 0cm 6pt"><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"><FONT class=extract>Normally, the GNU version of </FONT><A href="http://en.wikipedia.org/wiki/Cp_(Unix)"><FONT class=extract color=#000080>cp</FONT></A><FONT class=extract> is good at detecting whether a file is sparse, so</FONT></SPAN></P>
<P class=PreformattedText style="MARGIN: 0cm 0cm 14.15pt"><SPAN lang=EN-US style="FONT-SIZE: 16pt; mso-bidi-font-size: 10.0pt"><FONT class=extract face=&#23435;&#20307;>cp sparse-file new-file</FONT></SPAN></P>
<P class=MsoBodyText style="MARGIN: 0cm 0cm 6pt"><FONT class=extract><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt">creates new-file, which will be sparse. However, GNU cp does have a </SPAN><SPAN class=SourceText><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">--sparse=WHEN</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> option.<A name=cite_ref-2></A><A href="http://en.wikipedia.org/wiki/Sparse_file#cite_note-2"><FONT color=#000080>[2]</FONT></A> This is especially useful if a file containing long zero blocks is saved in a non-sparse way (i.e. the zero blocks have been written out to disk in full). Disk space can be saved by doing:</SPAN></FONT></P>
<P class=PreformattedText style="MARGIN: 0cm 0cm 14.15pt"><SPAN lang=EN-US style="FONT-SIZE: 16pt; mso-bidi-font-size: 10.0pt"><FONT class=extract face=&#23435;&#20307;>cp --sparse=always file1 file1_sparsed</FONT></SPAN></P>
<P class=MsoBodyText style="MARGIN: 0cm 0cm 6pt"><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"><FONT class=extract>Some cp implementations, like </FONT><A href="http://en.wikipedia.org/wiki/FreeBSD"><FONT class=extract color=#000080>FreeBSD</FONT></A><FONT class=extract>'s cp, do not support the </FONT></SPAN><FONT class=extract><SPAN class=SourceText><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">--sparse</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> option and will always expand sparse files. A partially viable alternative on those systems is to use <A href="http://en.wikipedia.org/wiki/Rsync"><FONT color=#000080>rsync</FONT></A> with its own </SPAN><SPAN class=SourceText><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">--sparse</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> option<A name=cite_ref-3></A><A href="http://en.wikipedia.org/wiki/Sparse_file#cite_note-3"><FONT color=#000080>[3]</FONT></A> instead of cp. Unfortunately </SPAN><SPAN class=SourceText><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">--sparse</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt"> cannot be combined with </SPAN><SPAN class=SourceText><SPAN lang=EN-US style="FONT-SIZE: 22pt; mso-bidi-font-size: 12.0pt">--inplace</SPAN></SPAN><SPAN lang=EN-US style="FONT-SIZE: 17pt; mso-bidi-font-size: 12.0pt">, so rsyncing huge files across the network will always be wasteful of either network bandwidth or disk bandwidth.[<A href="http://en.wikipedia.org/wiki/Wikipedia:Citation_needed"><FONT color=#000080>citation needed</FONT></A>]</SPAN></FONT></P>
<H3 style="MARGIN: 12pt 0cm 6pt"><A name=Piping></A><SPAN lang=EN-US style="FONT-SIZE: 19pt; mso-bidi-font-size: 14.0pt"><FONT class=extract>Piping</FONT></SPAN></H3>
<P class=PreformattedText style="MARGIN: 0cm 0cm 14.15pt"><SPAN lang=EN-US style="FONT-SIZE: 16pt; mso-bidi-font-size: 10.0pt"><FONT class=extract face=&#23435;&#20307;>cat somefile | cp --sparse=always /proc/self/fd/0 new-sparse-file</FONT></SPAN>