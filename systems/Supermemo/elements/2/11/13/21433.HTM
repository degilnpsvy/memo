# Use make M=dir to specify directory of external module to build<BR># Old syntax make ... SUBDIRS=$PWD is still supported<BR># Setting the environment variable KBUILD_EXTMOD take precedence<BR>ifdef SUBDIRS<BR>&nbsp; KBUILD_EXTMOD ?= $(SUBDIRS)<BR>endif 
<P></P>
<P>ifeq ("$(origin M)", "command line")<BR>&nbsp; KBUILD_EXTMOD := $(M)<BR>endif</P>
<P><FONT class=extract># If building an external module we do not care about the all: rule<BR># but instead _all depend on modules<BR>PHONY += all<BR>ifeq ($(KBUILD_EXTMOD),)<BR>_all: all<BR>else<BR>_all: modules<BR>endif</FONT></P>
<P>ifeq ($(KBUILD_SRC),)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # building in the source tree<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; srctree := .<BR>else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ifeq ($(KBUILD_SRC)/,$(dir $(CURDIR)))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # building in a subdirectory of the source tree<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; srctree := ..<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; srctree := $(KBUILD_SRC)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endif<BR>endif<BR>objtree&nbsp;&nbsp;:= .<BR>src&nbsp;&nbsp;:= $(srctree)<BR>obj&nbsp;&nbsp;:= $(objtree)</P>
<P>VPATH&nbsp;&nbsp;:= $(srctree)$(if $(KBUILD_EXTMOD),:$(KBUILD_EXTMOD))</P>
<P>export srctree objtree VPATH