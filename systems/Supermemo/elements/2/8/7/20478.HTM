<P style="TEXT-ALIGN: left; TEXT-INDENT: 50.95pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><SPAN style="FONT-FAMILY: 'Myriad-CnSemibold','sans-serif'; FONT-SIZE: 26pt; mso-bidi-font-size: 18.0pt; mso-bidi-font-family: Myriad-CnSemibold; mso-font-kerning: 0pt" lang=EN-US>Preliminaries</SPAN></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>We are getting closer to looking at some actual module code. But first, we need to look at some other things that need to appear in your module source files. The kernel is a unique environment, and it imposes its own requirements on code that would interface with it.</SPAN></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>Most kernel code ends up including a fairly large number of header files to get definitions of functions, data types, and variables. We&#8217;ll examine these files as we come to them, but there are a few that are specific to modules, and must appear in every loadable module. Thus, just about all module code has the following:</SPAN></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 21.55pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 11pt; mso-bidi-font-size: 8.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT class=extract face=Calibri>#include &lt;linux/module.h&gt;</FONT></SPAN></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 21.55pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 11pt; mso-bidi-font-size: 8.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT class=extract face=Calibri>#include &lt;linux/init.h&gt;</FONT></SPAN></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><FONT class=extract><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt; mso-fareast-font-family: Birka-Italic" lang=EN-US>module.h </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>contains a great many definitions of symbols and functions needed by loadable modules. You need </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt; mso-fareast-font-family: Birka-Italic" lang=EN-US>init.h </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>to specify your initialization and cleanup functions, as we saw in the &#8220;hello world&#8221; example above, and which we revisit in the next section. Most modules also include </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt; mso-fareast-font-family: Birka-Italic" lang=EN-US>moduleparam.h </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>to enable the passing of parameters to the module at load time; we will get to that shortly.</SPAN></FONT></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><FONT class=extract><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>It is not strictly necessary, but your module really should specify which license applies to its code. Doing so is just a matter of including a </SPAN><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 12pt; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT face=Calibri>MODULE_LICENSE </FONT></SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>line:</SPAN></FONT></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 21.55pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 11pt; mso-bidi-font-size: 8.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT class=extract face=Calibri>MODULE_LICENSE("GPL");</FONT></SPAN></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><FONT class=extract><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>The specific licenses recognized by the kernel are &#8220;GPL&#8221; (for any version of the GNU General Public License), &#8220;GPL v2&#8221; (for GPL version two only), &#8220;GPL and additional rights,&#8221; &#8220;Dual BSD/GPL,&#8221; &#8220;Dual MPL/GPL,&#8221; and &#8220;Proprietary.&#8221; Unless your module is explicitly marked as being under a free license recognized by the kernel, it is assumed to be proprietary, and the kernel is &#8220;tainted&#8221; when the module is loaded. As we mentioned in the section &#8220;License Terms&#8221; in Chapter 1, kernel developers tend to be unenthusiastic about helping users who experience problems after loading proprietary </SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>modules.</SPAN></FONT></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><FONT class=extract><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>Other descriptive definitions that can be contained within a module include </SPAN><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 12pt; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT face=Calibri>MODULE_AUTHOR </FONT></SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>(stating who wrote the module), </SPAN><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 12pt; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT face=Calibri>MODULE_DESCRIPTION </FONT></SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>(a human-readable statement of what the module does), </SPAN><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 12pt; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT face=Calibri>MODULE_VERSION </FONT></SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>(for a code revision number; see the comments in </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt; mso-fareast-font-family: Birka-Italic" lang=EN-US>&lt;linux/module.h&gt; </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>for the conventions to use in creating version strings), </SPAN><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 12pt; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT face=Calibri>MODULE_ALIAS </FONT></SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>(another name by which this module can be known), and </SPAN><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 12pt; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT face=Calibri>MODULE_DEVICE_TABLE </FONT></SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>(to tell user space about which devices the module supports). We&#8217;ll discuss </SPAN><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 12pt; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT face=Calibri>MODULE_ALIAS </FONT></SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>in Chapter 11 and </SPAN><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 12pt; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT face=Calibri>MODULE_DEVICE_TABLE </FONT></SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>in </SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>Chapter 12.</SPAN></FONT></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><FONT class=extract><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>The various </SPAN><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 12pt; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt; mso-hansi-font-family: Myriad-CnSemibold" lang=EN-US><FONT face=Calibri>MODULE_ </FONT></SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: Birka; mso-font-kerning: 0pt; mso-fareast-font-family: Birka" lang=EN-US>declarations can appear anywhere within your source file outside of a function. A relatively recent convention in kernel code, however, is to put these declarations at the end of the file.</SPAN></FONT>