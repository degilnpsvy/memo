<P style="TEXT-ALIGN: left; TEXT-INDENT: 43.1pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><SPAN style="FONT-FAMILY: 'Myriad-CnSemibold','sans-serif'; FONT-SIZE: 22pt; mso-bidi-font-size: 15.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Myriad-CnSemibold; mso-font-kerning: 0pt" lang=EN-US>Loading and Unloading Modules</SPAN></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>After the module is built, the next step is loading it into the kernel. As we&#8217;ve already pointed out, </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>insmod </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>does the job for you. The program loads the module code and data into the kernel, which, in turn, performs a function similar to that of </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>ld</SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>, in that it links any unresolved symbol in the module to the symbol table of the kernel. Unlike the linker, however, the kernel doesn&#8217;t modify the module&#8217;s disk file, but rather an in-memory copy. </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>insmod </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>accepts a number of command-line options (for details, see the manpage), and it can assign values to parameters in your module before linking it to the current kernel. Thus, if a module is correctly designed, it can be configured at load time; load-time configuration gives the user more flexibility than compile-time configuration, which is still used sometimes. Load-time configuration is explained in the section &#8220;Module Parameters,&#8221; later in this chapter.</SPAN></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><FONT class=extract><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>Interested readers may want to look at how the kernel supports </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>insmod</SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>: it relies on a system call defined in </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>kernel/module.c</SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>. The function </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>sys_init_module </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>allocates kernel memory to hold a module (this memory is allocated with </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>vmalloc</SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>; see the section &#8220;vmalloc and Friends&#8221; in Chapter 8); it then copies the module text into that memory region, resolves kernel references in the module via the kernel symbol table, and calls the module&#8217;s initialization function to get everything going.</SPAN></FONT></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><FONT class=extract><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>If you actually look in the kernel source, you&#8217;ll find that the names of the system calls are prefixed with </SPAN><SPAN style="FONT-FAMILY: TheSansMonoCondensed-SemiLight; FONT-SIZE: 12pt; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: TheSansMonoCondensed-SemiLight; mso-font-kerning: 0pt" lang=EN-US><FONT face=Calibri>sys_</FONT></SPAN><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>. This is true for all system calls and no other functions; it&#8217;s useful to keep this in mind when grepping for the system calls in the sources.</SPAN></FONT></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><FONT class=extract><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>The </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>modprobe </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>utility is worth a quick mention. </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>modprobe</SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>, like </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>insmod</SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>, loads a module into the kernel. It differs in that it will look at the module to be loaded to see whether it references any symbols that are not currently defined in the kernel. If any such references are found, </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>modprobe </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>looks for other modules in the current module search path that define the relevant symbols. When </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>modprobe </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>finds those modules (which are needed by the module being loaded), it loads them into the kernel as well. If you use </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>insmod </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>in this situation instead, the command fails with an &#8220;unresolved symbols&#8221; message left in the system logfile.</SPAN></FONT></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><FONT class=extract><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>As mentioned before, modules may be removed from the kernel with the </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>rmmod </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>utility. Note that module removal fails if the kernel believes that the module is still in use (e.g., a program still has an open file for a device exported by the modules), or if the kernel has been configured to disallow module removal. It is possible to configure the kernel to allow &#8220;forced&#8221; removal of modules, even when they appear to be busy. If you reach a point where you are considering using this option, however, things are likely to have gone wrong badly enough that a reboot may well be the better course of action.</SPAN></FONT></P>
<P style="TEXT-ALIGN: left; TEXT-INDENT: 27.45pt; MARGIN: 0cm 0cm 0pt; mso-char-indent-count: 1.96; mso-layout-grid-align: none" class=MsoNormal align=left><FONT class=extract><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>The </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>lsmod </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>program produces a list of the modules currently loaded in the kernel. Some other information, such as any other modules making use of a specific module, is also provided. </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>lsmod </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>works by reading the </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>/proc/modules </SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>virtual file. Information on currently loaded modules can also be found in the sysfs virtual filesystem under </SPAN><I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka-Italic; mso-bidi-font-family: Birka-Italic; mso-font-kerning: 0pt" lang=EN-US>/sys/module</SPAN></I><SPAN style="FONT-FAMILY: '&#24494;&#36719;&#38597;&#40657;','sans-serif'; FONT-SIZE: 14pt; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: Birka; mso-bidi-font-family: Birka; mso-font-kerning: 0pt" lang=EN-US>.</SPAN></FONT>