<H3 style="LINE-HEIGHT: normal; TEXT-TRANSFORM: none; FONT-VARIANT: normal; FONT-STYLE: normal; TEXT-INDENT: 0px; FONT-FAMILY: Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px" class=section>3.20 Using Precompiled Headers</H3>
<P style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px"><A name=index-precompiled-headers-2633></A><A name=index-speed-of-compilation-2634></A>Often large projects have many header files that are included in every source file. The time the compiler takes to process these header files over and over again can account for nearly all of the time required to build the project. To make builds faster, GCC allows you to<SPAN class=Apple-converted-space>&nbsp;</SPAN><DFN>precompile</DFN><SPAN class=Apple-converted-space>&nbsp;</SPAN>a header file.</P>
<P style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px">To create a precompiled header file, simply compile it as you would any other file, if necessary using the<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-x</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>option to make the driver treat it as a C or C++ header file. You may want to use a tool like<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=command>make</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>to keep the precompiled header up-to-date when the headers it contains change.</P>
<P style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px">A precompiled header file is searched for when<SPAN class=Apple-converted-space>&nbsp;</SPAN><CODE>#include</CODE><SPAN class=Apple-converted-space>&nbsp;</SPAN>is seen in the compilation. As it searches for the included file (see<SPAN class=Apple-converted-space>&nbsp;</SPAN><A href="https://gcc.gnu.org/onlinedocs/gcc-4.9.1/cpp/Search-Path.html#Search-Path">Search Path</A>) the compiler looks for a precompiled header in each directory just before it looks for the include file in that directory. The name searched for is the name specified in the<SPAN class=Apple-converted-space>&nbsp;</SPAN><CODE>#include</CODE><SPAN class=Apple-converted-space>&nbsp;</SPAN>with &#8216;<SAMP><SPAN class=samp>.gch</SPAN></SAMP>&#8217; appended. If the precompiled header file can't be used, it is ignored.</P>
<P style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px">For instance, if you have<SPAN class=Apple-converted-space>&nbsp;</SPAN><CODE>#include "all.h"</CODE>, and you have<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=file>all.h.gch</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>in the same directory as<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=file>all.h</SPAN></SAMP>, then the precompiled header file is used if possible, and the original header is used otherwise.</P>
<P style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px">Alternatively, you might decide to put the precompiled header file in a directory and use<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-I</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>to ensure that directory is searched before (or instead of) the directory containing the original header. Then, if you want to check that the precompiled header file is always used, you can put a file of the same name as the original header in this directory containing an<SPAN class=Apple-converted-space>&nbsp;</SPAN><CODE>#error</CODE><SPAN class=Apple-converted-space>&nbsp;</SPAN>command.</P>
<P style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px">This also works with<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-include</SPAN></SAMP>. So yet another way to use precompiled headers, good for projects not designed with precompiled header files in mind, is to simply take most of the header files used by a project, include them from another header file, precompile that header file, and<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-include</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>the precompiled header. If the header files have guards against multiple inclusion, they are skipped because they've already been included (in the precompiled header).</P>
<P style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px">If you need to precompile the same header file for different languages, targets, or compiler options, you can instead make a<SPAN class=Apple-converted-space>&nbsp;</SPAN><EM>directory</EM><SPAN class=Apple-converted-space>&nbsp;</SPAN>named like<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=file>all.h.gch</SPAN></SAMP>, and put each precompiled header in the directory, perhaps using<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-o</SPAN></SAMP>. It doesn't matter what you call the files in the directory; every precompiled header in the directory is considered. The first precompiled header encountered in the directory that is valid for this compilation is used; they're searched in no particular order.</P>
<P style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px">There are many other possibilities, limited only by your imagination, good sense, and the constraints of your build system.</P>
<P style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px">A precompiled header file can be used only when these conditions apply:</P>
<UL style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px">
<LI>Only one precompiled header can be used in a particular compilation.</LI>
<LI>A precompiled header can't be used once the first C token is seen. You can have preprocessor directives before a precompiled header; you cannot include a precompiled header from inside another header.</LI>
<LI>The precompiled header file must be produced for the same language as the current compilation. You can't use a C precompiled header for a C++ compilation.</LI>
<LI>The precompiled header file must have been produced by the same compiler binary as the current compilation is using.</LI>
<LI>Any macros defined before the precompiled header is included must either be defined in the same way as when the precompiled header was generated, or must not affect the precompiled header, which usually means that they don't appear in the precompiled header at all.
<P>The<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-D</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>option is one way to define a macro before a precompiled header is included; using a<SPAN class=Apple-converted-space>&nbsp;</SPAN><CODE>#define</CODE><SPAN class=Apple-converted-space>&nbsp;</SPAN>can also do it. There are also some options that define macros implicitly, like<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-O</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>and<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-Wdeprecated</SPAN></SAMP>; the same rule applies to macros defined this way.</P></LI>
<LI>If debugging information is output when using the precompiled header, using<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-g</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>or similar, the same kind of debugging information must have been output when building the precompiled header. However, a precompiled header built using<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-g</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>can be used in a compilation when no debugging information is being output.</LI>
<LI>The same<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-m</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>options must generally be used when building and using the precompiled header. See<SPAN class=Apple-converted-space>&nbsp;</SPAN><A href="https://gcc.gnu.org/onlinedocs/gcc-4.9.1/gcc/Submodel-Options.html#Submodel-Options">Submodel Options</A>, for any cases where this rule is relaxed.</LI>
<LI>Each of the following options must be the same when building and using the precompiled header:<PRE style="FONT-SIZE: smaller" class=smallexample>          -fexceptions
</PRE></LI>
<LI>Some other command-line options starting with<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-f</SPAN></SAMP>,<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-p</SPAN></SAMP>, or<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-O</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>must be defined in the same way as when the precompiled header was generated. At present, it's not clear which options are safe to change and which are not; the safest choice is to use exactly the same options when generating and using the precompiled header. The following are known to be safe:<PRE style="FONT-SIZE: smaller" class=smallexample>          -fmessage-length=  -fpreprocessed  -fsched-interblock 
          -fsched-spec  -fsched-spec-load  -fsched-spec-load-dangerous 
          -fsched-verbose=<VAR>number</VAR>  -fschedule-insns  -fvisibility= 
          -pedantic-errors
</PRE></LI></UL>
<P style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px">For all of these except the last, the compiler automatically ignores the precompiled header if the conditions aren't met. If you find an option combination that doesn't work and doesn't cause the precompiled header to be ignored, please consider filing a bug report, see<SPAN class=Apple-converted-space>&nbsp;</SPAN><A href="https://gcc.gnu.org/onlinedocs/gcc-4.9.1/gcc/Bugs.html#Bugs">Bugs</A>.</P>
<P style="TEXT-TRANSFORM: none; TEXT-INDENT: 0px; FONT: medium Simsun; WHITE-SPACE: normal; LETTER-SPACING: normal; COLOR: rgb(0,0,0); WORD-SPACING: 0px; -webkit-text-stroke-width: 0px">If you do use differing options when generating and using the precompiled header, the actual behavior is a mixture of the behavior for the options. For instance, if you use<SPAN class=Apple-converted-space>&nbsp;</SPAN><SAMP><SPAN class=option>-g</SPAN></SAMP><SPAN class=Apple-converted-space>&nbsp;</SPAN>to generate the precompiled header but not when using it, you may or may not get debugging information for routines in the precompiled header.