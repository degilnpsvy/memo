<HEAD></HEAD>
<BODY>set_current_state() vs __set_current_state() </FONT></FONT></SPAN></B>
<P></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT size=3></FONT><?xml:namespace prefix = "o" ns = "urn:schemas-microsoft-com:office:office" /><o:p></o:p></SPAN></B>&nbsp;</P></FONT></FONT></FONT></SPAN>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>//our interrupt handler called.<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT face=Calibri><FONT size=5><B><SPAN lang=EN-US><FONT color=#000000>if</FONT></SPAN></B><SPAN lang=EN-US><FONT color=#000000>&nbsp;(count &amp;&amp; no_irq)<o:p></o:p></FONT></SPAN></FONT></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>{<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>&nbsp;&nbsp;&nbsp;&nbsp;parport_release (dev);<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>&nbsp;&nbsp;&nbsp;&nbsp;- current-&gt;state = TASK_INTERRUPTIBLE;<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>&nbsp;&nbsp;&nbsp;&nbsp;+ set_current_state (TASK_INTERRUPTIBLE);<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>&nbsp;&nbsp;&nbsp;&nbsp;schedule_timeout (wait);<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>&nbsp;&nbsp;&nbsp;&nbsp;parport_claim_or_block (dev);<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>}<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>/*<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>&nbsp;This is definitely _safe_ but slower.<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>&nbsp;NOTE: <FONT class=extract>set_current_state() is _always_ safe. __set_current_state() may be race prone if not used carefully in the wait_event interface.<o:p></o:p></FONT></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>&nbsp;In the sepecific above case you can safely use the faster __set_current_state() because you know the schedule will run on the same CPU that you used to set the state as TASK_INTERRUPTIBLE. You are changing the `state' field only for yourself. So you don't care what other CPUs will see as you have not to deal with other CPUs in such case.<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000><FONT face=Calibri><FONT size=5>&nbsp;The signal handling can't race as schedule is aware of signals and schedule will check if there's a signal pending after flushing the TASK_INTERRUPTIBLE state to the other CPUs and the signal path will first set the signal_pending bit, then it flush the bit to RAM and it will go to check the state of the signalled process. So the right ordering is just enforced by the scheduler and the signal code.<o:p></o:p></FONT></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT color=#000000 size=5 face=Calibri>&nbsp;*/</FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT size=5 face=Calibri></FONT></SPAN>&nbsp;</P><SPAN lang=EN-US><o:p>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT face=Calibri><FONT size=5></FONT></FONT></SPAN>&nbsp;</P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>#define __set_task_state(tsk, state_value) \<BR>do { (tsk)-&gt;state = (state_value); } while (0)<o:p></o:p></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>#define set_task_state(tsk, state_value) \<BR>set_mb((tsk)-&gt;state, (state_value))<o:p></o:p></FONT></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><SPAN lang=EN-US><FONT face=Calibri>set_task_state()</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#24102;&#26377;&#19968;&#20010;</SPAN><SPAN lang=EN-US><FONT face=Calibri>memory barrier</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#65292;</SPAN><SPAN lang=EN-US><FONT face=Calibri>__set_task_state()</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#21017;&#27809;&#26377;&#65292;&#24403;&#29366;&#24577;</SPAN><SPAN lang=EN-US><FONT face=Calibri>state</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#26159;</SPAN><SPAN lang=EN-US><FONT face=Calibri>RUNNING</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#26102;&#65292;&#22240;&#20026;</SPAN><SPAN lang=EN-US><FONT face=Calibri>scheduler</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#21487;&#33021;&#35775;&#38382;&#36825;&#20010;</SPAN><SPAN lang=EN-US><FONT face=Calibri>state</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#65292;&#22240;</SPAN><FONT face=Calibri> </FONT><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#27492;&#27492;&#26102;&#35201;&#21464;&#25104;&#20854;&#20182;&#29366;&#24577;&#65288;&#22914;</SPAN><SPAN lang=EN-US><FONT face=Calibri>INTERRUPTIBLE</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#65289;&#65292;&#23601;&#35201;&#29992;</SPAN><SPAN lang=EN-US><FONT face=Calibri>set_task_state()</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#32780;&#24403;</SPAN><SPAN lang=EN-US><FONT face=Calibri>state</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#19981;&#26159;</SPAN><SPAN lang=EN-US><FONT face=Calibri>RUNNING</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#26102;&#65292;&#22240;&#20026;&#27809;&#26377;&#20854;&#20182;&#20154;&#20250;</SPAN><FONT face=Calibri> </FONT><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#35775;&#38382;&#36825;&#20010;</SPAN><SPAN lang=EN-US><FONT face=Calibri>state</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#65292;&#22240;&#27492;&#21487;&#20197;&#29992;</SPAN><SPAN lang=EN-US><FONT face=Calibri>__set_task_state()</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#21453;&#27491;&#29992;</SPAN><SPAN lang=EN-US><FONT face=Calibri>set_task_state()</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#32943;&#23450;&#26159;&#23433;&#20840;&#30340;&#65292;&#20294;</SPAN><SPAN lang=EN-US><FONT face=Calibri> __set_task_state()</FONT></SPAN><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#21487;&#33021;&#20250;&#24555;&#20123;&#12290;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#26412;&#25991;&#26469;&#33258;</SPAN><SPAN lang=EN-US><FONT face=Calibri>CSDN</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#21338;&#23458;&#65292;&#36716;&#36733;&#35831;&#26631;&#26126;&#20986;&#22788;&#65306;</SPAN><SPAN lang=EN-US><A href="http://blog.csdn.net/lm_tom/archive/2008/05/16/2453087.aspx"><FONT color=#0000ff face=Calibri>http://blog.csdn.net/lm_tom/archive/2008/05/16/2453087.aspx</FONT></A><o:p></o:p></SPAN></B></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#19979;&#38754;&#26159;&#23545;&#20989;&#25968;</SPAN><SPAN lang=EN-US><FONT face=Calibri>set_task_state()</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#21644;&#20989;&#25968;</SPAN><SPAN lang=EN-US><FONT face=Calibri>set_current_state()</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#30340;&#35299;&#26512;&#12290;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></B></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><FONT size=5><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#20989;&#25968;</SPAN><SPAN lang=EN-US><FONT face=Calibri>Set_task_state()<o:p></o:p></FONT></SPAN></FONT></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>#define __set_task_state(tsk, state_value) \<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><B><SPAN lang=EN-US><FONT face=Calibri>do { (tsk)-&gt;state = (state_value); } while (0) //</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#36825;&#20010;&#20989;&#25968;&#26377;&#21035;&#20110;</SPAN><SPAN lang=EN-US><FONT face=Calibri>set_taskl_state(tsk,state_value),</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#22240;&#20026;&#21069;&#32773;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></B></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#27809;&#26377;&#20351;&#29992;</SPAN><SPAN lang=EN-US><FONT face=Calibri>mb()</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#36825;&#26679;&#30340;&#19968;&#20010;&#20989;&#25968;&#65292;&#32780;&#20165;&#20165;&#26159;&#35774;&#32622;&#20102;</SPAN><SPAN lang=EN-US><FONT face=Calibri>state</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#36825;&#20010;&#21464;&#37327;&#20540;&#65292;&#23545;&#20110;&#20445;&#25252;&#20869;&#23384;&#20107;&#20214;&#21457;&#29983;&#30340;&#27425;&#24207;&#26681;&#26412;&#23601;&#27809;&#26377;&#25191;&#34892;&#12290;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></B></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><FONT size=5><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#25152;&#20197;&#65292;&#21518;&#32773;&#26356;&#21152;&#20855;&#26377;&#23433;&#20840;&#24615;&#12290;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></FONT></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>#define set_task_state(tsk, state_value) \<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>set_mb((tsk)-&gt;state, (state_value))<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><FONT size=5><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#36825;&#37324;&#35201;&#28145;&#20837;&#30340;&#35299;&#37322;&#20989;&#25968;</SPAN><SPAN lang=EN-US><FONT face=Calibri>set_mb((tsk)-&gt;state,(state_value)):<o:p></o:p></FONT></SPAN></FONT></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>#define set_mb(var, value) do { var = value; mb(); } while (0)<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><B><SPAN lang=EN-US><FONT face=Calibri>#define mb() __asm__ __volatile__ ("" ::: "memory")//</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#36825;&#20010;&#20989;&#25968;&#25152;&#23454;&#29616;&#30340;&#21151;&#33021;&#23601;&#26159;</SPAN><SPAN lang=EN-US><FONT face=Calibri>barrior()</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#65292;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></B></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#21151;&#33021;&#26159;</SPAN><SPAN lang=EN-US><FONT face=Calibri>PC</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#37319;&#29992;&#20869;&#23384;&#19968;&#33268;&#24615;&#27169;&#22411;&#65292;&#20351;&#29992;</SPAN><SPAN lang=EN-US><FONT face=Calibri>mb</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#24378;&#21152;&#30340;&#20005;&#26684;&#30340;</SPAN><SPAN lang=EN-US><FONT face=Calibri>CPU</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#20869;&#23384;&#20107;&#20214;&#27425;&#24207;&#65292;&#20445;&#35777;&#31243;&#24207;&#30340;&#25191;&#34892;&#30475;&#19978;&#21435;&#23601;&#35937;&#26159;&#36981;&#24490;&#39034;&#24207;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></B></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#19968;&#33268;&#24615;&#65288;</SPAN><SPAN lang=EN-US><FONT face=Calibri>SC</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#65289;&#27169;&#22411;&#65292;&#24403;&#28982;&#65292;&#21363;&#20351;&#23545;&#20110;</SPAN><SPAN lang=EN-US><FONT face=Calibri>UP</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#65292;&#30001;&#20110;&#20869;&#23384;&#21644;&#35774;&#22791;&#35265;&#20173;&#28982;&#26377;&#19968;&#33268;&#24615;&#38382;&#39064;&#65292;&#36825;&#20123;</SPAN><SPAN lang=EN-US><FONT face=Calibri>MB</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#20063;&#26159;&#24517;&#39035;&#30340;&#12290;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></B></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><B><SPAN lang=EN-US><FONT face=Calibri>Set_current_state()</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#20989;&#25968;&#65306;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></B></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#19979;&#38754;&#26159;&#23545;</SPAN><SPAN lang=EN-US><FONT face=Calibri>set_current_state()</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#20989;&#25968;&#30340;&#19968;&#20010;&#31616;&#35201;&#30340;&#35299;&#26512;&#65306;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></B></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>/*<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>* set_current_state() includes a barrier so that the write of current-&gt;state<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>* is correctly serialised wrt the caller's subsequent test of whether to<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>* actually sleep:<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>*<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>* set_current_state(TASK_UNINTERRUPTIBLE);<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>* if (do_i_need_to_sleep())<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>* schedule();<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>*<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>* If the caller does not need such serialisation then use __set_current_state()<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>*/<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>#define __set_current_state(state_value) \<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><B><SPAN lang=EN-US><FONT face=Calibri>do { current-&gt;state = (state_value); } while (0)//</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#36825;&#20010;&#20989;&#25968;&#30340;&#20004;&#32773;&#31867;&#20284;&#20110;&#19978;&#38754;&#30340;&#20989;&#25968;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></B></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>#define set_current_state(state_value)<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><SPAN lang=EN-US><FONT face=Calibri><FONT size=5>set_mb(current-&gt;state, (state_value))<o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><FONT size=5><B><SPAN lang=EN-US><FONT face=Calibri>//</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#36825;&#20010;&#20989;&#25968;&#30340;&#21151;&#33021;&#21644;</SPAN><SPAN lang=EN-US><FONT face=Calibri>set_task_state()</FONT></SPAN></B><B><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#36825;&#19968;&#20989;&#25968;&#30340;&#21151;&#33021;&#26159;&#22522;&#26412;&#19978;&#19968;&#33268;&#30340;&#65292;&#21482;&#26159;&#20004;&#32773;&#25152;&#20316;&#29992;&#30340;&#23545;&#35937;&#30340;&#19981;&#21516;&#32780;&#24050;&#65306;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></B></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><B><FONT size=5><SPAN style="FONT-FAMILY: &#23435;&#20307;; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: &#23435;&#20307;; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin">&#27492;&#20989;&#25968;&#23545;&#24212;&#30340;&#26159;&#23545;&#25152;&#36873;&#23450;&#30340;&#36827;&#31243;&#36827;&#34892;&#35774;&#32622;&#65292;&#32780;&#21518;&#32773;&#26159;&#23545;&#24403;&#21069;&#36827;&#31243;&#36827;&#34892;&#35774;&#32622;&#12290;</SPAN><SPAN lang=EN-US><o:p></o:p></SPAN></FONT></B></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"></o:p></SPAN>&nbsp;</P></FONT></BODY>