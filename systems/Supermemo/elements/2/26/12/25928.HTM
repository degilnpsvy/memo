<H2>linux kernel&#30340;&#20013;&#26029;&#23376;&#31995;&#32479;&#20043;&#65288;&#20843;&#65289;&#65306;softirq</H2>
<P class=date>&#20316;&#32773;&#65306;<A href="http://www.wowotech.net/author/3">linuxer</A> &#21457;&#24067;&#20110;&#65306;2014-10-24 11:53 &#20998;&#31867;&#65306;<A href="http://www.wowotech.net/sort/irq_subsystem">&#20013;&#26029;&#23376;&#31995;&#32479;</A> </P>
<P>&#19968;&#12289;&#21069;&#35328; </P>
<P>&#23545;&#20110;&#20013;&#26029;&#22788;&#29702;&#32780;&#35328;&#65292;linux&#23558;&#20854;&#20998;&#25104;&#20102;&#20004;&#20010;&#37096;&#20998;&#65292;&#19968;&#20010;&#21483;&#20570;&#20013;&#26029;handler&#65288;top half&#65289;&#65292;&#26159;&#20840;&#31243;&#20851;&#38381;&#20013;&#26029;&#30340;&#65292;&#21478;&#22806;&#19968;&#37096;&#20998;&#26159;deferable task&#65288;bottom half&#65289;&#65292;&#23646;&#20110;&#19981;&#37027;&#20040;&#32039;&#24613;&#38656;&#35201;&#22788;&#29702;&#30340;&#20107;&#24773;&#12290;&#22312;&#25191;&#34892;bottom half&#30340;&#26102;&#20505;&#65292;&#26159;&#24320;&#20013;&#26029;&#30340;&#12290;&#26377;&#22810;&#31181;bottom half&#30340;&#26426;&#21046;&#65292;&#20363;&#22914;&#65306;softirq&#12289;tasklet&#12289;workqueue&#25110;&#26159;&#30452;&#25509;&#21019;&#24314;&#19968;&#20010;kernel thread&#26469;&#25191;&#34892;bottom half&#65288;&#36825;&#22312;&#26087;&#30340;kernel&#39537;&#21160;&#20013;&#24120;&#35265;&#65292;&#29616;&#22312;&#65292;&#19968;&#20010;&#29702;&#26234;&#30340;driver&#21378;&#21830;&#26159;&#19981;&#20250;&#36825;&#20040;&#20570;&#30340;&#65289;&#12290;&#26412;&#25991;&#20027;&#35201;&#35752;&#35770;softirq&#26426;&#21046;&#12290;&#30001;&#20110;tasklet&#26159;&#22522;&#20110;softirq&#30340;&#65292;&#22240;&#27492;&#26412;&#25991;&#20063;&#20250;&#25552;&#21450;tasklet&#65292;&#20294;&#20027;&#35201;&#26159;&#20174;&#38656;&#27714;&#23618;&#38754;&#32771;&#34385;&#65292;&#19981;&#20250;&#28041;&#21450;&#20854;&#20855;&#20307;&#30340;&#20195;&#30721;&#23454;&#29616;&#12290; </P>
<P>&#22312;&#26222;&#36890;&#30340;&#39537;&#21160;&#20013;&#19968;&#33324;&#26159;&#19981;&#20250;&#29992;&#21040;softirq&#65292;&#20294;&#26159;&#30001;&#20110;&#39537;&#21160;&#32463;&#24120;&#20351;&#29992;&#30340;tasklet&#26159;&#22522;&#20110;softirq&#30340;&#65292;&#22240;&#27492;&#65292;&#20102;&#35299;softirq&#26426;&#21046;&#26377;&#21161;&#20110;&#25776;&#20889;&#26356;&#20248;&#38597;&#30340;driver&#12290;softirq&#19981;&#33021;&#21160;&#24577;&#20998;&#37197;&#65292;&#37117;&#26159;&#38745;&#24577;&#23450;&#20041;&#30340;&#12290;&#20869;&#26680;&#24050;&#32463;&#23450;&#20041;&#20102;&#33509;&#24178;&#31181;softirq number&#65292;&#20363;&#22914;&#32593;&#32476;&#25968;&#25454;&#30340;&#25910;&#21457;&#12289;block&#35774;&#22791;&#30340;&#25968;&#25454;&#35775;&#38382;&#65288;&#25968;&#25454;&#37327;&#22823;&#65292;&#36890;&#20449;&#24102;&#23485;&#39640;&#65289;&#65292;timer&#30340;deferable task&#65288;&#26102;&#38388;&#26041;&#38754;&#35201;&#27714;&#39640;&#65289;&#12290;&#26412;&#25991;&#30340;&#31532;&#20108;&#31456;&#35752;&#35770;&#20102;softirq&#21644;tasklet&#36825;&#20004;&#31181;&#26426;&#21046;&#26377;&#20309;&#19981;&#21516;&#65292;&#20998;&#21035;&#36866;&#29992;&#20110;&#20160;&#20040;&#26679;&#30340;&#22330;&#26223;&#12290;&#31532;&#19977;&#31456;&#25551;&#36848;&#20102;&#19968;&#20123;context&#30340;&#27010;&#24565;&#65292;&#36825;&#26159;&#35201;&#29702;&#35299;&#21518;&#32493;&#20869;&#23481;&#30340;&#22522;&#30784;&#12290;&#31532;&#22235;&#31456;&#26159;&#36827;&#20837;softirq&#30340;&#23454;&#29616;&#65292;&#23545;&#27604;hard irq&#26469;&#35299;&#26512;soft irq&#30340;&#27880;&#20876;&#12289;&#35302;&#21457;&#65292;&#35843;&#24230;&#30340;&#36807;&#31243;&#12290; </P>
<P>&#27880;&#65306;&#26412;&#25991;&#20013;&#30340;linux kernel&#30340;&#29256;&#26412;&#26159;3.14 </P>
<P>&nbsp; </P>
<P>&#20108;&#12289;&#20026;&#20309;&#26377;softirq&#21644;tasklet </P>
<P>1&#12289;&#20026;&#20309;&#26377;top half&#21644;bottom half </P>
<P>&#20013;&#26029;&#22788;&#29702;&#27169;&#22359;&#26159;&#20219;&#20309;OS&#20013;&#26368;&#37325;&#35201;&#30340;&#19968;&#20010;&#27169;&#22359;&#65292;&#23545;&#31995;&#32479;&#30340;&#24615;&#33021;&#20250;&#26377;&#30452;&#25509;&#30340;&#24433;&#21709;&#12290;&#24819;&#20687;&#19968;&#19979;&#65306;&#22914;&#26524;&#22312;&#36890;&#36807;U&#30424;&#36827;&#34892;&#22823;&#37327;&#25968;&#25454;&#25335;&#36125;&#30340;&#26102;&#20505;&#65292;&#20320;&#25353;&#19979;&#19968;&#20010;key&#65292;&#38656;&#35201;&#21322;&#31186;&#30340;&#26102;&#38388;&#25165;&#26174;&#31034;&#20986;&#26469;&#65292;&#36825;&#20010;&#22330;&#26223;&#26159;&#21542;&#35753;&#20320;&#23849;&#28291;&#65311;&#22240;&#27492;&#65292;&#23545;&#20110;&#37027;&#20123;&#22797;&#26434;&#30340;&#12289;&#38656;&#35201;&#22823;&#37327;&#25968;&#25454;&#22788;&#29702;&#30340;&#30828;&#20214;&#20013;&#26029;&#65292;&#25105;&#20204;&#19981;&#33021;&#35753;handler&#20013;&#22788;&#29702;&#23436;&#19968;&#20999;&#20877;&#24674;&#22797;&#29616;&#22330;&#65288;handler&#26159;&#20840;&#31243;&#20851;&#38381;&#20013;&#26029;&#30340;&#65289;&#65292;&#32780;&#26159;&#20165;&#20165;&#22312;handler&#20013;&#22788;&#29702;&#19968;&#37096;&#20998;&#65292;&#20855;&#20307;&#21253;&#25324;&#65306; </P>
<P>&#65288;1&#65289;&#26377;&#23454;&#26102;&#24615;&#35201;&#27714;&#30340; </P>
<P>&#65288;2&#65289;&#21644;&#30828;&#20214;&#30456;&#20851;&#30340;&#12290;&#20363;&#22914;ack&#20013;&#26029;&#65292;read HW FIFO to ram&#31561; </P>
<P>&#65288;3&#65289;&#22914;&#26524;&#26159;&#20849;&#20139;&#20013;&#26029;&#65292;&#37027;&#20040;&#33719;&#21462;&#30828;&#20214;&#20013;&#26029;&#29366;&#24577;&#20197;&#20415;&#21028;&#26029;&#26159;&#21542;&#26159;&#26412;&#20013;&#26029;&#21457;&#29983; </P>
<P>&#38500;&#27492;&#20043;&#22806;&#65292;&#20854;&#20182;&#30340;&#20869;&#23481;&#37117;&#26159;&#25918;&#21040;bottom half&#20013;&#22788;&#29702;&#12290;&#22312;&#25226;&#20013;&#26029;&#22788;&#29702;&#36807;&#31243;&#21010;&#20998;&#25104;top half&#21644;bottom half&#20043;&#21518;&#65292;&#20851;&#20013;&#26029;&#30340;top half&#34987;&#30246;&#36523;&#65292;&#21487;&#20197;&#38750;&#24120;&#24555;&#36895;&#30340;&#25191;&#34892;&#23436;&#27605;&#65292;&#22823;&#22823;&#20943;&#23569;&#20102;&#31995;&#32479;&#20851;&#20013;&#26029;&#30340;&#26102;&#38388;&#65292;&#25552;&#39640;&#20102;&#31995;&#32479;&#30340;&#24615;&#33021;&#12290; </P>
<P>&#25105;&#20204;&#21487;&#20197;&#22522;&#20110;&#19979;&#38754;&#30340;&#31995;&#32479;&#36827;&#19968;&#27493;&#30340;&#36827;&#34892;&#35752;&#35770;&#65306; </P>
<P><A href="http://www.wowotech.net/content/uploadfile/201410/79f8acfac6f25a2aae1a173df44a86e920141024045348.gif"><IMG title=rrr style="BORDER-LEFT-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px" border=0 alt=rrr src="http://www.wowotech.net/content/uploadfile/201410/3493c1557a15f648877c755ee850171c20141024045350.gif" width=458 height=460></A> </P>
<P>&#24403;&#32593;&#21345;&#25511;&#21046;&#22120;&#30340;FIFO&#25910;&#21040;&#30340;&#26469;&#33258;&#20197;&#22826;&#32593;&#30340;&#25968;&#25454;&#30340;&#26102;&#20505;&#65288;&#20363;&#22914;&#21322;&#28385;&#30340;&#26102;&#20505;&#65292;&#21487;&#20197;&#36719;&#20214;&#35774;&#23450;&#65289;&#65292;&#21487;&#20197;&#23558;&#35813;&#20107;&#20214;&#36890;&#36807;irq signal&#36865;&#36798;Interrupt Controller&#12290;Interrupt Controller&#21487;&#20197;&#25226;&#20013;&#26029;&#20998;&#21457;&#32473;&#31995;&#32479;&#20013;&#30340;Processor A or B&#12290; </P>
<P>NIC&#30340;&#20013;&#26029;&#22788;&#29702;&#36807;&#31243;&#22823;&#27010;&#21253;&#25324;&#65306;mask and ack interrupt controller--------&gt;ack NIC--------&gt;copy FIFO to ram------&gt;handle Data in the ram-----------&gt;unmask interrupt controller </P>
<P>&#25105;&#20204;&#20808;&#20551;&#35774;Processor A&#22788;&#29702;&#20102;&#36825;&#20010;&#32593;&#21345;&#20013;&#26029;&#20107;&#20214;&#65292;&#20110;&#26159;NIC&#30340;&#20013;&#26029;handler&#22312;Processor A&#19978;&#27426;&#24555;&#30340;&#25191;&#34892;&#65292;&#36825;&#26102;&#20505;&#65292;Processor A&#30340;&#26412;&#22320;&#20013;&#26029;&#26159;disable&#30340;&#12290;NIC&#30340;&#20013;&#26029;handler&#22312;&#25191;&#34892;&#30340;&#36807;&#31243;&#20013;&#65292;&#32593;&#32476;&#25968;&#25454;&#20173;&#28982;&#28304;&#28304;&#19981;&#26029;&#30340;&#21040;&#26469;&#65292;&#20294;&#26159;&#65292;&#22914;&#26524;NIC&#30340;&#20013;&#26029;handler&#19981;&#25805;&#20316;NIC&#30340;&#23492;&#23384;&#22120;&#26469;ack&#36825;&#20010;&#20013;&#26029;&#30340;&#35805;&#65292;NIC&#26159;&#19981;&#20250;&#35302;&#21457;&#19979;&#19968;&#27425;&#20013;&#26029;&#30340;&#12290;&#36824;&#22909;&#65292;&#25105;&#20204;&#30340;NIC interrupt handler&#24635;&#26159;&#22312;&#26368;&#24320;&#22987;&#23601;&#20250;ack&#65292;&#22240;&#27492;&#65292;&#36825;&#19981;&#20250;&#23548;&#33268;&#24615;&#33021;&#38382;&#39064;&#12290;ack&#20043;&#21518;&#65292;NIC&#24050;&#32463;&#20855;&#20307;&#20877;&#27425;trigger&#20013;&#26029;&#30340;&#33021;&#21147;&#12290;&#24403;Processor A&#19978;&#30340;handler &#22312;&#22788;&#29702;&#25509;&#25910;&#26469;&#33258;&#32593;&#32476;&#30340;&#25968;&#25454;&#30340;&#26102;&#20505;&#65292;NIC&#30340;FIFO&#24456;&#21487;&#33021;&#21448;&#25910;&#21040;&#26032;&#30340;&#25968;&#25454;&#65292;&#24182;trigger&#20102;&#20013;&#26029;&#65292;&#36825;&#26102;&#20505;&#65292;Interrupt controller&#36824;&#27809;&#26377;umask&#65292;&#22240;&#27492;&#65292;&#21363;&#20415;&#36824;&#26377;Processor B&#65288;&#20063;&#23601;&#26159;&#35828;&#26377;&#22788;&#29702;&#22120;&#36164;&#28304;&#65289;&#65292;&#20013;&#26029;&#25511;&#21046;&#22120;&#20063;&#26080;&#27861;&#25226;&#36825;&#20010;&#20013;&#26029;&#36865;&#36798;&#22788;&#29702;&#22120;&#31995;&#32479;&#12290;&#22240;&#27492;&#65292;&#21482;&#33021;&#30524;&#30529;&#30529;&#30340;&#30475;&#30528;NIC FIFO&#22635;&#28385;&#25968;&#25454;&#65292;&#25968;&#25454;&#28322;&#20986;&#65292;&#25110;&#32773;&#21521;&#23545;&#31471;&#21457;&#20986;&#25317;&#22622;&#20449;&#21495;&#65292;&#26080;&#35770;&#22914;&#20309;&#65292;&#25972;&#20307;&#30340;&#31995;&#32479;&#24615;&#33021;&#26159;&#21463;&#21040;&#20005;&#37325;&#30340;&#24433;&#21709;&#12290; </P>
<P>&#27880;&#24847;&#65306;&#23545;&#20110;&#26032;&#30340;interrupt controller&#65292;&#21487;&#33021;&#27809;&#26377;mask&#21644;umask&#25805;&#20316;&#65292;&#20294;&#26159;&#21407;&#29702;&#26159;&#19968;&#26679;&#30340;&#65292;&#21482;&#19981;&#36807;NIC&#30340;handler&#25191;&#34892;&#23436;&#27605;&#35201;&#21457;&#29983;EOI&#32780;&#24050;&#12290; </P>
<P>&#35201;&#35299;&#20915;&#19978;&#38754;&#30340;&#38382;&#39064;&#65292;&#26368;&#37325;&#35201;&#30340;&#26159;&#23613;&#24555;&#30340;&#25191;&#34892;&#23436;&#20013;&#26029;handler&#65292;&#25171;&#24320;&#20013;&#26029;&#65292;unmask IRQ&#65288;&#25110;&#32773;&#21457;&#36865;EOI&#65289;&#65292;&#26041;&#27861;&#23601;&#26159;&#25226;&#32791;&#26102;&#30340;handle Data in the ram&#36825;&#20010;&#27493;&#39588;&#36386;&#20986;handler&#65292;&#35753;&#20854;&#22312;bottom half&#20013;&#25191;&#34892;&#12290; </P>
<P>&nbsp; </P>
<P>2&#12289;&#20026;&#20309;&#26377;softirq&#21644;tasklet </P>
<P>OK&#65292;linux kernel&#24050;&#32463;&#25226;&#20013;&#26029;&#22788;&#29702;&#20998;&#25104;&#20102;top half&#21644;bottom half&#65292;&#30475;&#36215;&#26469;&#24050;&#32463;&#19981;&#38169;&#20102;&#65292;&#37027;&#20026;&#20309;&#36824;&#35201;&#25552;&#20379;softirq&#12289;tasklet&#21644;workqueue&#36825;&#20123;bottom half&#26426;&#21046;&#65292;linux kernel&#26412;&#26469;&#23601;&#22815;&#22797;&#26434;&#20102;&#65292;bottom half&#36824;&#26469;&#28155;&#20081;&#12290;&#23454;&#38469;&#19978;&#65292;&#22312;&#26089;&#26399;&#30340;linux kernel&#36824;&#30495;&#26159;&#21482;&#26377;&#19968;&#20010;bottom half&#26426;&#21046;&#65292;&#31616;&#31216;BH&#65292;&#31616;&#21333;&#22909;&#29992;&#65292;&#20294;&#26159;&#24615;&#33021;&#19981;&#20339;&#12290;&#21518;&#26469;&#65292;linux kernel&#30340;&#24320;&#21457;&#32773;&#24320;&#21457;&#20102;task queue&#26426;&#21046;&#65292;&#35797;&#22270;&#26469;&#26367;&#20195;BH&#65292;&#24403;&#28982;&#65292;&#26368;&#21518;task queue&#20063;&#28040;&#22833;&#22312;&#20869;&#26680;&#20195;&#30721;&#20013;&#20102;&#12290;&#29616;&#22312;&#30340;linux kernel&#25552;&#20379;&#20102;&#19977;&#31181;bottom half&#30340;&#26426;&#21046;&#65292;&#26469;&#24212;&#23545;&#19981;&#21516;&#30340;&#38656;&#27714;&#12290; </P>
<P>workqueue&#21644;softirq&#12289;tasklet&#26377;&#26412;&#36136;&#30340;&#21306;&#21035;&#65306;workqueue&#36816;&#34892;&#22312;process context&#65292;&#32780;softirq&#21644;tasklet&#36816;&#34892;&#22312;interrupt context&#12290;&#22240;&#27492;&#65292;&#20986;&#29616;workqueue&#26159;&#19981;&#22855;&#24618;&#30340;&#65292;&#22312;&#26377;sleep&#38656;&#27714;&#30340;&#22330;&#26223;&#20013;&#65292;defering task&#24517;&#39035;&#24310;&#36831;&#21040;kernel thread&#20013;&#25191;&#34892;&#65292;&#20063;&#23601;&#26159;&#35828;&#24517;&#39035;&#20351;&#29992;workqueue&#26426;&#21046;&#12290;softirq&#21644;tasklet&#26159;&#24590;&#20040;&#22238;&#20107;&#21602;&#65311;&#20174;&#26412;&#36136;&#19978;&#23558;&#65292;bottom half&#26426;&#21046;&#30340;&#35774;&#35745;&#26377;&#20004;&#26041;&#38754;&#30340;&#38656;&#27714;&#65292;&#19968;&#20010;&#26159;&#24615;&#33021;&#65292;&#19968;&#20010;&#26159;&#26131;&#29992;&#24615;&#12290;&#35774;&#35745;&#19968;&#20010;&#36890;&#29992;&#30340;bottom half&#26426;&#21046;&#26469;&#28385;&#36275;&#36825;&#20004;&#20010;&#38656;&#27714;&#38750;&#24120;&#30340;&#22256;&#38590;&#65292;&#22240;&#27492;&#65292;&#20869;&#26680;&#25552;&#20379;&#20102;softirq&#21644;tasklet&#20004;&#31181;&#26426;&#21046;&#12290;softirq&#26356;&#20542;&#21521;&#20110;&#24615;&#33021;&#65292;&#32780;tasklet&#26356;&#20542;&#21521;&#20110;&#26131;&#29992;&#24615;&#12290; </P>
<P>&#25105;&#20204;&#36824;&#26159;&#36827;&#20837;&#23454;&#38469;&#30340;&#20363;&#23376;&#21543;&#65292;&#36824;&#26159;&#20351;&#29992;&#19978;&#19968;&#33410;&#30340;&#31995;&#32479;&#22270;&#12290;&#22312;&#24341;&#20837;softirq&#20043;&#21518;&#65292;&#32593;&#32476;&#25968;&#25454;&#30340;&#22788;&#29702;&#22914;&#19979;&#65306; </P>
<P>&#20851;&#20013;&#26029;&#65306;mask and ack interrupt controller--------&gt;ack NIC--------&gt;copy FIFO to ram------&gt;raise softirq------&gt;unmask interrupt controller </P>
<P>&#24320;&#20013;&#26029;&#65306;&#22312;softirq&#19978;&#19979;&#25991;&#20013;&#36827;&#34892;handle Data in the ram&#30340;&#21160;&#20316; </P>
<P>&#21516;&#26679;&#30340;&#65292;&#25105;&#20204;&#20808;&#20551;&#35774;Processor A&#22788;&#29702;&#20102;&#36825;&#20010;&#32593;&#21345;&#20013;&#26029;&#20107;&#20214;&#65292;&#24456;&#24555;&#30340;&#23436;&#25104;&#20102;&#22522;&#26412;&#30340;HW&#25805;&#20316;&#21518;&#65292;raise softirq&#12290;&#22312;&#36820;&#22238;&#20013;&#26029;&#29616;&#22330;&#21069;&#65292;&#20250;&#26816;&#26597;softirq&#30340;&#35302;&#21457;&#24773;&#20917;&#65292;&#22240;&#27492;&#65292;&#21518;&#32493;&#32593;&#32476;&#25968;&#25454;&#22788;&#29702;&#30340;softirq&#22312;processor A&#19978;&#25191;&#34892;&#12290;&#22312;&#25191;&#34892;&#36807;&#31243;&#20013;&#65292;NIC&#30828;&#20214;&#20877;&#27425;&#35302;&#21457;&#20013;&#26029;&#65292;Interrupt controller&#23558;&#35813;&#20013;&#26029;&#20998;&#21457;&#32473;processor B&#65292;&#25191;&#34892;&#21160;&#20316;&#21644;Processor A&#26159;&#31867;&#20284;&#30340;&#65292;&#22240;&#27492;&#65292;&#26368;&#21518;&#65292;&#32593;&#32476;&#25968;&#25454;&#22788;&#29702;&#30340;softirq&#22312;processor B&#19978;&#25191;&#34892;&#12290; </P>
<P>&#20026;&#20102;&#24615;&#33021;&#65292;&#21516;&#19968;&#31867;&#22411;&#30340;softirq&#26377;&#21487;&#33021;&#22312;&#19981;&#21516;&#30340;CPU&#19978;&#24182;&#21457;&#25191;&#34892;&#65292;&#36825;&#32473;&#20351;&#29992;&#32773;&#24102;&#26469;&#20102;&#26497;&#22823;&#30340;&#30171;&#33510;&#65292;&#22240;&#20026;&#39537;&#21160;&#24037;&#31243;&#24072;&#22312;&#25776;&#20889;softirq&#30340;&#22238;&#35843;&#20989;&#25968;&#30340;&#26102;&#20505;&#35201;&#32771;&#34385;&#37325;&#20837;&#65292;&#32771;&#34385;&#24182;&#21457;&#65292;&#35201;&#24341;&#20837;&#21516;&#27493;&#26426;&#21046;&#12290;&#20294;&#26159;&#65292;&#20026;&#20102;&#24615;&#33021;&#65292;&#25105;&#20204;&#24517;&#39035;&#22914;&#27492;&#12290; </P>
<P>&#24403;&#32593;&#32476;&#25968;&#25454;&#22788;&#29702;&#30340;softirq&#21516;&#26102;&#22312;Processor A&#21644;B&#19978;&#36816;&#34892;&#30340;&#26102;&#20505;&#65292;&#32593;&#21345;&#20013;&#26029;&#21448;&#26469;&#20102;&#65288;&#21487;&#33021;&#26159;10G&#30340;&#32593;&#21345;&#21543;&#65289;&#12290;&#36825;&#26102;&#20505;&#65292;&#20013;&#26029;&#20998;&#21457;&#32473;processor A&#65292;&#36825;&#26102;&#20505;&#65292;processor A&#19978;&#30340;handler&#20173;&#28982;&#20250;raise softirq&#65292;&#20294;&#26159;&#24182;&#19981;&#20250;&#35843;&#24230;&#35813;softirq&#12290;&#20063;&#23601;&#26159;&#35828;&#65292;softirq&#22312;&#19968;&#20010;CPU&#19978;&#26159;&#20018;&#34892;&#25191;&#34892;&#30340;&#12290;&#36825;&#31181;&#24773;&#20917;&#19979;&#65292;&#31995;&#32479;&#24615;&#33021;&#29942;&#39048;&#26159;CPU&#36164;&#28304;&#65292;&#38656;&#35201;&#22686;&#21152;&#26356;&#22810;&#30340;CPU&#26469;&#35299;&#20915;&#35813;&#38382;&#39064;&#12290; </P>
<P>&#22914;&#26524;&#26159;tasklet&#30340;&#24773;&#20917;&#20250;&#22914;&#20309;&#21602;&#65311;&#20026;&#20309;tasklet&#24615;&#33021;&#19981;&#22914;softirq&#21602;&#65311;&#22914;&#26524;&#19968;&#20010;tasklet&#22312;processor A&#19978;&#34987;&#35843;&#24230;&#25191;&#34892;&#65292;&#37027;&#20040;&#23427;&#27704;&#36828;&#20063;&#19981;&#20250;&#21516;&#26102;&#22312;processor B&#19978;&#25191;&#34892;&#65292;&#20063;&#23601;&#26159;&#35828;&#65292;tasklet&#26159;&#20018;&#34892;&#25191;&#34892;&#30340;&#65288;&#27880;&#65306;&#19981;&#21516;&#30340;tasklet&#36824;&#26159;&#20250;&#24182;&#21457;&#30340;&#65289;&#65292;&#19981;&#38656;&#35201;&#32771;&#34385;&#37325;&#20837;&#30340;&#38382;&#39064;&#12290;&#25105;&#20204;&#36824;&#26159;&#29992;&#32593;&#21345;&#36825;&#20010;&#20363;&#23376;&#21543;&#65288;&#27880;&#24847;&#65306;&#36825;&#20010;&#20363;&#23376;&#20165;&#20165;&#26159;&#29992;&#26469;&#23545;&#27604;&#65292;&#23454;&#38469;&#19978;&#65292;&#32593;&#32476;&#25968;&#25454;&#26159;&#20351;&#29992;softirq&#26426;&#21046;&#30340;&#65289;&#65292;&#21516;&#26679;&#26159;&#19978;&#38754;&#30340;&#31995;&#32479;&#32467;&#26500;&#22270;&#12290;&#20551;&#35774;&#20351;&#29992;tasklet&#65292;&#32593;&#32476;&#25968;&#25454;&#30340;&#22788;&#29702;&#22914;&#19979;&#65306; </P>
<P>&#20851;&#20013;&#26029;&#65306;mask and ack interrupt controller--------&gt;ack NIC--------&gt;copy FIFO to ram------&gt;schedule tasklet------&gt;unmask interrupt controller </P>
<P>&#24320;&#20013;&#26029;&#65306;&#22312;softirq&#19978;&#19979;&#25991;&#20013;&#65288;&#19968;&#33324;&#20351;&#29992;TASKLET_SOFTIRQ&#36825;&#20010;softirq&#65289;&#36827;&#34892;handle Data in the ram&#30340;&#21160;&#20316; </P>
<P>&#21516;&#26679;&#30340;&#65292;&#25105;&#20204;&#20808;&#20551;&#35774;Processor A&#22788;&#29702;&#20102;&#36825;&#20010;&#32593;&#21345;&#20013;&#26029;&#20107;&#20214;&#65292;&#24456;&#24555;&#30340;&#23436;&#25104;&#20102;&#22522;&#26412;&#30340;HW&#25805;&#20316;&#21518;&#65292;schedule tasklet&#65288;&#21516;&#26102;&#20063;&#23601;raise TASKLET_SOFTIRQ softirq&#65289;&#12290;&#22312;&#36820;&#22238;&#20013;&#26029;&#29616;&#22330;&#21069;&#65292;&#20250;&#26816;&#26597;softirq&#30340;&#35302;&#21457;&#24773;&#20917;&#65292;&#22240;&#27492;&#65292;&#22312;TASKLET_SOFTIRQ softirq&#30340;handler&#20013;&#65292;&#33719;&#21462;tasklet&#30456;&#20851;&#20449;&#24687;&#24182;&#22312;processor A&#19978;&#25191;&#34892;&#35813;tasklet&#30340;handler&#12290;&#22312;&#25191;&#34892;&#36807;&#31243;&#20013;&#65292;NIC&#30828;&#20214;&#20877;&#27425;&#35302;&#21457;&#20013;&#26029;&#65292;Interrupt controller&#23558;&#35813;&#20013;&#26029;&#20998;&#21457;&#32473;processor B&#65292;&#25191;&#34892;&#21160;&#20316;&#21644;Processor A&#26159;&#31867;&#20284;&#30340;&#65292;&#34429;&#28982;TASKLET_SOFTIRQ softirq&#22312;processor B&#19978;&#21487;&#20197;&#25191;&#34892;&#65292;&#20294;&#26159;&#65292;&#22312;&#26816;&#26597;tasklet&#30340;&#29366;&#24577;&#30340;&#26102;&#20505;&#65292;&#22914;&#26524;&#21457;&#29616;&#35813;tasklet&#22312;&#20854;&#20182;processor&#19978;&#24050;&#32463;&#27491;&#22312;&#36816;&#34892;&#65292;&#37027;&#20040;&#35813;tasklet&#19981;&#20250;&#34987;&#22788;&#29702;&#65292;&#19968;&#30452;&#31561;&#21040;&#22312;processor A&#19978;&#30340;tasklet&#22788;&#29702;&#23436;&#65292;&#22312;processor B&#19978;&#30340;&#36825;&#20010;tasklet&#25165;&#33021;&#34987;&#25191;&#34892;&#12290;&#36825;&#26679;&#30340;&#20018;&#34892;&#21270;&#25805;&#20316;&#34429;&#28982;&#23545;&#39537;&#21160;&#24037;&#31243;&#24072;&#26159;&#19968;&#20010;&#31119;&#21033;&#65292;&#20294;&#26159;&#23545;&#24615;&#33021;&#32780;&#35328;&#26159;&#26497;&#22823;&#30340;&#25439;&#20260;&#12290; </P>
<P>&nbsp; </P>
<P>&#19977;&#12289;&#29702;&#35299;softirq&#38656;&#35201;&#30340;&#22522;&#30784;&#30693;&#35782;&#65288;&#21508;&#31181;context&#65289; </P>
<P>1&#12289;preempt_count </P>
<P>&#20026;&#20102;&#26356;&#22909;&#30340;&#29702;&#35299;&#19979;&#38754;&#30340;&#20869;&#23481;&#65292;&#25105;&#20204;&#38656;&#35201;&#20808;&#30475;&#30475;&#19968;&#20123;&#22522;&#30784;&#30693;&#35782;&#65306;&#19968;&#20010;task&#30340;thread info&#25968;&#25454;&#32467;&#26500;&#23450;&#20041;&#22914;&#19979;&#65288;&#21482;&#20445;&#30041;&#21644;&#26412;&#22330;&#26223;&#30456;&#20851;&#30340;&#20869;&#23481;&#65289;&#65306; </P>
<BLOCKQUOTE>
<P>struct thread_info {&nbsp; <BR>&nbsp;&nbsp;&nbsp; &#8230;&#8230; <BR>&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; preempt_count;&nbsp;&nbsp;&nbsp; /* 0 =&gt; preemptable, &lt;0 =&gt; bug */ <BR>&nbsp;&nbsp;&nbsp; &#8230;&#8230; <BR>}; </P></BLOCKQUOTE>
<P>preempt_count&#36825;&#20010;&#25104;&#21592;&#34987;&#29992;&#26469;&#21028;&#26029;&#24403;&#21069;&#36827;&#31243;&#26159;&#21542;&#21487;&#20197;&#34987;&#25250;&#21344;&#12290;&#22914;&#26524;preempt_count&#19981;&#31561;&#20110;0&#65288;&#21487;&#33021;&#26159;&#20195;&#30721;&#35843;&#29992;preempt_disable&#26174;&#24335;&#30340;&#31105;&#27490;&#20102;&#25250;&#21344;&#65292;&#20063;&#21487;&#33021;&#26159;&#22788;&#20110;&#20013;&#26029;&#19978;&#19979;&#25991;&#31561;&#65289;&#65292;&#35828;&#26126;&#24403;&#21069;&#19981;&#33021;&#36827;&#34892;&#25250;&#21344;&#65292;&#22914;&#26524;preempt_count&#31561;&#20110;0&#65292;&#35828;&#26126;&#24050;&#32463;&#20855;&#22791;&#20102;&#25250;&#21344;&#30340;&#26465;&#20214;&#65288;&#24403;&#28982;&#20855;&#20307;&#26159;&#21542;&#35201;&#25250;&#21344;&#24403;&#21069;&#36827;&#31243;&#36824;&#26159;&#35201;&#30475;&#30475;thread info&#20013;&#30340;flag&#25104;&#21592;&#26159;&#21542;&#35774;&#23450;&#20102;_TIF_NEED_RESCHED&#36825;&#20010;&#26631;&#35760;&#65292;&#21487;&#33021;&#26159;&#24403;&#21069;&#30340;&#36827;&#31243;&#30340;&#26102;&#38388;&#29255;&#29992;&#23436;&#20102;&#65292;&#20063;&#21487;&#33021;&#26159;&#30001;&#20110;&#20013;&#26029;&#21796;&#37266;&#20102;&#20248;&#20808;&#32423;&#26356;&#39640;&#30340;&#36827;&#31243;&#65289;&#12290; &#20855;&#20307;preempt_count&#30340;&#25968;&#25454;&#26684;&#24335;&#21487;&#20197;&#21442;&#32771;&#19979;&#22270;&#65306; </P>
<P><A href="http://www.wowotech.net/content/uploadfile/201410/24f930c7abd97222c253d42fcc7719af20141024045351.gif"><IMG title=preempt-count style="BORDER-LEFT-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px" border=0 alt=preempt-count src="http://www.wowotech.net/content/uploadfile/201410/0b84fe0c3c69d47f3c834224e27ad3ab20141024045352.gif" width=704 height=133></A> </P>
<P>preemption count&#29992;&#26469;&#35760;&#24405;&#24403;&#21069;&#34987;&#26174;&#24335;&#30340;&#31105;&#27490;&#25250;&#21344;&#30340;&#27425;&#25968;&#65292;&#20063;&#23601;&#26159;&#35828;&#65292;&#27599;&#35843;&#29992;&#19968;&#27425;preempt_disable&#65292;preemption count&#23601;&#20250;&#21152;&#19968;&#65292;&#35843;&#29992;preempt_enable&#65292;&#35813;&#21306;&#22495;&#30340;&#25968;&#20540;&#20250;&#20943;&#21435;&#19968;&#12290;preempt_disable&#21644;preempt_enable&#24517;&#39035;&#25104;&#23545;&#20986;&#29616;&#65292;&#21487;&#20197;&#23884;&#22871;&#65292;&#26368;&#22823;&#23884;&#22871;&#30340;&#28145;&#24230;&#26159;255&#12290; </P>
<P>hardirq count&#25551;&#36848;&#24403;&#21069;&#20013;&#26029;handler&#23884;&#22871;&#30340;&#28145;&#24230;&#12290;&#23545;&#20110;ARM&#24179;&#21488;&#30340;linux kernel&#65292;&#20854;&#20013;&#26029;&#37096;&#20998;&#30340;&#20195;&#30721;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>void handle_IRQ(unsigned int irq, struct pt_regs *regs) <BR>{ <BR>&nbsp;&nbsp;&nbsp; struct pt_regs *old_regs = set_irq_regs(regs); </P>
<P>&nbsp;&nbsp;&nbsp; irq_enter();&nbsp; <BR>&nbsp;&nbsp;&nbsp; generic_handle_irq(irq); </P>
<P>&nbsp;&nbsp;&nbsp; irq_exit(); <BR>&nbsp;&nbsp;&nbsp; set_irq_regs(old_regs); <BR>} </P></BLOCKQUOTE>
<P>&#36890;&#29992;&#30340;IRQ handler&#34987;irq_enter&#21644;irq_exit&#36825;&#20004;&#20010;&#20989;&#25968;&#21253;&#22260;&#12290;irq_enter&#35828;&#26126;&#36827;&#20837;&#21040;IRQ context&#65292;&#32780;irq_exit&#21017;&#35828;&#26126;&#36864;&#20986;IRQ context&#12290;&#22312;irq_enter&#20989;&#25968;&#20013;&#20250;&#35843;&#29992;preempt_count_add(HARDIRQ_OFFSET)&#65292;&#20026;hardirq count&#30340;bit field&#22686;&#21152;1&#12290;&#22312;irq_exit&#20989;&#25968;&#20013;&#65292;&#20250;&#35843;&#29992;preempt_count_sub(HARDIRQ_OFFSET)&#65292;&#20026;hardirq count&#30340;bit field&#20943;&#21435;1&#12290;hardirq count&#21344;&#29992;&#20102;4&#20010;bit&#65292;&#35828;&#26126;&#30828;&#20214;&#20013;&#26029;handler&#26368;&#22823;&#21487;&#20197;&#23884;&#22871;15&#23618;&#12290;&#22312;&#26087;&#30340;&#20869;&#26680;&#20013;&#65292;hardirq count&#21344;&#29992;&#20102;12&#20010;bit&#65292;&#25903;&#25345;4096&#20010;&#23884;&#22871;&#12290;&#24403;&#28982;&#65292;&#22312;&#26087;&#30340;kernel&#20013;&#36824;&#21306;&#20998;fast interrupt handler&#21644;slow interrupt handler&#65292;&#20013;&#26029;handler&#26368;&#22823;&#21487;&#20197;&#23884;&#22871;&#30340;&#27425;&#25968;&#29702;&#35770;&#19978;&#31561;&#20110;&#31995;&#32479;IRQ&#30340;&#20010;&#25968;&#12290;&#22312;&#23454;&#38469;&#20013;&#65292;&#36825;&#20010;&#25968;&#30446;&#19981;&#21487;&#33021;&#37027;&#20040;&#22823;&#65288;&#20869;&#26680;&#26632;&#23601;&#21463;&#19981;&#20102;&#65289;&#65292;&#22240;&#27492;&#65292;&#21363;&#20351;&#31995;&#32479;&#25903;&#25345;&#20102;&#38750;&#24120;&#22823;&#30340;&#20013;&#26029;&#20010;&#25968;&#65292;&#20063;&#19981;&#21487;&#33021;&#21508;&#20010;&#20013;&#26029;&#20381;&#27425;&#23884;&#22871;&#65292;&#36798;&#21040;&#29702;&#35770;&#30340;&#19978;&#38480;&#12290;&#22522;&#20110;&#36825;&#26679;&#30340;&#32771;&#34385;&#65292;&#21518;&#26469;&#20869;&#26680;&#20943;&#23569;&#20102;hardirq count&#21344;&#29992;bit&#25968;&#30446;&#65292;&#25913;&#25104;&#20102;10&#20010;bit&#65288;&#22312;general arch&#30340;&#20195;&#30721;&#20013;&#20462;&#25913;&#20026;10&#65292;&#23454;&#38469;&#19978;&#65292;&#21508;&#20010;arch&#21487;&#20197;redefine&#33258;&#24049;&#30340;hardirq count&#30340;bit&#25968;&#65289;&#12290;&#20294;&#26159;&#65292;&#24403;&#20869;&#26680;&#22823;&#20332;&#20204;&#20915;&#23450;&#24223;&#24323;slow interrupt handler&#30340;&#26102;&#20505;&#65292;&#23454;&#38469;&#19978;&#65292;&#20013;&#26029;&#30340;&#23884;&#22871;&#24050;&#32463;&#19981;&#20250;&#21457;&#29983;&#20102;&#12290;&#22240;&#27492;&#65292;&#29702;&#35770;&#19978;&#65292;hardirq count&#35201;&#20040;&#26159;0&#65292;&#35201;&#20040;&#26159;1&#12290;&#19981;&#36807;&#21602;&#65292;&#19981;&#33021;&#24635;&#25343;&#29702;&#35770;&#35828;&#20107;&#65292;&#23454;&#38469;&#19978;&#65292;&#19975;&#19968;&#26377;&#20889;&#22855;&#33897;&#25110;&#32773;&#32769;&#21476;&#33891;driver&#22312;handler&#20013;&#25171;&#24320;&#20013;&#26029;&#65292;&#37027;&#20040;&#36825;&#26102;&#20505;&#20013;&#26029;&#23884;&#22871;&#36824;&#26159;&#20250;&#21457;&#29983;&#30340;&#65292;&#20294;&#26159;&#65292;&#24212;&#35813;&#19981;&#20250;&#22826;&#22810;&#65288;&#19968;&#20010;&#31995;&#32479;&#20013;&#24590;&#20040;&#21487;&#33021;&#26377;&#37027;&#20040;&#22810;&#22855;&#33897;&#21602;&#65311;&#21621;&#21621;&#65289;&#65292;&#22240;&#27492;&#65292;&#30446;&#21069;hardirq count&#21344;&#29992;&#20102;4&#20010;bit&#65292;&#24212;&#20184;15&#20010;&#22855;&#33897;driver&#26159;&#22949;&#22949;&#30340;&#12290; </P>
<P>&#23545;softirq count&#36827;&#34892;&#25805;&#20316;&#26377;&#20004;&#20010;&#22330;&#26223;&#65306; </P>
<P>&#65288;1&#65289;&#20063;&#26159;&#22312;&#36827;&#20837;soft irq handler&#20043;&#21069;&#32473; softirq count&#21152;&#19968;&#65292;&#36864;&#20986;soft irq handler&#20043;&#21518;&#32473; softirq count&#20943;&#21435;&#19968;&#12290;&#30001;&#20110;soft irq handler&#22312;&#19968;&#20010;CPU&#19978;&#26159;&#19981;&#20250;&#24182;&#21457;&#30340;&#65292;&#24635;&#26159;&#20018;&#34892;&#25191;&#34892;&#65292;&#22240;&#27492;&#65292;&#36825;&#20010;&#22330;&#26223;&#19979;&#21482;&#38656;&#35201;&#19968;&#20010;bit&#23601;&#22815;&#20102;&#65292;&#20063;&#23601;&#26159;&#19978;&#22270;&#20013;&#30340;bit 8&#12290;&#36890;&#36807;&#35813;bit&#21487;&#20197;&#30693;&#36947;&#24403;&#21069;task&#26159;&#21542;&#22312;sofirq context&#12290; </P>
<P>&#65288;2&#65289;&#30001;&#20110;&#20869;&#26680;&#21516;&#27493;&#30340;&#38656;&#27714;&#65292;&#36827;&#31243;&#19978;&#19979;&#25991;&#38656;&#35201;&#31105;&#27490;softirq&#12290;&#36825;&#26102;&#20505;&#65292;kernel&#25552;&#20379;&#20102;local_bf_enable&#21644;local_bf_disable&#36825;&#26679;&#30340;&#25509;&#21475;&#20989;&#25968;&#12290;&#36825;&#37096;&#20998;&#30340;&#27010;&#24565;&#26159;&#21644;preempt disable/enable&#31867;&#20284;&#30340;&#65292;&#21344;&#29992;&#20102;bit9&#65374;15&#65292;&#26368;&#22823;&#21487;&#20197;&#25903;&#25345;127&#27425;&#23884;&#22871;&#12290; </P>
<P>&nbsp; </P>
<P>2&#12289;&#19968;&#20010;task&#30340;&#21508;&#31181;&#19978;&#19979;&#25991; </P>
<P>&#30475;&#23436;&#20102;preempt_count&#20043;&#21518;&#65292;&#25105;&#20204;&#26469;&#20171;&#32461;&#21508;&#31181;context&#65306; </P>
<BLOCKQUOTE>
<P>#define in_irq()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (hardirq_count()) <BR>#define in_softirq()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (softirq_count()) <BR>#define in_interrupt()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (irq_count()) </P>
<P>#define in_serving_softirq()&nbsp;&nbsp;&nbsp; (softirq_count() &amp; SOFTIRQ_OFFSET) </P></BLOCKQUOTE>
<P>&#36825;&#37324;&#39318;&#20808;&#35201;&#20171;&#32461;&#30340;&#26159;&#19968;&#20010;&#21483;&#20570;IRQ context&#30340;&#26415;&#35821;&#12290;&#36825;&#37324;&#30340;IRQ context&#20854;&#23454;&#23601;&#26159;hard irq context&#65292;&#20063;&#23601;&#26159;&#35828;&#26126;&#24403;&#21069;&#27491;&#22312;&#25191;&#34892;&#20013;&#26029;handler&#65288;top half&#65289;&#65292;&#21482;&#35201;preempt_count&#20013;&#30340;hardirq count&#22823;&#20110;0&#65288;&#65309;1&#26159;&#27809;&#26377;&#20013;&#26029;&#23884;&#22871;&#65292;&#22914;&#26524;&#22823;&#20110;1&#65292;&#35828;&#26126;&#26377;&#20013;&#26029;&#23884;&#22871;&#65289;&#65292;&#37027;&#20040;&#23601;&#26159;IRQ context&#12290; </P>
<P>softirq context&#24182;&#27809;&#26377;&#37027;&#20040;&#30340;&#30452;&#25509;&#65292;&#19968;&#33324;&#20154;&#20250;&#35748;&#20026;&#24403;sofirq handler&#27491;&#22312;&#25191;&#34892;&#30340;&#26102;&#20505;&#23601;&#26159;softirq context&#12290;&#36825;&#26679;&#35828;&#24403;&#28982;&#27809;&#26377;&#38169;&#65292;sofirq handler&#27491;&#22312;&#25191;&#34892;&#30340;&#26102;&#20505;&#65292;&#20250;&#22686;&#21152;softirq count&#65292;&#24403;&#28982;&#26159;softirq context&#12290;&#19981;&#36807;&#65292;&#22312;&#20854;&#20182;context&#30340;&#24773;&#20917;&#19979;&#65292;&#20363;&#22914;&#36827;&#31243;&#19978;&#19979;&#25991;&#20013;&#65292;&#26377;&#26377;&#21487;&#33021;&#22240;&#20026;&#21516;&#27493;&#30340;&#35201;&#27714;&#32780;&#35843;&#29992;local_bh_disable&#65292;&#36825;&#26102;&#20505;&#65292;&#36890;&#36807;local_bh_disable/enable&#20445;&#25252;&#36215;&#26469;&#30340;&#20195;&#30721;&#20063;&#26159;&#25191;&#34892;&#22312;softirq context&#20013;&#12290;&#24403;&#28982;&#65292;&#36825;&#26102;&#20505;&#20854;&#23454;&#24182;&#27809;&#26377;&#27491;&#22312;&#25191;&#34892;softirq handler&#12290;&#22914;&#26524;&#20320;&#30830;&#23454;&#24819;&#30693;&#36947;&#24403;&#21069;&#26159;&#21542;&#27491;&#22312;&#25191;&#34892;softirq handler&#65292;in_serving_softirq&#21487;&#20197;&#23436;&#25104;&#36825;&#20010;&#20351;&#21629;&#65292;&#36825;&#26159;&#36890;&#36807;&#25805;&#20316;preempt_count&#30340;bit 8&#26469;&#23436;&#25104;&#30340;&#12290; </P>
<P>&#25152;&#35859;&#20013;&#26029;&#19978;&#19979;&#25991;&#65292;&#23601;&#26159;IRQ context &#65291; softirq context&#65291;NMI context&#12290; </P>
<P>&nbsp; </P>
<P>&#22235;&#12289;softirq&#26426;&#21046; </P>
<P>softirq&#21644;hardirq&#65288;&#23601;&#26159;&#30828;&#20214;&#20013;&#26029;&#21862;&#65289;&#26159;&#23545;&#24212;&#30340;&#65292;&#22240;&#27492;softirq&#30340;&#26426;&#21046;&#21487;&#20197;&#21442;&#32771;hardirq&#23545;&#24212;&#29702;&#35299;&#65292;&#24403;&#28982;softirq&#26159;&#32431;&#36719;&#20214;&#30340;&#65292;&#19981;&#38656;&#35201;&#30828;&#20214;&#21442;&#19982;&#12290; </P>
<P>1&#12289;softirq number </P>
<P>&#21644;IRQ number&#19968;&#26679;&#65292;&#23545;&#20110;&#36719;&#20013;&#26029;&#65292;linux kernel&#20063;&#26159;&#29992;&#19968;&#20010;softirq number&#21807;&#19968;&#26631;&#35782;&#19968;&#20010;softirq&#65292;&#20855;&#20307;&#23450;&#20041;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>enum <BR>{ <BR>&nbsp;&nbsp;&nbsp; HI_SOFTIRQ=0, <BR>&nbsp;&nbsp;&nbsp; TIMER_SOFTIRQ, <BR>&nbsp;&nbsp;&nbsp; NET_TX_SOFTIRQ, <BR>&nbsp;&nbsp;&nbsp; NET_RX_SOFTIRQ, <BR>&nbsp;&nbsp;&nbsp; BLOCK_SOFTIRQ, <BR>&nbsp;&nbsp;&nbsp; BLOCK_IOPOLL_SOFTIRQ, <BR>&nbsp;&nbsp;&nbsp; TASKLET_SOFTIRQ, <BR>&nbsp;&nbsp;&nbsp; SCHED_SOFTIRQ, <BR>&nbsp;&nbsp;&nbsp; HRTIMER_SOFTIRQ, <BR>&nbsp;&nbsp;&nbsp; RCU_SOFTIRQ,&nbsp;&nbsp;&nbsp; /* Preferable RCU should always be the last softirq */ </P>
<P>&nbsp;&nbsp;&nbsp; NR_SOFTIRQS <BR>}; </P></BLOCKQUOTE>
<P>HI_SOFTIRQ&#29992;&#20110;&#39640;&#20248;&#20808;&#32423;&#30340;tasklet&#65292;TASKLET_SOFTIRQ&#29992;&#20110;&#26222;&#36890;&#30340;tasklet&#12290;TIMER_SOFTIRQ&#26159;for software timer&#30340;&#65288;&#25152;&#35859;software timer&#23601;&#26159;&#35828;&#35813;timer&#26159;&#22522;&#20110;&#31995;&#32479;tick&#30340;&#65289;&#12290;NET_TX_SOFTIRQ&#21644;NET_RX_SOFTIRQ&#26159;&#29992;&#20110;&#32593;&#21345;&#25968;&#25454;&#25910;&#21457;&#30340;&#12290;BLOCK_SOFTIRQ&#21644;BLOCK_IOPOLL_SOFTIRQ&#26159;&#29992;&#20110;block device&#30340;&#12290;SCHED_SOFTIRQ&#29992;&#20110;&#22810;CPU&#20043;&#38388;&#30340;&#36127;&#36733;&#22343;&#34913;&#30340;&#12290;HRTIMER_SOFTIRQ&#29992;&#20110;&#39640;&#31934;&#24230;timer&#30340;&#12290;RCU_SOFTIRQ&#26159;&#22788;&#29702;RCU&#30340;&#12290;&#36825;&#20123;&#20855;&#20307;&#20351;&#29992;&#24773;&#26223;&#20998;&#26512;&#20250;&#22312;&#21508;&#33258;&#30340;&#23376;&#31995;&#32479;&#20013;&#20998;&#26512;&#65292;&#26412;&#25991;&#21482;&#26159;&#25551;&#36848;softirq&#30340;&#24037;&#20316;&#21407;&#29702;&#12290; </P>
<P>2&#12289;softirq&#25551;&#36848;&#31526; </P>
<P>&#25105;&#20204;&#21069;&#38754;&#24050;&#32463;&#35828;&#20102;&#65292;softirq&#26159;&#38745;&#24577;&#23450;&#20041;&#30340;&#65292;&#20063;&#23601;&#26159;&#35828;&#31995;&#32479;&#20013;&#26377;&#19968;&#20010;&#23450;&#20041;softirq&#25551;&#36848;&#31526;&#30340;&#25968;&#32452;&#65292;&#32780;softirq number&#23601;&#26159;&#36825;&#20010;&#25968;&#32452;&#30340;index&#12290;&#36825;&#20010;&#27010;&#24565;&#21644;&#26089;&#26399;&#30340;&#38745;&#24577;&#20998;&#37197;&#30340;&#20013;&#26029;&#25551;&#36848;&#31526;&#27010;&#24565;&#26159;&#31867;&#20284;&#30340;&#12290;&#20855;&#20307;&#23450;&#20041;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>struct softirq_action <BR>{ <BR>&nbsp;&nbsp;&nbsp; void&nbsp;&nbsp;&nbsp; (*action)(struct softirq_action *); <BR>}; </P>
<P>static struct softirq_action softirq_vec[NR_SOFTIRQS] __cacheline_aligned_in_smp; </P></BLOCKQUOTE>
<P>&#31995;&#32479;&#25903;&#25345;&#22810;&#23569;&#20010;&#36719;&#20013;&#26029;&#65292;&#38745;&#24577;&#23450;&#20041;&#30340;&#25968;&#32452;&#23601;&#20250;&#26377;&#22810;&#23569;&#20010;entry&#12290;____cacheline_aligned&#20445;&#35777;&#20102;&#22312;SMP&#30340;&#24773;&#20917;&#19979;&#65292;softirq_vec&#26159;&#23545;&#40784;&#21040;cache line&#30340;&#12290;softirq&#25551;&#36848;&#31526;&#38750;&#24120;&#31616;&#21333;&#65292;&#21482;&#26377;&#19968;&#20010;action&#25104;&#21592;&#65292;&#34920;&#31034;&#22914;&#26524;&#35302;&#21457;&#20102;&#35813;softirq&#65292;&#37027;&#20040;&#24212;&#35813;&#35843;&#29992;action&#22238;&#35843;&#20989;&#25968;&#26469;&#22788;&#29702;&#36825;&#20010;soft irq&#12290;&#23545;&#20110;&#30828;&#20214;&#20013;&#26029;&#32780;&#35328;&#65292;&#20854;mask&#12289;ack&#31561;&#37117;&#26159;&#21644;&#30828;&#20214;&#23492;&#23384;&#22120;&#30456;&#20851;&#24182;&#23553;&#35013;&#22312;irq chip&#20989;&#25968;&#20013;&#65292;&#23545;&#20110;softirq&#65292;&#27809;&#26377;&#30828;&#20214;&#23492;&#23384;&#22120;&#65292;&#21482;&#26377;&#8220;&#36719;&#20214;&#23492;&#23384;&#22120;&#8221;&#65292;&#23450;&#20041;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>typedef struct { <BR>&nbsp;&nbsp;&nbsp; unsigned int __softirq_pending; <BR>#ifdef CONFIG_SMP <BR>&nbsp;&nbsp;&nbsp; unsigned int ipi_irqs[NR_IPI]; <BR>#endif <BR>} ____cacheline_aligned irq_cpustat_t; </P>
<P>irq_cpustat_t irq_stat[NR_CPUS] ____cacheline_aligned; </P></BLOCKQUOTE>
<P>ipi_irqs&#36825;&#20010;&#25104;&#21592;&#29992;&#20110;&#22788;&#29702;&#22120;&#20043;&#38388;&#30340;&#20013;&#26029;&#65292;&#25105;&#20204;&#30041;&#21040;&#19979;&#19968;&#20010;&#19987;&#39064;&#26469;&#25551;&#36848;&#12290;__softirq_pending&#23601;&#26159;&#36825;&#20010;&#8220;&#36719;&#20214;&#23492;&#23384;&#22120;&#8221;&#12290;softirq&#37319;&#29992;&#35841;&#35302;&#21457;&#65292;&#35841;&#36127;&#36131;&#22788;&#29702;&#30340;&#12290;&#20363;&#22914;&#65306;&#24403;&#19968;&#20010;&#39537;&#21160;&#30340;&#30828;&#20214;&#20013;&#26029;&#34987;&#20998;&#21457;&#32473;&#20102;&#25351;&#23450;&#30340;CPU&#65292;&#24182;&#19988;&#22312;&#35813;&#20013;&#26029;handler&#20013;&#35302;&#21457;&#20102;&#19968;&#20010;softirq&#65292;&#37027;&#20040;&#35813;CPU&#36127;&#36131;&#35843;&#29992;&#35813;softirq number&#23545;&#24212;&#30340;action callback&#26469;&#22788;&#29702;&#35813;&#36719;&#20013;&#26029;&#12290;&#22240;&#27492;&#65292;&#36825;&#20010;&#8220;&#36719;&#20214;&#23492;&#23384;&#22120;&#8221;&#24212;&#35813;&#26159;&#27599;&#20010;CPU&#25317;&#26377;&#19968;&#20010;&#65288;&#19987;&#19994;&#26415;&#35821;&#21483;&#20570;banked register&#65289;&#12290;&#20026;&#20102;&#24615;&#33021;&#65292;irq_stat&#20013;&#30340;&#27599;&#19968;&#20010;entry&#34987;&#23450;&#20041;&#23545;&#40784;&#21040;cache line&#12290; </P>
<P>3&#12289;&#22914;&#20309;&#27880;&#20876;&#19968;&#20010;softirq </P>
<P>&#36890;&#36807;&#35843;&#29992;open_softirq&#25509;&#21475;&#20989;&#25968;&#21487;&#20197;&#27880;&#20876;softirq&#30340;action callback&#20989;&#25968;&#65292;&#20855;&#20307;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>void open_softirq(int nr, void (*action)(struct softirq_action *)) <BR>{ <BR>&nbsp;&nbsp;&nbsp; softirq_vec[nr].action = action; <BR>} </P></BLOCKQUOTE>
<P>softirq_vec&#26159;&#19968;&#20010;&#22810;CPU&#20043;&#38388;&#20849;&#20139;&#30340;&#25968;&#25454;&#65292;&#19981;&#36807;&#65292;&#30001;&#20110;&#25152;&#26377;&#30340;&#27880;&#20876;&#37117;&#26159;&#22312;&#31995;&#32479;&#21021;&#22987;&#21270;&#30340;&#26102;&#20505;&#23436;&#25104;&#30340;&#65292;&#37027;&#26102;&#20505;&#65292;&#31995;&#32479;&#26159;&#20018;&#34892;&#25191;&#34892;&#30340;&#12290;&#27492;&#22806;&#65292;softirq&#26159;&#38745;&#24577;&#23450;&#20041;&#30340;&#65292;&#27599;&#20010;entry&#65288;&#25110;&#32773;&#35828;&#27599;&#20010;softirq number&#65289;&#37117;&#26159;&#22266;&#23450;&#20998;&#37197;&#30340;&#65292;&#22240;&#27492;&#65292;&#19981;&#38656;&#35201;&#20445;&#25252;&#12290; </P>
<P>4&#12289;&#22914;&#20309;&#35302;&#21457;softirq&#65311; </P>
<P>&#22312;linux kernel&#20013;&#65292;&#21487;&#20197;&#35843;&#29992;raise_softirq&#36825;&#20010;&#25509;&#21475;&#20989;&#25968;&#26469;&#35302;&#21457;&#26412;&#22320;CPU&#19978;&#30340;softirq&#65292;&#20855;&#20307;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>void raise_softirq(unsigned int nr) <BR>{ <BR>&nbsp;&nbsp;&nbsp; unsigned long flags; </P>
<P>&nbsp;&nbsp;&nbsp; local_irq_save(flags); <BR>&nbsp;&nbsp;&nbsp; raise_softirq_irqoff(nr); <BR>&nbsp;&nbsp;&nbsp; local_irq_restore(flags); <BR>} </P></BLOCKQUOTE>
<P>&#34429;&#28982;&#22823;&#37096;&#20998;&#30340;&#20351;&#29992;&#22330;&#26223;&#37117;&#26159;&#22312;&#20013;&#26029;handler&#20013;&#65288;&#20063;&#23601;&#26159;&#35828;&#20851;&#38381;&#26412;&#22320;CPU&#20013;&#26029;&#65289;&#26469;&#25191;&#34892;softirq&#30340;&#35302;&#21457;&#21160;&#20316;&#65292;&#20294;&#26159;&#65292;&#36825;&#19981;&#26159;&#20840;&#37096;&#65292;&#22312;&#20854;&#20182;&#30340;&#19978;&#19979;&#25991;&#20013;&#20063;&#21487;&#20197;&#35843;&#29992;raise_softirq&#12290;&#22240;&#27492;&#65292;&#35302;&#21457;softirq&#30340;&#25509;&#21475;&#20989;&#25968;&#26377;&#20004;&#20010;&#29256;&#26412;&#65292;&#19968;&#20010;&#26159;raise_softirq&#65292;&#26377;&#20851;&#20013;&#26029;&#30340;&#20445;&#25252;&#65292;&#21478;&#22806;&#19968;&#20010;&#26159;raise_softirq_irqoff&#65292;&#35843;&#29992;&#32773;&#24050;&#32463;&#20851;&#38381;&#20102;&#20013;&#26029;&#65292;&#19981;&#38656;&#35201;&#20851;&#20013;&#26029;&#26469;&#20445;&#25252;&#8220;soft irq status register&#8221;&#12290; </P>
<P>&#25152;&#35859;trigger softirq&#65292;&#23601;&#26159;&#22312;__softirq_pending&#65288;&#20063;&#23601;&#26159;&#19978;&#38754;&#35828;&#30340;soft irq status register&#65289;&#30340;&#26576;&#20010;bit&#32622;&#19968;&#12290;&#20174;&#19978;&#38754;&#30340;&#23450;&#20041;&#21487;&#30693;&#65292;__softirq_pending&#26159;per cpu&#30340;&#65292;&#22240;&#27492;&#19981;&#38656;&#35201;&#32771;&#34385;&#22810;&#20010;CPU&#30340;&#24182;&#21457;&#65292;&#21482;&#35201;disable&#26412;&#22320;&#20013;&#26029;&#65292;&#23601;&#21487;&#20197;&#30830;&#20445;&#23545;&#65292;__softirq_pending&#25805;&#20316;&#30340;&#21407;&#23376;&#24615;&#12290; </P>
<P>&#20855;&#20307;raise_softirq_irqoff&#30340;&#20195;&#30721;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>inline void raise_softirq_irqoff(unsigned int nr) <BR>{ <BR>&nbsp;&nbsp;&nbsp; __raise_softirq_irqoff(nr); &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;1&#65289; </P>
<P><BR>&nbsp;&nbsp;&nbsp; if (!in_interrupt()) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wakeup_softirqd();&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;2&#65289; <BR>} </P></BLOCKQUOTE>
<P>&#65288;1&#65289;__raise_softirq_irqoff&#20989;&#25968;&#35774;&#23450;&#26412;CPU&#19978;&#30340;__softirq_pending&#30340;&#26576;&#20010;bit&#31561;&#20110;1&#65292;&#20855;&#20307;&#30340;bit&#26159;&#30001;soft irq number&#65288;nr&#21442;&#25968;&#65289;&#25351;&#23450;&#30340;&#12290; </P>
<P>&#65288;2&#65289;&#22914;&#26524;&#22312;&#20013;&#26029;&#19978;&#19979;&#25991;&#65292;&#25105;&#20204;&#21482;&#35201;set __softirq_pending&#30340;&#26576;&#20010;bit&#23601;OK&#20102;&#65292;&#22312;&#20013;&#26029;&#36820;&#22238;&#30340;&#26102;&#20505;&#33258;&#28982;&#20250;&#36827;&#34892;&#36719;&#20013;&#26029;&#30340;&#22788;&#29702;&#12290;&#20294;&#26159;&#65292;&#22914;&#26524;&#22312;context&#19978;&#19979;&#25991;&#35843;&#29992;&#36825;&#20010;&#20989;&#25968;&#30340;&#26102;&#20505;&#65292;&#25105;&#20204;&#24517;&#39035;&#35201;&#35843;&#29992;wakeup_softirqd&#20989;&#25968;&#29992;&#26469;&#21796;&#37266;&#26412;CPU&#19978;&#30340;softirqd&#36825;&#20010;&#20869;&#26680;&#32447;&#31243;&#12290;&#20855;&#20307;softirqd&#30340;&#20869;&#23481;&#35831;&#21442;&#32771;&#19979;&#19968;&#20010;&#31456;&#33410;&#12290; </P>
<P>&nbsp; </P>
<P>5&#12289;disable/enable softirq </P>
<P>&#22312;linux kernel&#20013;&#65292;&#21487;&#20197;&#20351;&#29992;local_irq_disable&#21644;local_irq_enable&#26469;disable&#21644;enable&#26412;CPU&#20013;&#26029;&#12290;&#21644;&#30828;&#20214;&#20013;&#26029;&#19968;&#26679;&#65292;&#36719;&#20013;&#26029;&#20063;&#21487;&#20197;disable&#65292;&#25509;&#21475;&#20989;&#25968;&#26159;local_bh_disable&#21644;local_bh_enable&#12290;&#34429;&#28982;&#21644;&#24819;&#20687;&#30340;local_softirq_enable/disable&#26377;&#20123;&#20986;&#20837;&#65292;&#19981;&#36807;bh&#36825;&#20010;&#21517;&#23383;&#26356;&#20934;&#30830;&#21453;&#24212;&#20102;&#35813;&#25509;&#21475;&#20989;&#25968;&#30340;&#24847;&#28085;&#65292;&#22240;&#20026;local_bh_disable/enable&#20989;&#25968;&#23601;&#26159;&#29992;&#26469;disable/enable bottom half&#30340;&#65292;&#36825;&#37324;&#23601;&#21253;&#25324;softirq&#21644;tasklet&#12290; </P>
<P>&#20808;&#30475;disable&#21543;&#65292;&#27605;&#31455;&#31105;&#27490;bottom half&#27604;&#36739;&#31616;&#21333;&#65306; </P>
<BLOCKQUOTE>
<P>static inline void local_bh_disable(void) <BR>{ <BR>&nbsp;&nbsp;&nbsp; __local_bh_disable_ip(_THIS_IP_, SOFTIRQ_DISABLE_OFFSET); <BR>} </P>
<P>static __always_inline void __local_bh_disable_ip(unsigned long ip, unsigned int cnt) <BR>{ <BR>&nbsp;&nbsp;&nbsp; preempt_count_add(cnt); <BR>&nbsp;&nbsp;&nbsp; barrier(); <BR>} </P></BLOCKQUOTE>
<P>&#30475;&#36215;&#26469;disable bottom half&#27604;&#36739;&#31616;&#21333;&#65292;&#23601;&#26159;&#35762;current thread info&#19978;&#30340;preempt_count&#25104;&#21592;&#20013;&#30340;softirq count&#30340;bit field9&#65374;15&#21152;&#19978;&#19968;&#23601;OK&#20102;&#12290;barrier&#26159;&#20248;&#21270;&#23631;&#38556;&#65288;Optimization barrier&#65289;&#65292;&#20250;&#22312;&#20869;&#26680;&#21516;&#27493;&#31995;&#21015;&#25991;&#31456;&#20013;&#25551;&#36848;&#12290; </P>
<P>enable&#20989;&#25968;&#27604;&#36739;&#22797;&#26434;&#65292;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>static inline void local_bh_enable(void) <BR>{ <BR>&nbsp;&nbsp;&nbsp; __local_bh_enable_ip(_THIS_IP_, SOFTIRQ_DISABLE_OFFSET); <BR>} </P>
<P>void __local_bh_enable_ip(unsigned long ip, unsigned int cnt) <BR>{ <BR>&nbsp;&nbsp;&nbsp; WARN_ON_ONCE(in_irq() || irqs_disabled());&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;1&#65289; <BR><BR>&nbsp;&nbsp;&nbsp; preempt_count_sub(cnt - 1); &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;2&#65289; </P>
<P>&nbsp;&nbsp;&nbsp; if (unlikely(!in_interrupt() &amp;&amp; local_softirq_pending())) { &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;3&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do_softirq(); <BR>&nbsp;&nbsp;&nbsp; } </P>
<P>&nbsp;&nbsp;&nbsp; preempt_count_dec(); &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;4&#65289; <BR>&nbsp;&nbsp;&nbsp; preempt_check_resched(); <BR>} </P></BLOCKQUOTE>
<P>&#65288;1&#65289;disable/enable bottom half&#26159;&#19968;&#31181;&#20869;&#26680;&#21516;&#27493;&#26426;&#21046;&#12290;&#22312;&#30828;&#20214;&#20013;&#26029;&#30340;handler&#65288;top half&#65289;&#20013;&#65292;&#19981;&#24212;&#35813;&#35843;&#29992;disable/enable bottom half&#20989;&#25968;&#26469;&#20445;&#25252;&#20849;&#20139;&#25968;&#25454;&#65292;&#22240;&#20026;bottom half&#20854;&#23454;&#26159;&#19981;&#21487;&#33021;&#25250;&#21344;top half&#30340;&#12290;&#21516;&#26679;&#30340;&#65292;soft irq&#20063;&#19981;&#20250;&#25250;&#21344;&#21478;&#22806;&#19968;&#20010;soft irq&#30340;&#25191;&#34892;&#65292;&#20063;&#23601;&#26159;&#35828;&#65292;&#19968;&#26086;&#19968;&#20010;softirq handler&#34987;&#35843;&#24230;&#25191;&#34892;&#65288;&#26080;&#35770;&#22312;&#21738;&#19968;&#20010;processor&#19978;&#65289;&#65292;&#37027;&#20040;&#65292;&#26412;&#22320;&#30340;softirq handler&#37117;&#26080;&#27861;&#25250;&#21344;&#20854;&#36816;&#34892;&#65292;&#35201;&#31561;&#21040;&#24403;&#21069;&#30340;softirq handler&#36816;&#34892;&#23436;&#27605;&#21518;&#65292;&#25165;&#33021;&#25191;&#34892;&#19979;&#19968;&#20010;soft irq handler&#12290;&#27880;&#24847;&#65306;&#19978;&#38754;&#25105;&#20204;&#35828;&#30340;&#26159;&#26412;&#22320;&#65292;&#26159;local&#65292;softirq handler&#26159;&#21487;&#20197;&#22312;&#22810;&#20010;CPU&#19978;&#21516;&#26102;&#36816;&#34892;&#30340;&#65292;&#20294;&#26159;&#65292;linux kernel&#20013;&#27809;&#26377;disable all softirq&#30340;&#25509;&#21475;&#20989;&#25968;&#65288;&#23601;&#22909;&#20687;&#27809;&#26377;disable all CPU interrupt&#30340;&#25509;&#21475;&#19968;&#26679;&#65292;&#27880;&#24847;&#20307;&#20250;local_bh_enable/disable&#20013;&#30340;local&#30340;&#21547;&#20041;&#65289;&#12290; </P>
<P>&#35828;&#20102;&#36825;&#20040;&#22810;&#65292;&#19968;&#35328;&#20197;&#34109;&#20043;&#65292;local_bh_enable/disable&#26159;&#32473;&#36827;&#31243;&#19978;&#19979;&#25991;&#20351;&#29992;&#30340;&#65292;&#29992;&#20110;&#38450;&#27490;softirq handler&#25250;&#21344;local_bh_enable/disable&#20043;&#38388;&#30340;&#20020;&#30028;&#21306;&#30340;&#12290; </P>
<P>irqs_disabled&#25509;&#21475;&#20989;&#25968;&#21487;&#20197;&#33719;&#30693;&#24403;&#21069;&#26412;&#22320;CPU&#20013;&#26029;&#26159;&#21542;&#26159;disable&#30340;&#65292;&#22914;&#26524;&#36820;&#22238;1&#65292;&#37027;&#20040;&#24403;&#21069;&#26159;disable &#26412;&#22320;CPU&#30340;&#20013;&#26029;&#30340;&#12290;&#22914;&#26524;irqs_disabled&#36820;&#22238;1&#65292;&#26377;&#21487;&#33021;&#26159;&#19979;&#38754;&#36825;&#26679;&#30340;&#20195;&#30721;&#36896;&#25104;&#30340;&#65306; </P>
<BLOCKQUOTE>
<P>local_irq_disable(); </P>
<P>&#8230;&#8230; <BR>local_bh_disable(); </P>
<P>&#8230;&#8230; </P>
<P>local_bh_enable(); <BR>&#8230;&#8230; <BR>local_irq_enable(); </P></BLOCKQUOTE>
<P>&#26412;&#36136;&#19978;&#65292;&#20851;&#26412;&#22320;&#20013;&#26029;&#26159;&#19968;&#31181;&#27604;&#20851;&#26412;&#22320;bottom half&#26356;&#24378;&#21170;&#30340;&#38145;&#65292;&#20851;&#26412;&#22320;&#20013;&#26029;&#23454;&#38469;&#19978;&#26159;&#31105;&#27490;&#20102;top half&#21644;bottom half&#25250;&#21344;&#24403;&#21069;&#36827;&#31243;&#19978;&#19979;&#25991;&#30340;&#36816;&#34892;&#12290;&#20063;&#35768;&#20320;&#20250;&#35828;&#65306;&#36825;&#20063;&#27809;&#26377;&#20160;&#20040;&#65292;&#23601;&#26159;&#26377;&#20123;&#28010;&#36153;&#65292;&#33267;&#23569;&#20195;&#30721;&#36923;&#36753;&#27809;&#26377;&#38382;&#39064;&#12290;&#20294;&#20107;&#24773;&#27809;&#26377;&#36825;&#20040;&#31616;&#21333;&#65292;&#22312;local_bh_enable---&gt;do_softirq---&gt;__do_softirq&#20013;&#65292;&#26377;&#19968;&#26465;&#26080;&#26465;&#20214;&#25171;&#24320;&#24403;&#21069;&#20013;&#26029;&#30340;&#25805;&#20316;&#65292;&#20063;&#23601;&#26159;&#35828;&#65292;&#21407;&#26412;&#24819;&#36890;&#36807;local_irq_disable/local_irq_enable&#20445;&#25252;&#30340;&#20020;&#30028;&#21306;&#34987;&#30772;&#22351;&#20102;&#65292;&#20854;&#20182;&#30340;&#20013;&#26029;handler&#21487;&#20197;&#25554;&#20837;&#25191;&#34892;&#65292;&#20174;&#32780;&#26080;&#27861;&#20445;&#35777;local_irq_disable/local_irq_enable&#20445;&#25252;&#30340;&#20020;&#30028;&#21306;&#30340;&#21407;&#23376;&#24615;&#65292;&#20174;&#32780;&#30772;&#22351;&#20102;&#20195;&#30721;&#36923;&#36753;&#12290; </P>
<P>in_irq()&#36825;&#20010;&#20989;&#25968;&#22914;&#26524;&#19981;&#31561;&#20110;0&#30340;&#35805;&#65292;&#35828;&#26126;local_bh_enable&#34987;irq_enter&#21644;irq_exit&#21253;&#22260;&#65292;&#20063;&#23601;&#26159;&#35828;&#22312;&#20013;&#26029;handler&#20013;&#35843;&#29992;&#20102;local_bh_enable/disable&#12290;&#36825;&#36947;&#29702;&#26159;&#21644;&#19978;&#38754;&#31867;&#20284;&#30340;&#65292;&#36825;&#37324;&#23601;&#19981;&#20877;&#35814;&#32454;&#25551;&#36848;&#20102;&#12290; </P>
<P>&#65288;2&#65289;&#22312;local_bh_disable&#20013;&#25105;&#20204;&#20026;preempt_count&#22686;&#21152;&#20102;SOFTIRQ_DISABLE_OFFSET&#65292;&#22312;local_bh_enable&#20989;&#25968;&#20013;&#24212;&#35813;&#20943;&#25481;&#21516;&#26679;&#30340;&#25968;&#20540;&#12290;&#36825;&#19968;&#27493;&#65292;&#25105;&#20204;&#39318;&#20808;&#20943;&#21435;&#20102;&#65288;SOFTIRQ_DISABLE_OFFSET&#65293;1&#65289;&#65292;&#20026;&#20309;&#19981;&#19968;&#27425;&#24615;&#30340;&#20943;&#21435;SOFTIRQ_DISABLE_OFFSET&#21602;&#65311;&#32771;&#34385;&#19979;&#38754;&#36816;&#34892;&#22312;&#36827;&#31243;&#19978;&#19979;&#25991;&#30340;&#20195;&#30721;&#22330;&#26223;&#65306; </P>
<BLOCKQUOTE>
<P><SPAN style="BACKGROUND-COLOR: rgb(255,255,255)">&#8230;&#8230;</SPAN> </P>
<P>local_bh_disable </P>
<P>&#8230;&#8230;&#38656;&#35201;&#34987;&#20445;&#25252;&#30340;&#20020;&#30028;&#21306;&#8230;&#8230; </P>
<P>local_bh_enable </P>
<P><SPAN style="BACKGROUND-COLOR: rgb(255,255,255)">&#8230;&#8230;</SPAN> </P></BLOCKQUOTE>
<P>&#22312;&#20020;&#30028;&#21306;&#20869;&#65292;&#26377;&#36827;&#31243;context &#21644;softirq&#20849;&#20139;&#30340;&#25968;&#25454;&#65292;&#22240;&#27492;&#65292;&#22312;&#36827;&#31243;&#19978;&#19979;&#25991;&#20013;&#20351;&#29992;local_bh_enable/disable&#36827;&#34892;&#20445;&#25252;&#12290;&#20551;&#35774;&#22312;&#20020;&#30028;&#21306;&#20195;&#30721;&#25191;&#34892;&#30340;&#26102;&#20505;&#65292;&#21457;&#29983;&#20102;&#20013;&#26029;&#65292;&#30001;&#20110;&#20195;&#30721;&#24182;&#27809;&#26377;&#38459;&#27490;top half&#30340;&#25250;&#21344;&#65292;&#22240;&#27492;&#20013;&#26029;handler&#20250;&#25250;&#21344;&#24403;&#21069;&#27491;&#22312;&#25191;&#34892;&#30340;thread&#12290;&#22312;&#20013;&#26029;handler&#20013;&#65292;&#25105;&#20204;raise&#20102;softirq&#65292;&#22312;&#36820;&#22238;&#20013;&#26029;&#29616;&#22330;&#30340;&#26102;&#20505;&#65292;&#30001;&#20110;disable&#20102;bottom half&#65292;&#22240;&#27492;&#34429;&#28982;&#35302;&#21457;&#20102;softirq&#65292;&#20294;&#26159;&#19981;&#20250;&#35843;&#24230;&#25191;&#34892;&#12290;&#22240;&#27492;&#65292;&#20195;&#30721;&#36820;&#22238;&#20020;&#30028;&#21306;&#32487;&#32493;&#25191;&#34892;&#65292;&#30452;&#21040;local_bh_enable&#12290;&#19968;&#26086;enable&#20102;bottom half&#65292;&#37027;&#20040;&#20043;&#21069;raise&#30340;softirq&#23601;&#38656;&#35201;&#35843;&#24230;&#25191;&#34892;&#20102;&#65292;&#22240;&#27492;&#65292;&#36825;&#20063;&#26159;&#20026;&#20160;&#20040;&#22312;local_bh_enable&#20250;&#35843;&#29992;do_softirq&#20989;&#25968;&#12290; </P>
<P>&#35843;&#29992;do_softirq&#20989;&#25968;&#26469;&#22788;&#29702;pending&#30340;softirq&#30340;&#26102;&#20505;&#65292;&#24403;&#21069;&#30340;task&#26159;&#19981;&#33021;&#34987;&#25250;&#21344;&#30340;&#65292;&#22240;&#20026;&#19968;&#26086;&#34987;&#25250;&#21344;&#65292;&#19979;&#19968;&#27425;&#35813;task&#34987;&#35843;&#24230;&#36816;&#34892;&#30340;&#26102;&#20505;&#24456;&#21487;&#33021;&#22312;&#20854;&#20182;&#30340;CPU&#19978;&#21435;&#20102;&#65288;&#36824;&#35760;&#24471;&#21527;&#65311;softirq&#30340;pending &#23492;&#23384;&#22120;&#26159;per cpu&#30340;&#65289;&#12290;&#22240;&#27492;&#65292;&#25105;&#20204;&#19981;&#33021;&#19968;&#27425;&#24615;&#30340;&#20840;&#37096;&#20943;&#25481;&#65292;&#37027;&#26679;&#30340;&#35805;&#26377;&#21487;&#33021;preempt_count&#31561;&#20110;0&#65292;&#37027;&#26679;&#23601;&#20801;&#35768;&#25250;&#21344;&#20102;&#12290;&#22240;&#27492;&#65292;&#36825;&#37324;&#20943;&#21435;&#20102;&#65288;SOFTIRQ_DISABLE_OFFSET&#65293;1&#65289;&#65292;&#26082;&#20445;&#35777;&#20102;softirq count&#30340;bit field9&#65374;15&#34987;&#20943;&#21435;&#20102;1&#65292;&#21448;&#20445;&#25345;&#20102;preempt disable&#30340;&#29366;&#24577;&#12290; </P>
<P>&#65288;3&#65289;&#22914;&#26524;&#24403;&#21069;&#19981;&#26159;interrupt context&#30340;&#35805;&#65292;&#24182;&#19988;&#26377;pending&#30340;softirq&#65292;&#37027;&#20040;&#35843;&#29992;do_softirq&#20989;&#25968;&#26469;&#22788;&#29702;&#36719;&#20013;&#26029;&#12290; </P>
<P>&#65288;4&#65289;&#35813;&#26469;&#30340;&#24635;&#20250;&#26469;&#65292;&#22312;step 2&#20013;&#25105;&#20204;&#23569;&#20943;&#20102;1&#65292;&#36825;&#37324;&#34917;&#19978;&#65292;&#20854;&#23454;&#20063;&#23601;&#26159;preempt count-1&#12290; </P>
<P>&#65288;5&#65289;&#22312;softirq handler&#20013;&#24456;&#21487;&#33021;wakeup&#20102;&#39640;&#20248;&#20808;&#32423;&#30340;&#20219;&#21153;&#65292;&#36825;&#37324;&#26368;&#22909;&#35201;&#26816;&#26597;&#19968;&#19979;&#65292;&#30475;&#30475;&#26159;&#21542;&#38656;&#35201;&#36827;&#34892;&#35843;&#24230;&#65292;&#30830;&#20445;&#39640;&#20248;&#20808;&#32423;&#30340;&#20219;&#21153;&#24471;&#20197;&#35843;&#24230;&#25191;&#34892;&#12290; </P>
<P>&nbsp; </P>
<P>5&#12289;&#22914;&#20309;&#22788;&#29702;&#19968;&#20010;&#34987;&#35302;&#21457;&#30340;soft irq </P>
<P>&#25105;&#20204;&#35828;softirq&#26159;&#19968;&#31181;defering task&#30340;&#26426;&#21046;&#65292;&#20063;&#23601;&#26159;&#35828;top half&#27809;&#26377;&#20570;&#30340;&#20107;&#24773;&#65292;&#38656;&#35201;&#24310;&#36831;&#21040;bottom half&#20013;&#26469;&#25191;&#34892;&#12290;&#37027;&#20040;&#20855;&#20307;&#24310;&#36831;&#21040;&#20160;&#20040;&#26102;&#20505;&#21602;&#65311;&#36825;&#26159;&#26412;&#33410;&#38656;&#35201;&#35762;&#36848;&#30340;&#20869;&#23481;&#65292;&#20063;&#23601;&#26159;&#35828;soft irq&#26159;&#22914;&#20309;&#35843;&#24230;&#25191;&#34892;&#30340;&#12290; </P>
<P>&#22312;&#19978;&#19968;&#33410;&#24050;&#32463;&#25551;&#36848;&#19968;&#20010;softirq&#34987;&#35843;&#24230;&#25191;&#34892;&#30340;&#22330;&#26223;&#65292;&#26412;&#33410;&#20027;&#35201;&#20851;&#27880;&#22312;&#20013;&#26029;&#36820;&#22238;&#29616;&#22330;&#26102;&#20505;&#35843;&#24230;softirq&#30340;&#22330;&#26223;&#12290;&#25105;&#20204;&#26469;&#30475;&#20013;&#26029;&#36864;&#20986;&#30340;&#20195;&#30721;&#65292;&#20855;&#20307;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>void irq_exit(void) <BR>{ <BR>&#8230;&#8230; <BR>&nbsp;&nbsp;&nbsp; if (!in_interrupt() &amp;&amp; local_softirq_pending()) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; invoke_softirq(); </P>
<P>&#8230;&#8230; <BR>} </P></BLOCKQUOTE>
<P>&#20195;&#30721;&#20013;&#8220;!in_interrupt()&#8221;&#36825;&#20010;&#26465;&#20214;&#21487;&#20197;&#30830;&#20445;&#19979;&#38754;&#30340;&#22330;&#26223;&#19981;&#20250;&#35302;&#21457;sotfirq&#30340;&#35843;&#24230;&#65306; </P>
<P>&#65288;1&#65289;&#20013;&#26029;handler&#26159;&#23884;&#22871;&#30340;&#12290;&#20063;&#23601;&#26159;&#35828;&#26412;&#27425;irq_exit&#26159;&#36864;&#20986;&#21040;&#19978;&#19968;&#20010;&#20013;&#26029;handler&#12290;&#24403;&#28982;&#65292;&#22312;&#26032;&#30340;&#20869;&#26680;&#20013;&#65292;&#36825;&#31181;&#24773;&#20917;&#19968;&#33324;&#19981;&#20250;&#21457;&#29983;&#65292;&#22240;&#20026;&#20013;&#26029;handler&#37117;&#26159;&#20851;&#20013;&#26029;&#25191;&#34892;&#30340;&#12290; </P>
<P>&#65288;2&#65289;&#26412;&#27425;&#20013;&#26029;&#26159;&#20013;&#26029;&#20102;softirq handler&#30340;&#25191;&#34892;&#12290;&#20063;&#23601;&#26159;&#35828;&#26412;&#27425;irq_exit&#26159;&#19981;&#26159;&#36864;&#20986;&#21040;&#36827;&#31243;&#19978;&#19979;&#25991;&#65292;&#32780;&#26159;&#36864;&#20986;&#21040;&#19978;&#19968;&#20010;softirq context&#12290;&#36825;&#19968;&#28857;&#20063;&#20445;&#35777;&#20102;&#22312;&#19968;&#20010;CPU&#19978;&#30340;softirq&#26159;&#20018;&#34892;&#25191;&#34892;&#30340;&#65288;&#27880;&#24847;&#65306;&#22810;&#20010;CPU&#19978;&#36824;&#26159;&#26377;&#21487;&#33021;&#24182;&#21457;&#30340;&#65289; </P>
<P>&#25105;&#20204;&#32487;&#32493;&#30475;invoke_softirq&#30340;&#20195;&#30721;&#65306; </P>
<BLOCKQUOTE>
<P>static inline void invoke_softirq(void) <BR>{ <BR>&nbsp;&nbsp;&nbsp; if (!force_irqthreads) { <BR>#ifdef CONFIG_HAVE_IRQ_EXIT_ON_IRQ_STACK <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __do_softirq(); <BR>#else <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do_softirq_own_stack(); <BR>#endif <BR>&nbsp;&nbsp;&nbsp; } else { <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wakeup_softirqd(); <BR>&nbsp;&nbsp;&nbsp; } <BR>} </P></BLOCKQUOTE>
<P>force_irqthreads&#26159;&#21644;&#24378;&#21046;&#32447;&#31243;&#21270;&#30456;&#20851;&#30340;&#65292;&#20027;&#35201;&#29992;&#20110;interrupt handler&#30340;&#35843;&#35797;&#65288;&#19968;&#33324;&#32780;&#35328;&#65292;&#22312;&#32447;&#31243;&#29615;&#22659;&#19979;&#27604;&#22312;&#20013;&#26029;&#19978;&#19979;&#25991;&#20013;&#26356;&#23481;&#26131;&#25910;&#38598;&#35843;&#35797;&#25968;&#25454;&#65289;&#12290;&#22914;&#26524;&#31995;&#32479;&#36873;&#25321;&#20102;&#23545;&#25152;&#26377;&#30340;interrupt handler&#36827;&#34892;&#32447;&#31243;&#21270;&#22788;&#29702;&#65292;&#37027;&#20040;softirq&#20063;&#27809;&#26377;&#29702;&#30001;&#22312;&#20013;&#26029;&#19978;&#19979;&#25991;&#20013;&#22788;&#29702;&#65288;&#20013;&#26029;handler&#37117;&#22312;&#32447;&#31243;&#20013;&#25191;&#34892;&#20102;&#65292;softirq&#24590;&#20040;&#21487;&#33021;&#22312;&#20013;&#26029;&#19978;&#19979;&#25991;&#20013;&#25191;&#34892;&#65289;&#12290;&#26412;&#36523;invoke_softirq&#36825;&#20010;&#20989;&#25968;&#26159;&#22312;&#20013;&#26029;&#19978;&#19979;&#25991;&#20013;&#34987;&#35843;&#29992;&#30340;&#65292;&#22914;&#26524;&#24378;&#21046;&#32447;&#31243;&#21270;&#65292;&#37027;&#20040;&#31995;&#32479;&#20013;&#25152;&#26377;&#30340;&#36719;&#20013;&#26029;&#37117;&#22312;sofirq&#30340;daemon&#36827;&#31243;&#20013;&#34987;&#35843;&#24230;&#25191;&#34892;&#12290; </P>
<P>&#22914;&#26524;&#27809;&#26377;&#24378;&#21046;&#32447;&#31243;&#21270;&#65292;softirq&#30340;&#22788;&#29702;&#20063;&#20998;&#25104;&#20004;&#31181;&#24773;&#20917;&#65292;&#20027;&#35201;&#26159;&#21644;softirq&#25191;&#34892;&#30340;&#26102;&#20505;&#20351;&#29992;&#30340;stack&#30456;&#20851;&#12290;&#22914;&#26524;arch&#25903;&#25345;&#21333;&#29420;&#30340;IRQ STACK&#65292;&#36825;&#26102;&#20505;&#65292;&#30001;&#20110;&#35201;&#36864;&#20986;&#20013;&#26029;&#65292;&#22240;&#27492;irq stack&#24050;&#32463;&#25509;&#36817;&#20840;&#31354;&#20102;&#65288;&#19981;&#32771;&#34385;&#20013;&#26029;&#26632;&#23884;&#22871;&#30340;&#24773;&#20917;&#65292;&#22240;&#27492;&#26032;&#20869;&#26680;&#19979;&#65292;&#20013;&#26029;&#19981;&#20250;&#23884;&#22871;&#65289;&#65292;&#22240;&#27492;&#30452;&#25509;&#35843;&#29992;__do_softirq()&#22788;&#29702;&#36719;&#20013;&#26029;&#23601;OK&#20102;&#65292;&#21542;&#21017;&#23601;&#35843;&#29992;do_softirq_own_stack&#20989;&#25968;&#22312;softirq&#33258;&#24049;&#30340;stack&#19978;&#25191;&#34892;&#12290;&#24403;&#28982;&#23545;ARM&#32780;&#35328;&#65292;softirq&#30340;&#22788;&#29702;&#23601;&#26159;&#22312;&#24403;&#21069;&#30340;&#20869;&#26680;&#26632;&#19978;&#25191;&#34892;&#30340;&#65292;&#22240;&#27492;do_softirq_own_stack&#30340;&#35843;&#29992;&#23601;&#26159;&#35843;&#29992;__do_softirq()&#65292;&#20195;&#30721;&#22914;&#19979;&#65288;&#21024;&#38500;&#20102;&#37096;&#20998;&#26080;&#20851;&#20195;&#30721;&#65289;&#65306; </P>
<BLOCKQUOTE>
<P>asmlinkage void __do_softirq(void) <BR>{ </P>
<P>&#8230;&#8230; </P>
<P>&nbsp;&nbsp;&nbsp; pending = local_softirq_pending();&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#33719;&#21462;softirq pending&#30340;&#29366;&#24577; </P>
<P>&nbsp;&nbsp;&nbsp; __local_bh_disable_ip(_RET_IP_, SOFTIRQ_OFFSET);&#65293;&#65293;&#65293;&#26631;&#35782;&#19979;&#38754;&#30340;&#20195;&#30721;&#26159;&#27491;&#22312;&#22788;&#29702;softirq </P>
<P>&nbsp;&nbsp;&nbsp; cpu = smp_processor_id(); <BR>restart: <BR>&nbsp;&nbsp;&nbsp; set_softirq_pending(0); &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#28165;&#38500;pending&#26631;&#24535; </P>
<P>&nbsp;&nbsp;&nbsp; local_irq_enable(); &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#25171;&#24320;&#20013;&#26029;&#65292;softirq handler&#26159;&#24320;&#20013;&#26029;&#25191;&#34892;&#30340; </P>
<P>&nbsp;&nbsp;&nbsp; h = softirq_vec; &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#33719;&#21462;&#36719;&#20013;&#26029;&#25551;&#36848;&#31526;&#25351;&#38024; </P>
<P>&nbsp;&nbsp;&nbsp; while ((softirq_bit = ffs(pending))) {&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#23547;&#25214;pending&#20013;&#31532;&#19968;&#20010;&#34987;&#35774;&#23450;&#20026;1&#30340;bit <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned int vec_nr; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int prev_count; </P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; h += softirq_bit - 1; &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#25351;&#21521;pending&#30340;&#37027;&#20010;&#36719;&#20013;&#26029;&#25551;&#36848;&#31526; </P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vec_nr = h - softirq_vec;&#65293;&#65293;&#65293;&#65293;&#33719;&#21462;soft irq number <BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; h-&gt;action(h);&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#25351;&#21521;softirq handler <BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; h++; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pending &gt;&gt;= softirq_bit; <BR>&nbsp;&nbsp;&nbsp; } </P>
<P>&nbsp;&nbsp;&nbsp; local_irq_disable(); &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#20851;&#38381;&#26412;&#22320;&#20013;&#26029; </P>
<P>&nbsp;&nbsp;&nbsp; pending = local_softirq_pending();&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;&#27880;1&#65289; <BR>&nbsp;&nbsp;&nbsp; if (pending) { <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (time_before(jiffies, end) &amp;&amp; !need_resched() &amp;&amp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --max_restart) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto restart; </P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wakeup_softirqd(); <BR>&nbsp;&nbsp;&nbsp; } </P>
<P><BR>&nbsp;&nbsp;&nbsp; __local_bh_enable(SOFTIRQ_OFFSET);&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#26631;&#35782;softirq&#22788;&#29702;&#23436;&#27605; <BR><BR>} </P></BLOCKQUOTE>
<P>&#65288;&#27880;1&#65289;&#20877;&#27425;&#26816;&#26597;softirq pending&#65292;&#26377;&#21487;&#33021;&#19978;&#38754;&#30340;softirq handler&#22312;&#25191;&#34892;&#36807;&#31243;&#20013;&#65292;&#21457;&#29983;&#20102;&#20013;&#26029;&#65292;&#21448;raise&#20102;softirq&#12290;&#22914;&#26524;&#30340;&#30830;&#22914;&#27492;&#65292;&#37027;&#20040;&#25105;&#20204;&#38656;&#35201;&#36339;&#36716;&#21040;restart&#37027;&#37324;&#37325;&#26032;&#22788;&#29702;soft irq&#12290;&#24403;&#28982;&#65292;&#20063;&#19981;&#33021;&#24635;&#26159;&#22312;&#36825;&#37324;&#19981;&#26029;&#30340;loop&#65292;&#22240;&#27492;linux kernel&#35774;&#23450;&#20102;&#19979;&#38754;&#30340;&#26465;&#20214;&#65306; </P>
<P>&#65288;1&#65289;softirq&#30340;&#22788;&#29702;&#26102;&#38388;&#27809;&#26377;&#36229;&#36807;2&#20010;ms </P>
<P>&#65288;2&#65289;&#19978;&#27425;&#30340;softirq&#20013;&#27809;&#26377;&#35774;&#23450;TIF_NEED_RESCHED&#65292;&#20063;&#23601;&#26159;&#35828;&#27809;&#26377;&#26377;&#39640;&#20248;&#20808;&#32423;&#20219;&#21153;&#38656;&#35201;&#35843;&#24230; </P>
<P>&#65288;3&#65289;loop&#30340;&#27425;&#25968;&#23567;&#20110; 10&#27425; </P>
<P>&#22240;&#27492;&#65292;&#21482;&#26377;&#21516;&#26102;&#28385;&#36275;&#19978;&#38754;&#19977;&#20010;&#26465;&#20214;&#65292;&#31243;&#24207;&#25165;&#20250;&#36339;&#36716;&#21040;restart&#37027;&#37324;&#37325;&#26032;&#22788;&#29702;soft irq&#12290;&#21542;&#21017;wakeup_softirqd&#23601;OK&#20102;&#12290;&#36825;&#26679;&#30340;&#35774;&#35745;&#20063;&#26159;&#19968;&#20010;&#24179;&#34913;&#30340;&#26041;&#26696;&#12290;&#19968;&#26041;&#38754;&#29031;&#39038;&#20102;&#35843;&#24230;&#24310;&#36831;&#65306;&#26412;&#26469;&#65292;&#21457;&#29983;&#19968;&#20010;&#20013;&#26029;&#65292;&#31995;&#32479;&#26399;&#26395;&#22312;&#38480;&#23450;&#30340;&#26102;&#38388;&#20869;&#35843;&#24230;&#26576;&#20010;&#36827;&#31243;&#26469;&#22788;&#29702;&#36825;&#20010;&#20013;&#26029;&#65292;&#22914;&#26524;softirq handler&#19981;&#26029;&#35302;&#21457;&#65292;&#20854;&#23454;linux kernel&#26159;&#26080;&#27861;&#20445;&#35777;&#35843;&#24230;&#24310;&#36831;&#26102;&#38388;&#30340;&#12290;&#21478;&#22806;&#19968;&#26041;&#38754;&#65292;&#20063;&#29031;&#39038;&#20102;&#30828;&#20214;&#30340;thoughput&#65306;&#24050;&#32463;&#39044;&#30041;&#20102;&#19968;&#23450;&#30340;&#26102;&#38388;&#26469;&#22788;&#29702;softirq&#12290;