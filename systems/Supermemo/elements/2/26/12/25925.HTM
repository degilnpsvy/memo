<H2>Linux kernel&#20013;&#26029;&#23376;&#31995;&#32479;&#20043;&#65288;&#20116;&#65289;&#65306;&#39537;&#21160;&#30003;&#35831;&#20013;&#26029;API</H2>
<P class=date>&#20316;&#32773;&#65306;<A href="http://www.wowotech.net/author/3">linuxer</A> &#21457;&#24067;&#20110;&#65306;2014-9-22 18:33 &#20998;&#31867;&#65306;<A href="http://www.wowotech.net/sort/irq_subsystem">&#20013;&#26029;&#23376;&#31995;&#32479;</A> </P>
<P>&#19968;&#12289;&#21069;&#35328; </P>
<P>&#26412;&#25991;&#20027;&#35201;&#30340;&#35758;&#39064;&#26159;&#20316;&#20026;&#19968;&#20010;&#26222;&#36890;&#30340;&#39537;&#21160;&#24037;&#31243;&#24072;&#65292;&#22312;&#25776;&#20889;&#33258;&#24049;&#36127;&#36131;&#30340;&#39537;&#21160;&#30340;&#26102;&#20505;&#65292;&#22914;&#20309;&#21521;Linux Kernel&#20013;&#30340;&#20013;&#26029;&#23376;&#31995;&#32479;&#27880;&#20876;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#65311;&#20026;&#20102;&#29702;&#35299;&#27880;&#20876;&#20013;&#26029;&#30340;&#25509;&#21475;&#65292;&#24517;&#39035;&#20102;&#35299;&#19968;&#20123;&#20013;&#26029;&#32447;&#31243;&#21270;&#65288;threaded interrupt handler&#65289;&#30340;&#22522;&#30784;&#30693;&#35782;&#65292;&#36825;&#20123;&#22312;&#31532;&#20108;&#31456;&#25551;&#36848;&#12290;&#31532;&#19977;&#31456;&#20027;&#35201;&#25551;&#36848;&#20102;&#39537;&#21160;&#30003;&#35831; interrupt line&#25509;&#21475;API request_threaded_irq&#30340;&#35268;&#26684;&#12290;&#31532;&#22235;&#31456;&#26159;&#36827;&#20837;request_threaded_irq&#30340;&#23454;&#29616;&#32454;&#33410;&#65292;&#20998;&#26512;&#25972;&#20010;&#20195;&#30721;&#30340;&#25191;&#34892;&#36807;&#31243;&#12290; </P>
<P>&nbsp; </P>
<P>&#20108;&#12289;&#21644;&#20013;&#26029;&#30456;&#20851;&#30340;linux&#23454;&#26102;&#24615;&#20998;&#26512;&#20197;&#21450;&#20013;&#26029;&#32447;&#31243;&#21270;&#30340;&#32972;&#26223;&#20171;&#32461; </P>
<P>1&#12289;&#38750;&#25250;&#21344;&#24335;linux&#20869;&#26680;&#30340;&#23454;&#26102;&#24615; </P>
<P>&#22312;&#36965;&#36828;&#30340;&#36807;&#21435;&#65292;linux2.4&#20043;&#21069;&#30340;&#20869;&#26680;&#26159;&#19981;&#25903;&#25345;&#25250;&#21344;&#29305;&#24615;&#30340;&#65292;&#20855;&#20307;&#21487;&#20197;&#21442;&#32771;&#19979;&#22270;&#65306; </P>
<P><A href="http://www.wowotech.net/content/uploadfile/201409/e31cc1446eefc8742e5f01648fadba8a20140922103324.gif"><IMG title=sxw style="BORDER-LEFT-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px" border=0 alt=sxw src="http://www.wowotech.net/content/uploadfile/201409/89cc8133ade45f46ce400d3d2d74ce6f20140922103326.gif" width=670 height=771></A> </P>
<P>&#20107;&#24773;&#30340;&#24320;&#22987;&#28304;&#33258;&#39640;&#20248;&#20808;&#32423;&#20219;&#21153;&#65288;&#27224;&#33394;block&#65289;&#30001;&#20110;&#35201;&#31561;&#24453;&#22806;&#37096;&#20107;&#20214;&#65288;&#20363;&#22914;&#32593;&#32476;&#25968;&#25454;&#65289;&#32780;&#36827;&#20837;&#30561;&#30496;&#65292;&#35843;&#24230;&#22120;&#35843;&#24230;&#20102;&#26576;&#20010;&#20302;&#20248;&#20808;&#32423;&#30340;&#20219;&#21153;&#65288;&#32043;&#33394;block&#65289;&#25191;&#34892;&#12290;&#35813;&#20302;&#20248;&#20808;&#32423;&#20219;&#21153;&#27426;&#30021;&#30340;&#25191;&#34892;&#65292;&#30452;&#21040;&#35302;&#21457;&#20102;&#19968;&#27425;&#31995;&#32479;&#35843;&#29992;&#65288;&#20363;&#22914;&#36890;&#36807;read()&#25991;&#20214;&#25509;&#21475;&#35835;&#21462;&#30913;&#30424;&#19978;&#30340;&#25991;&#20214;&#31561;&#65289;&#32780;&#36827;&#20837;&#20102;&#20869;&#26680;&#24577;&#12290;&#20173;&#28982;&#26159;&#29087;&#24713;&#30340;&#37197;&#26041;&#65292;&#20173;&#28982;&#26159;&#29087;&#24713;&#30340;&#21619;&#36947;&#65292;&#20302;&#20248;&#20808;&#32423;&#20219;&#21153;&#27491;&#22312;&#25191;&#34892;&#19981;&#20250;&#21464;&#21270;&#65292;&#21482;&#19981;&#36807;&#20174;user space&#20999;&#25442;&#21040;&#20102;kernel space&#12290;&#22806;&#37096;&#20107;&#20214;&#24635;&#26159;&#22312;&#20320;&#19981;&#24819;&#35753;&#23427;&#26469;&#30340;&#26102;&#20505;&#21040;&#26469;&#65292;T0&#26102;&#21051;&#65292;&#39640;&#20248;&#20808;&#32423;&#20219;&#21153;&#31561;&#24453;&#30340;&#37027;&#20010;&#20013;&#26029;&#20107;&#20214;&#21457;&#29983;&#20102;&#12290; </P>
<P>&#20013;&#26029;&#34429;&#28982;&#21457;&#29983;&#20102;&#65292;&#20294;&#36719;&#20214;&#19981;&#19968;&#23450;&#31435;&#21051;&#21709;&#24212;&#65292;&#21487;&#33021;&#30001;&#20110;&#22312;&#20869;&#26680;&#24577;&#25191;&#34892;&#30340;&#26576;&#20123;&#25805;&#20316;&#19981;&#24076;&#26395;&#34987;&#22806;&#37096;&#20107;&#20214;&#25171;&#26029;&#32780;&#20027;&#21160;&#20851;&#38381;&#20102;&#20013;&#26029;&#65288;&#25110;&#26159;&#20851;&#38381;&#20102;CPU&#30340;&#20013;&#26029;&#65292;&#25110;&#32773;MASK&#20102;&#35813;IRQ number&#65289;&#65292;&#36825;&#26102;&#20505;&#65292;&#20013;&#26029;&#20449;&#21495;&#27809;&#26377;&#31435;&#21051;&#24471;&#21040;&#21709;&#24212;&#65292;&#36719;&#20214;&#20173;&#28982;&#22312;&#20869;&#26680;&#24577;&#25191;&#34892;&#20302;&#20248;&#20808;&#32423;&#20219;&#21153;&#31995;&#32479;&#35843;&#29992;&#30340;&#20195;&#30721;&#12290;&#22312;T1&#26102;&#21051;&#65292;&#20869;&#26680;&#24577;&#20195;&#30721;&#30001;&#20110;&#36864;&#20986;&#20020;&#30028;&#21306;&#32780;&#25171;&#24320;&#20013;&#26029;&#65288;&#27880;&#24847;&#65306;&#19978;&#22270;&#20013;&#30340;&#27604;&#20363;&#26159;&#19981;&#21327;&#35843;&#30340;&#65292;&#19968;&#33324;&#32780;&#35328;&#65292;linux kernel&#19981;&#20250;&#26377;&#37027;&#20040;&#38271;&#30340;&#20851;&#20013;&#26029;&#26102;&#38388;&#65292;&#19978;&#38754;&#20027;&#35201;&#26159;&#20026;&#20102;&#34920;&#31034;&#28165;&#26970;&#65292;&#21516;&#29702;&#65292;&#20174;&#20013;&#26029;&#35302;&#21457;&#21040;&#20855;&#20307;&#20013;&#26029;&#26381;&#21153;&#31243;&#24207;&#30340;&#25191;&#34892;&#20063;&#27809;&#26377;&#37027;&#20040;&#38271;&#65292;&#37117;&#26159;&#20026;&#20102;&#34920;&#36848;&#28165;&#26970;&#65289;&#65292;&#20013;&#26029;&#19968;&#26086;&#25171;&#24320;&#65292;&#31435;&#21051;&#36339;&#36716;&#21040;&#20102;&#24322;&#24120;&#21521;&#37327;&#22320;&#22336;&#65292;interrupt handler&#25250;&#21344;&#20102;&#20302;&#20248;&#20808;&#32423;&#20219;&#21153;&#30340;&#25191;&#34892;&#65292;&#36827;&#20837;&#20013;&#26029;&#19978;&#19979;&#25991;&#65288;&#34429;&#28982;&#36825;&#26102;&#20505;&#30340;current task&#26159;&#20302;&#20248;&#20808;&#32423;&#20219;&#21153;&#65292;&#20294;&#26159;&#20013;&#26029;&#19978;&#19979;&#25991;&#21644;&#23427;&#27809;&#26377;&#20219;&#20309;&#20851;&#31995;&#65289;&#12290; </P>
<P>&#20174;CPU&#24320;&#22987;&#22788;&#29702;&#20013;&#26029;&#21040;&#20855;&#20307;&#20013;&#26029;&#26381;&#21153;&#31243;&#24207;&#34987;&#25191;&#34892;&#36824;&#38656;&#35201;&#19968;&#20010;&#20998;&#21457;&#30340;&#36807;&#31243;&#12290;&#36825;&#20010;&#26399;&#38388;&#31995;&#32479;&#35201;&#20570;&#30340;&#20027;&#35201;&#25805;&#20316;&#21253;&#25324;&#30830;&#23450;HW interrupt ID&#65292;&#30830;&#23450;IRQ Number&#65292;ack&#25110;&#32773;mask&#20013;&#26029;&#65292;&#35843;&#29992;&#20013;&#26029;&#26381;&#21153;&#31243;&#24207;&#31561;&#12290;T0&#21040;T2&#20043;&#38388;&#30340;delay&#34987;&#31216;&#20026;&#20013;&#26029;&#24310;&#36831;&#65288;Interrupt Latency&#65289;&#65292;&#20027;&#35201;&#21253;&#25324;&#20004;&#37096;&#20998;&#65292;&#19968;&#37096;&#20998;&#26159;HW&#36896;&#25104;&#30340;delay&#65288;&#30828;&#20214;&#30340;&#20013;&#26029;&#31995;&#32479;&#35782;&#21035;&#22806;&#37096;&#30340;&#20013;&#26029;&#20107;&#20214;&#24182;signal&#21040;CPU&#65289;&#65292;&#21478;&#22806;&#19968;&#37096;&#20998;&#26159;&#36719;&#20214;&#21407;&#22240;&#65288;&#20869;&#26680;&#20195;&#30721;&#20013;&#30001;&#20110;&#35201;&#20445;&#25252;&#20020;&#30028;&#21306;&#32780;&#20851;&#38381;&#20013;&#26029;&#24341;&#36215;&#30340;&#65289;&#12290; </P>
<P>&#35813;&#20013;&#26029;&#30340;&#26381;&#21153;&#31243;&#24207;&#25191;&#34892;&#23436;&#27605;&#65288;&#22312;&#20854;&#25191;&#34892;&#36807;&#31243;&#20013;&#65292;T3&#26102;&#21051;&#65292;&#20250;&#21796;&#37266;&#39640;&#20248;&#20808;&#32423;&#20219;&#21153;&#65292;&#35753;&#23427;&#20174;sleep&#29366;&#24577;&#36827;&#20837;runable&#29366;&#24577;&#65289;&#65292;&#36820;&#22238;&#20302;&#20248;&#20808;&#32423;&#20219;&#21153;&#30340;&#31995;&#32479;&#35843;&#29992;&#29616;&#22330;&#65292;&#36825;&#26102;&#20505;&#24182;&#19981;&#23384;&#22312;&#19968;&#20010;&#25250;&#21344;&#28857;&#65292;&#20302;&#20248;&#20808;&#32423;&#20219;&#21153;&#35201;&#23436;&#25104;&#31995;&#32479;&#35843;&#29992;&#20043;&#21518;&#65292;&#22312;&#36820;&#22238;&#29992;&#25143;&#31354;&#38388;&#30340;&#26102;&#20505;&#25165;&#20986;&#29616;&#25250;&#21344;&#28857;&#12290;&#28459;&#38271;&#30340;&#31561;&#24453;&#20043;&#21518;&#65292;T4&#26102;&#21051;&#65292;&#35843;&#24230;&#22120;&#35843;&#24230;&#39640;&#20248;&#20808;&#32423;&#20219;&#21153;&#25191;&#34892;&#12290;&#26377;&#19968;&#20010;&#26415;&#35821;&#21483;&#20570;&#20219;&#21153;&#21709;&#24212;&#26102;&#38388;&#65288;Task Response Time&#65289;&#29992;&#26469;&#25551;&#36848;T3&#21040;T4&#20043;&#38388;&#30340;delay&#12290; </P>
<P>&nbsp; </P>
<P>2&#12289;&#25250;&#21344;&#24335;linux&#20869;&#26680;&#30340;&#23454;&#26102;&#24615; </P>
<P>2.6&#20869;&#26680;&#21644;2.4&#20869;&#26680;&#26174;&#33879;&#30340;&#19981;&#21516;&#26159;&#25552;&#20379;&#20102;&#19968;&#20010;CONFIG_PREEMPT&#30340;&#36873;&#39033;&#65292;&#25171;&#24320;&#35813;&#36873;&#39033;&#21518;&#65292;linux kernel&#23601;&#25903;&#25345;&#20102;&#20869;&#26680;&#20195;&#30721;&#30340;&#25250;&#21344;&#65288;&#24403;&#28982;&#19981;&#33021;&#22312;&#20020;&#30028;&#21306;&#65289;&#65292;&#20854;&#34892;&#20026;&#22914;&#19979;&#65306; </P>
<P><A href="http://www.wowotech.net/content/uploadfile/201409/ed95106e2c04e02b2ba84fe038d70f2220140922103327.gif"><IMG title=pre style="BORDER-LEFT-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px" border=0 alt=pre src="http://www.wowotech.net/content/uploadfile/201409/5d3893a4997db31f1bcbec9c8446b98020140922103329.gif" width=671 height=610></A> </P>
<P>T0&#21040;T3&#30340;&#25805;&#20316;&#37117;&#26159;&#21644;&#19978;&#19968;&#33410;&#30340;&#25551;&#36848;&#19968;&#26679;&#30340;&#65292;&#19981;&#21516;&#30340;&#22320;&#26041;&#26159;&#22312;T4&#12290;&#23545;&#20110;2.4&#20869;&#26680;&#65292;&#21482;&#26377;&#36820;&#22238;&#29992;&#25143;&#31354;&#38388;&#30340;&#26102;&#20505;&#25165;&#26377;&#25250;&#21344;&#28857;&#20986;&#29616;&#65292;&#20294;&#26159;&#23545;&#20110;&#25250;&#21344;&#24335;&#20869;&#26680;&#32780;&#35328;&#65292;&#21363;&#20415;&#26159;&#20174;&#20013;&#26029;&#19978;&#19979;&#25991;&#36820;&#22238;&#20869;&#26680;&#31354;&#38388;&#30340;&#36827;&#31243;&#19978;&#19979;&#25991;&#65292;&#21482;&#35201;&#20869;&#26680;&#20195;&#30721;&#19981;&#22312;&#20020;&#30028;&#21306;&#20869;&#65292;&#23601;&#21487;&#20197;&#21457;&#29983;&#35843;&#24230;&#65292;&#35753;&#26368;&#39640;&#20248;&#20808;&#32423;&#30340;&#20219;&#21153;&#35843;&#24230;&#25191;&#34892;&#12290; </P>
<P>&#22312;&#38750;&#25250;&#21344;&#24335;linux&#20869;&#26680;&#20013;&#65292;&#19968;&#20010;&#20219;&#21153;&#30340;&#20869;&#26680;&#24577;&#26159;&#19981;&#21487;&#20197;&#34987;&#20854;&#20182;&#36827;&#31243;&#25250;&#21344;&#30340;&#12290;&#36825;&#37324;&#24182;&#19981;&#26159;&#35828;kernel space&#19981;&#21487;&#20197;&#34987;&#25250;&#21344;&#65292;&#21482;&#26159;&#35828;&#36827;&#31243;&#36890;&#36807;&#31995;&#32479;&#35843;&#29992;&#38519;&#20837;&#21040;&#20869;&#26680;&#30340;&#26102;&#20505;&#65292;&#19981;&#21487;&#20197;&#34987;&#20854;&#20182;&#30340;&#36827;&#31243;&#25250;&#21344;&#12290;&#23454;&#38469;&#19978;&#65292;&#20013;&#26029;&#19978;&#19979;&#25991;&#24403;&#28982;&#21487;&#20197;&#25250;&#21344;&#36827;&#31243;&#19978;&#19979;&#25991;&#65288;&#26080;&#35770;&#26159;&#20869;&#26680;&#24577;&#36824;&#26159;&#29992;&#25143;&#24577;&#65289;&#65292;&#26356;&#36827;&#19968;&#27493;&#65292;&#20013;&#26029;&#19978;&#19979;&#25991;&#26159;&#25317;&#26377;&#33267;&#39640;&#26080;&#19978;&#30340;&#26435;&#38480;&#65292;&#23427;&#29978;&#33267;&#21487;&#20197;&#25250;&#21344;&#20854;&#20182;&#30340;&#20013;&#26029;&#19978;&#19979;&#25991;&#12290;&#24341;&#20837;&#25250;&#21344;&#24335;&#20869;&#26680;&#21518;&#65292;&#31995;&#32479;&#30340;&#24179;&#22343;&#20219;&#21153;&#21709;&#24212;&#26102;&#38388;&#20250;&#32553;&#30701;&#65292;&#20294;&#26159;&#65292;&#23454;&#26102;&#24615;&#26356;&#20851;&#27880;&#30340;&#26159;&#65306;&#26080;&#35770;&#22312;&#20219;&#20309;&#30340;&#36127;&#36733;&#24773;&#20917;&#19979;&#65292;&#20219;&#21153;&#21709;&#24212;&#26102;&#38388;&#26159;&#30830;&#23450;&#30340;&#12290;&#22240;&#27492;&#65292;&#26356;&#38656;&#35201;&#20851;&#27880;&#30340;&#26159;worst-case&#30340;&#20219;&#21153;&#21709;&#24212;&#26102;&#38388;&#12290;&#36825;&#37324;&#26377;&#20004;&#20010;&#22240;&#32032;&#20250;&#24433;&#21709;worst case latency&#65306; </P>
<P>&#65288;1&#65289;&#20026;&#20102;&#21516;&#27493;&#65292;&#20869;&#26680;&#20013;&#24635;&#26377;&#20123;&#20195;&#30721;&#38656;&#35201;&#25345;&#26377;&#33258;&#26059;&#38145;&#36164;&#28304;&#65292;&#25110;&#32773;&#26174;&#24335;&#30340;&#35843;&#29992;preempt_disable&#26469;&#31105;&#27490;&#25250;&#21344;&#65292;&#36825;&#26102;&#20505;&#19981;&#20801;&#35768;&#25250;&#21344; </P>
<P>&#65288;2&#65289;&#20013;&#26029;&#19978;&#19979;&#25991;&#65288;&#24182;&#38750;&#21482;&#26159;&#20013;&#26029;handler&#65292;&#36824;&#21253;&#25324;softirq&#12289;timer&#12289;tasklet&#65289;&#24635;&#26159;&#21487;&#20197;&#25250;&#21344;&#36827;&#31243;&#19978;&#19979;&#25991; </P>
<P>&#22240;&#27492;&#65292;&#21363;&#20415;&#26159;&#25171;&#24320;&#20102;PREEMPT&#30340;&#36873;&#39033;&#65292;&#23454;&#38469;&#19978;linux&#31995;&#32479;&#30340;&#20219;&#21153;&#21709;&#24212;&#26102;&#38388;&#20173;&#28982;&#26159;&#19981;&#30830;&#23450;&#30340;&#12290;&#19968;&#26041;&#38754;&#20869;&#26680;&#20195;&#30721;&#30340;&#20020;&#30028;&#21306;&#38750;&#24120;&#22810;&#65292;&#25105;&#20204;&#38656;&#35201;&#25214;&#21040;&#65292;&#31995;&#32479;&#20013;&#25345;&#26377;&#38145;&#65292;&#25110;&#32773;&#31105;&#27490;&#25250;&#21344;&#30340;&#26368;&#22823;&#30340;&#26102;&#38388;&#29255;&#12290;&#21478;&#22806;&#19968;&#26041;&#38754;&#65292;&#22312;&#19978;&#22270;&#30340;T4&#20013;&#65292;&#33021;&#39034;&#21033;&#30340;&#35843;&#24230;&#39640;&#20248;&#20808;&#32423;&#20219;&#21153;&#24182;&#38750;&#26131;&#20107;&#65292;&#36825;&#26102;&#20505;&#21487;&#33021;&#26377;&#35302;&#21457;&#30340;&#36719;&#20013;&#26029;&#65292;&#20063;&#21487;&#33021;&#26377;&#26032;&#26469;&#30340;&#20013;&#26029;&#65292;&#20063;&#21487;&#33021;&#26576;&#20123;driver&#30340;tasklet&#35201;&#25191;&#34892;&#65292;&#21482;&#26377;&#22312;&#27809;&#26377;&#20219;&#20309;bottom half&#30340;&#20219;&#21153;&#35201;&#25191;&#34892;&#30340;&#26102;&#20505;&#65292;&#35843;&#24230;&#22120;&#25165;&#20250;&#21551;&#21160;&#35843;&#24230;&#12290; </P>
<P>3&#12289;&#36827;&#19968;&#27493;&#25552;&#39640;linux&#20869;&#26680;&#30340;&#23454;&#26102;&#24615; </P>
<P>&#36890;&#36807;&#19978;&#19968;&#20010;&#23567;&#33410;&#30340;&#25551;&#36848;&#65292;&#30456;&#20449;&#22823;&#23478;&#37117;&#30830;&#20449;&#20013;&#26029;&#23545;linux &#23454;&#26102;&#24615;&#30340;&#26368;&#22823;&#30340;&#25932;&#20154;&#12290;&#37027;&#20040;&#24590;&#20040;&#30772;&#65311;&#25105;&#26366;&#32463;&#25509;&#35302;&#36807;&#19968;&#27454;RTOS&#65292;&#23427;&#30340;&#20013;&#26029;handler&#38750;&#24120;&#31616;&#21333;&#65292;&#23601;&#26159;&#21457;&#36865;&#19968;&#20010;inter-task message&#21040;&#35813;driver thread&#65292;&#23545;&#20219;&#20309;&#30340;&#19968;&#20010;&#39537;&#21160;&#37117;&#26159;&#22914;&#27492;&#22788;&#29702;&#12290;&#36825;&#26679;&#65292;&#27599;&#20010;&#20013;&#26029;&#19978;&#19979;&#25991;&#37117;&#21464;&#24471;&#38750;&#24120;&#31616;&#30701;&#65292;&#32780;&#19988;&#27599;&#20010;&#20013;&#26029;&#37117;&#26159;&#19968;&#33268;&#30340;&#12290;&#22312;&#36825;&#26679;&#30340;&#35774;&#35745;&#20013;&#65292;&#22806;&#35774;&#20013;&#26029;&#30340;&#22788;&#29702;&#32447;&#31243;&#21270;&#20102;&#65292;&#28982;&#21518;&#65292;&#31995;&#32479;&#35774;&#35745;&#24072;&#35201;&#20180;&#32454;&#30340;&#20026;&#27599;&#20010;&#31995;&#32479;&#20013;&#30340;task&#20998;&#37197;&#20248;&#20808;&#32423;&#65292;&#30830;&#20445;&#25972;&#20010;&#31995;&#32479;&#30340;&#23454;&#26102;&#24615;&#12290; </P>
<P>&#22312;Linux kernel&#20013;&#65292;&#19968;&#20010;&#22806;&#35774;&#30340;&#20013;&#26029;&#22788;&#29702;&#34987;&#20998;&#25104;top half&#21644;bottom half&#65292;top half&#36827;&#34892;&#26368;&#20851;&#38190;&#65292;&#26368;&#22522;&#26412;&#30340;&#22788;&#29702;&#65292;&#32780;&#27604;&#36739;&#32791;&#26102;&#30340;&#25805;&#20316;&#34987;&#25918;&#21040;bottom half&#65288;softirq&#12289;tasklet&#65289;&#20013;&#24310;&#36831;&#25191;&#34892;&#12290;&#34429;&#28982;bottom half&#34987;&#24310;&#36831;&#25191;&#34892;&#65292;&#20294;&#22987;&#32456;&#37117;&#26159;&#20808;&#20110;&#36827;&#31243;&#25191;&#34892;&#30340;&#12290;&#20026;&#20309;&#19981;&#35753;&#36825;&#20123;&#32791;&#26102;&#30340;bottom half&#21644;&#26222;&#36890;&#36827;&#31243;&#20844;&#24179;&#31454;&#20105;&#21602;&#65311;&#22240;&#27492;&#65292;linux kernel&#20511;&#37492;&#20102;RTOS&#30340;&#26576;&#20123;&#29305;&#24615;&#65292;&#23545;&#37027;&#20123;&#32791;&#26102;&#30340;&#39537;&#21160;interrupt handler&#36827;&#34892;&#32447;&#31243;&#21270;&#22788;&#29702;&#65292;&#22312;&#20869;&#26680;&#30340;&#25250;&#21344;&#28857;&#19978;&#65292;&#35753;&#32447;&#31243;&#65288;&#26080;&#35770;&#26159;&#20869;&#26680;&#32447;&#31243;&#36824;&#26159;&#29992;&#25143;&#31354;&#38388;&#21019;&#24314;&#30340;&#32447;&#31243;&#65292;&#36824;&#26159;&#39537;&#21160;&#30340;interrupt thread&#65289;&#22312;&#19968;&#20010;&#33310;&#21488;&#19978;&#31454;&#20105;CPU&#12290; </P>
<P>&nbsp; </P>
<P>&#19977;&#12289;request_threaded_irq&#30340;&#25509;&#21475;&#35268;&#26684; </P>
<P>1&#12289;&#36755;&#20837;&#21442;&#25968;&#25551;&#36848; </P>
<TABLE class=ke-zeroborder cellSpacing=0 cellPadding=2 width=700 border=0>
<TBODY>
<TR>
<TD vAlign=top width=152>&#36755;&#20837;&#21442;&#25968; </TD>
<TD vAlign=top width=548>&#25551;&#36848; </TD></TR>
<TR>
<TD vAlign=top width=152>irq </TD>
<TD vAlign=top width=548>&#35201;&#27880;&#20876;handler&#30340;&#37027;&#20010;IRQ number&#12290;&#36825;&#37324;&#35201;&#27880;&#20876;&#30340;handler&#21253;&#25324;&#20004;&#20010;&#65292;&#19968;&#20010;&#26159;&#20256;&#32479;&#24847;&#20041;&#30340;&#20013;&#26029;handler&#65292;&#25105;&#20204;&#31216;&#20043;primary handler&#65292;&#21478;&#22806;&#19968;&#20010;&#26159;threaded interrupt handler </TD></TR>
<TR>
<TD vAlign=top width=152>handler </TD>
<TD vAlign=top width=548>primary handler&#12290;&#38656;&#35201;&#27880;&#24847;&#30340;&#26159;primary handler&#21644;threaded interrupt handler&#19981;&#33021;&#21516;&#26102;&#20026;&#31354;&#65292;&#21542;&#21017;&#20250;&#20986;&#38169; </TD></TR>
<TR>
<TD vAlign=top width=152>thread_fn </TD>
<TD vAlign=top width=548>threaded interrupt handler&#12290;&#22914;&#26524;&#35813;&#21442;&#25968;&#19981;&#26159;NULL&#65292;&#37027;&#20040;&#31995;&#32479;&#20250;&#21019;&#24314;&#19968;&#20010;kernel thread&#65292;&#35843;&#29992;&#30340;function&#23601;&#26159;thread_fn </TD></TR>
<TR>
<TD vAlign=top width=152>irqflags </TD>
<TD vAlign=top width=548>&#21442;&#35265;&#26412;&#31456;&#31532;&#19977;&#33410; </TD></TR>
<TR>
<TD vAlign=top width=152>devname </TD>
<TD vAlign=top width=548>&nbsp; </TD></TR>
<TR>
<TD vAlign=top width=152>dev_id </TD>
<TD vAlign=top width=548>&#21442;&#35265;&#31532;&#22235;&#31456;&#65292;&#31532;&#19968;&#33410;&#20013;&#30340;&#25551;&#36848;&#12290; </TD></TR></TBODY></TABLE>
<P>2&#12289;&#36755;&#20986;&#21442;&#25968;&#25551;&#36848; </P>
<P>0&#34920;&#31034;&#25104;&#21151;&#25191;&#34892;&#65292;&#36127;&#25968;&#34920;&#31034;&#21508;&#31181;&#38169;&#35823;&#21407;&#22240;&#12290; </P>
<P>3&#12289;Interrupt type flags </P>
<TABLE class=ke-zeroborder cellSpacing=0 cellPadding=2 width=700 border=0>
<TBODY>
<TR>
<TD vAlign=top width=151>flag&#23450;&#20041; </TD>
<TD vAlign=top width=549>&#25551;&#36848; </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_TRIGGER_XXX </TD>
<TD vAlign=top width=549>&#25551;&#36848;&#35813;interrupt line&#35302;&#21457;&#31867;&#22411;&#30340;flag </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_DISABLED </TD>
<TD vAlign=top width=549>&#39318;&#20808;&#35201;&#35828;&#26126;&#30340;&#26159;&#36825;&#26159;&#19968;&#20010;&#24223;&#24323;&#30340;flag&#65292;&#22312;&#26032;&#30340;&#20869;&#26680;&#20013;&#65292;&#35813;flag&#27809;&#26377;&#20219;&#20309;&#30340;&#20316;&#29992;&#20102;&#12290;&#20855;&#20307;&#21487;&#20197;&#21442;&#32771;&#65306;<A title=http://lwn.net/Articles/380931/ href="http://lwn.net/Articles/380931/">Disabling IRQF_DISABLED</A> <BR>&#26087;&#30340;&#20869;&#26680;&#65288;2.6.35&#29256;&#26412;&#20043;&#21069;&#65289;&#35748;&#20026;&#26377;&#20004;&#31181;interrupt handler&#65306;slow handler&#21644;fast handle&#12290;&#22312;request irq&#30340;&#26102;&#20505;&#65292;&#23545;&#20110;fast handler&#65292;&#38656;&#35201;&#20256;&#36882;IRQF_DISABLED&#30340;&#21442;&#25968;&#65292;&#30830;&#20445;&#20854;&#20013;&#26029;&#22788;&#29702;&#36807;&#31243;&#20013;&#26159;&#20851;&#38381;CPU&#30340;&#20013;&#26029;&#65292;&#22240;&#20026;&#26159;fast handler&#65292;&#25191;&#34892;&#24456;&#24555;&#65292;&#21363;&#20415;&#26159;&#20851;&#38381;CPU&#20013;&#26029;&#19981;&#20250;&#24433;&#21709;&#31995;&#32479;&#30340;&#24615;&#33021;&#12290;&#20294;&#26159;&#65292;&#24182;&#19981;&#26159;&#27599;&#19968;&#31181;&#22806;&#35774;&#20013;&#26029;&#30340;handler&#37117;&#26159;&#37027;&#20040;&#24555;&#65288;&#20363;&#22914;&#30913;&#30424;&#65289;&#65292;&#22240;&#27492;&#23601;&#26377; slow handler&#30340;&#27010;&#24565;&#65292;&#35828;&#26126;&#20854;&#22312;&#20013;&#26029;&#22788;&#29702;&#36807;&#31243;&#20013;&#20250;&#32791;&#26102;&#27604;&#36739;&#38271;&#12290;&#23545;&#20110;&#36825;&#31181;&#24773;&#20917;&#65292;&#22312;&#25191;&#34892;interrupt handler&#30340;&#26102;&#20505;&#19981;&#33021;&#20851;&#38381;CPU&#20013;&#26029;&#65292;&#21542;&#21017;&#23545;&#31995;&#32479;&#30340;performance&#20250;&#26377;&#24433;&#21709;&#12290; <BR>&#26032;&#30340;&#20869;&#26680;&#24050;&#32463;&#19981;&#21306;&#20998;slow handler&#21644;fast handle&#65292;&#37117;&#26159;fast handler&#65292;&#37117;&#26159;&#38656;&#35201;&#20851;&#38381;CPU&#20013;&#26029;&#30340;&#65292;&#37027;&#20123;&#38656;&#35201;&#21518;&#32493;&#22788;&#29702;&#30340;&#20869;&#23481;&#25512;&#21040;threaded interrupt handler&#20013;&#21435;&#25191;&#34892;&#12290; </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_SHARED </TD>
<TD vAlign=top width=549>
<P>&#36825;&#26159;flag&#29992;&#26469;&#25551;&#36848;&#19968;&#20010;interrupt line&#26159;&#21542;&#20801;&#35768;&#22312;&#22810;&#20010;&#35774;&#22791;&#20013;&#20849;&#20139;&#12290;&#22914;&#26524;&#20013;&#26029;&#25511;&#21046;&#22120;&#21487;&#20197;&#25903;&#25345;&#36275;&#22815;&#22810;&#30340;interrupt source&#65292;&#37027;&#20040;&#22312;&#20004;&#20010;&#22806;&#35774;&#38388;&#20849;&#20139;&#19968;&#20010;interrupt request line&#26159;&#19981;&#25512;&#33616;&#30340;&#65292;&#27605;&#31455;&#26377;&#19968;&#20123;&#39069;&#22806;&#30340;&#24320;&#38144;&#65288;&#21457;&#29983;&#20013;&#26029;&#30340;&#26102;&#20505;&#35201;&#36880;&#20010;&#35810;&#38382;&#26159;&#19981;&#26159;&#20320;&#30340;&#20013;&#26029;&#65292;&#36719;&#20214;&#19978;&#23601;&#26159;&#36941;&#21382;action list&#65289;&#65292;&#22240;&#27492;&#22806;&#35774;&#30340;irq handler&#20013;&#26368;&#22909;&#26159;&#19968;&#24320;&#22987;&#23601;&#21551;&#21160;&#21028;&#26029;&#65292;&#30475;&#30475;&#26159;&#21542;&#26159;&#33258;&#24049;&#30340;&#20013;&#26029;&#65292;&#22914;&#26524;&#19981;&#26159;&#65292;&#36820;&#22238;IRQ_NONE,&#34920;&#31034;&#36825;&#20010;&#20013;&#26029;&#19981;&#24402;&#25105;&#31649;&#12290; &#26089;&#26399;PC&#26102;&#20195;&#65292;&#20351;&#29992;8259&#20013;&#26029;&#25511;&#21046;&#22120;&#65292;&#32423;&#32852;&#30340;8259&#26368;&#22810;&#25903;&#25345;15&#20010;&#22806;&#37096;&#20013;&#26029;&#65292;&#20294;&#26159;PC&#22806;&#35774;&#37027;&#20040;&#22810;&#65292;&#22240;&#27492;&#38656;&#35201;irq share&#12290;&#29616;&#22312;&#65292;ARM&#24179;&#21488;&#19978;&#30340;&#31995;&#32479;&#35774;&#35745;&#24456;&#23569;&#20250;&#37319;&#29992;&#22806;&#35774;&#20849;&#20139;IRQ&#26041;&#24335;&#65292;&#27605;&#31455;&#19968;&#33324;ARM SOC&#25552;&#20379;&#30340;&#26377;&#20013;&#26029;&#21151;&#33021;&#30340;GPIO&#38750;&#24120;&#30340;&#22810;&#65292;&#36275;&#22815;&#29992;&#30340;&#12290; &#24403;&#28982;&#65292;&#22914;&#26524;&#30830;&#23454;&#38656;&#35201;&#20004;&#20010;&#22806;&#35774;&#20849;&#20139;IRQ&#65292;&#37027;&#20063;&#21482;&#33021;&#22914;&#27492;&#35774;&#35745;&#20102;&#12290;&#23545;&#20110;HW&#65292;&#20013;&#26029;&#25511;&#21046;&#22120;&#30340;&#19968;&#20010;interrupt source&#30340;&#24341;&#33050;&#35201;&#25509;&#21040;&#20004;&#20010;&#22806;&#35774;&#30340;interrupt request line&#19978;&#65292;&#24590;&#20040;&#25509;&#65311;&#30452;&#25509;&#36830;&#25509;&#21487;&#20197;&#21527;&#65311;&#24403;&#28982;&#19981;&#34892;&#65292;&#23545;&#20110;&#20302;&#30005;&#24179;&#35302;&#21457;&#30340;&#24773;&#20917;&#65292;&#25105;&#20204;&#21487;&#20197;&#32771;&#34385;&#29992;&#19982;&#38376;&#36830;&#25509;&#20013;&#26029;&#25511;&#21046;&#22120;&#21644;&#22806;&#35774;&#12290; </P></TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_PROBE_SHARED </TD>
<TD vAlign=top width=549>IRQF_SHARED&#29992;&#26469;&#34920;&#31034;&#35813;interrupt action descriptor&#26159;&#20801;&#35768;&#21644;&#20854;&#20182;device&#20849;&#20139;&#19968;&#20010;interrupt line&#65288;IRQ number&#65289;&#65292;&#20294;&#26159;&#23454;&#38469;&#19978;&#26159;&#21542;&#33021;&#22815;share&#36824;&#26159;&#38656;&#35201;&#20854;&#20182;&#26465;&#20214;&#65306;&#20363;&#22914;&#35302;&#21457;&#26041;&#24335;&#24517;&#39035;&#30456;&#21516;&#12290;&#26377;&#20123;&#39537;&#21160;&#31243;&#24207;&#21487;&#33021;&#26377;&#36825;&#26679;&#30340;&#35843;&#29992;&#22330;&#26223;&#65306;&#25105;&#21482;&#26159;&#24819;scan&#19968;&#20010;irq table&#65292;&#30475;&#30475;&#21738;&#19968;&#20010;&#26159;OK&#30340;&#65292;&#36825;&#26102;&#20505;&#65292;&#22914;&#26524;&#21363;&#20415;&#26159;&#19981;&#33021;&#21644;&#20854;&#20182;&#30340;&#39537;&#21160;&#31243;&#24207;share&#36825;&#20010;interrupt line&#65292;&#25105;&#20063;&#27809;&#26377;&#20851;&#31995;&#65292;&#25105;&#23601;&#26159;&#24819;scan&#30475;&#30475;&#24773;&#20917;&#12290;&#36825;&#26102;&#20505;&#65292;caller&#20854;&#23454;&#21487;&#20197;&#39044;&#35265;sharing mismatche&#30340;&#21457;&#29983;&#65292;&#22240;&#27492;&#65292;&#19981;&#38656;&#35201;&#20869;&#26680;&#25171;&#21360;&#8220;Flags mismatch irq&#8230;&#8230;&#8220;&#36825;&#26679;&#20887;&#20313;&#30340;&#20449;&#24687; </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_PERCPU </TD>
<TD vAlign=top width=549>&#22312;SMP&#30340;&#26550;&#26500;&#19979;&#65292;&#20013;&#26029;&#26377;&#20004;&#31181;mode&#65292;&#19968;&#31181;&#20013;&#26029;&#26159;&#22312;&#25152;&#26377;processor&#20043;&#38388;&#20849;&#20139;&#30340;&#65292;&#20063;&#23601;&#26159;global&#30340;&#65292;&#19968;&#26086;&#20013;&#26029;&#20135;&#29983;&#65292;interrupt controller&#21487;&#20197;&#25226;&#36825;&#20010;&#20013;&#26029;&#36865;&#36798;&#22810;&#20010;&#22788;&#29702;&#22120;&#12290;&#24403;&#28982;&#65292;&#22312;&#20855;&#20307;&#23454;&#29616;&#30340;&#26102;&#20505;&#19981;&#20250;&#21516;&#26102;&#23558;&#20013;&#26029;&#36865;&#36798;&#22810;&#20010;CPU&#65292;&#19968;&#33324;&#26159;&#36719;&#20214;&#21644;&#30828;&#20214;&#21327;&#21516;&#22788;&#29702;&#65292;&#23558;&#20013;&#26029;&#36865;&#36798;&#19968;&#20010;CPU&#22788;&#29702;&#12290;&#20294;&#26159;&#19968;&#27573;&#26102;&#38388;&#20869;&#20135;&#29983;&#30340;&#20013;&#26029;&#21487;&#20197;&#24179;&#22343;&#65288;&#25110;&#32773;&#25353;&#29031;&#26082;&#23450;&#30340;&#31574;&#30053;&#65289;&#20998;&#37197;&#21040;&#19968;&#32452;CPU&#19978;&#12290;&#36825;&#31181;interrupt mode&#19979;&#65292;interrupt controller&#38024;&#23545;&#35813;&#20013;&#26029;&#30340;operational register&#26159;global&#30340;&#65292;&#25152;&#26377;&#30340;CPU&#30475;&#21040;&#30340;&#37117;&#26159;&#19968;&#22871;&#23492;&#23384;&#22120;&#65292;&#19968;&#26086;&#19968;&#20010;CPU ack&#20102;&#35813;&#20013;&#26029;&#65292;&#37027;&#20040;&#20854;&#20182;&#30340;CPU&#30475;&#21040;&#30340;&#35813;interupt source&#30340;&#29366;&#24577;&#20063;&#26159;&#24050;&#32463;ack&#30340;&#29366;&#24577;&#12290; <BR>&#21644;global&#23545;&#24212;&#30340;&#23601;&#26159;per cpu interrupt&#20102;&#65292;&#23545;&#20110;&#36825;&#31181;interrupt&#65292;&#19981;&#26159;processor&#20043;&#38388;&#20849;&#20139;&#30340;&#65292;&#32780;&#26159;&#29305;&#23450;&#23646;&#20110;&#19968;&#20010;CPU&#30340;&#12290;&#20363;&#22914;GIC&#20013;interrupt ID&#31561;&#20110;30&#30340;&#20013;&#26029;&#23601;&#26159;per cpu&#30340;&#65288;&#36825;&#20010;&#20013;&#26029;event&#34987;&#29992;&#20110;&#21508;&#20010;CPU&#30340;local timer&#65289;&#65292;&#36825;&#20010;&#20013;&#26029;&#21495;&#34429;&#28982;&#21482;&#26377;&#19968;&#20010;&#65292;&#20294;&#26159;&#65292;&#23454;&#38469;&#19978;&#25511;&#21046;&#35813;interrupt ID&#30340;&#23492;&#23384;&#22120;&#26377;n&#32452;&#65288;&#22914;&#26524;&#31995;&#32479;&#20013;&#26377;n&#20010;processor&#65289;&#65292;&#27599;&#20010;CPU&#30475;&#21040;&#30340;&#26159;&#19981;&#21516;&#30340;&#25511;&#21046;&#23492;&#23384;&#22120;&#12290;&#22312;&#20855;&#20307;&#23454;&#29616;&#20013;&#65292;&#36825;&#20123;&#23492;&#23384;&#22120;&#32452;&#26377;&#20004;&#31181;&#24418;&#24577;&#65292;&#19968;&#31181;&#26159;banked&#65292;&#25152;&#26377;CPU&#25805;&#20316;&#21516;&#26679;&#30340;&#23492;&#23384;&#22120;&#22320;&#22336;&#65292;&#30828;&#20214;&#31995;&#32479;&#20250;&#26681;&#25454;&#35775;&#38382;&#30340;cpu&#23450;&#21521;&#21040;&#19981;&#21516;&#30340;&#23492;&#23384;&#22120;&#65292;&#21478;&#22806;&#19968;&#31181;&#26159;non banked&#65292;&#20063;&#23601;&#26159;&#35828;&#65292;&#23545;&#20110;&#35813;interrupt source&#65292;&#27599;&#20010;cpu&#37117;&#26377;&#33258;&#24049;&#29420;&#29305;&#30340;&#35775;&#38382;&#22320;&#22336;&#12290; </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_NOBALANCING </TD>
<TD vAlign=top width=549>&#36825;&#20063;&#26159;&#21644;multi-processor&#30456;&#20851;&#30340;&#19968;&#20010;flag&#12290;&#23545;&#20110;&#37027;&#20123;&#21487;&#20197;&#22312;&#22810;&#20010;CPU&#20043;&#38388;&#20849;&#20139;&#30340;&#20013;&#26029;&#65292;&#20855;&#20307;&#36865;&#36798;&#21738;&#19968;&#20010;processor&#26159;&#26377;&#31574;&#30053;&#30340;&#65292;&#25105;&#20204;&#21487;&#20197;&#22312;&#22810;&#20010;CPU&#20043;&#38388;&#36827;&#34892;&#24179;&#34913;&#12290;&#22914;&#26524;&#20320;&#19981;&#24819;&#35753;&#20320;&#30340;&#20013;&#26029;&#21442;&#19982;&#21040;irq balancing&#30340;&#36807;&#31243;&#20013;&#37027;&#20040;&#23601;&#35774;&#23450;&#36825;&#20010;flag </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_IRQPOLL </TD>
<TD vAlign=top width=549>&nbsp; </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_ONESHOT </TD>
<TD vAlign=top width=549>one shot&#26412;&#36523;&#30340;&#24847;&#24605;&#30340;&#21482;&#26377;&#19968;&#27425;&#30340;&#65292;&#32467;&#21512;&#21040;&#20013;&#26029;&#36825;&#20010;&#22330;&#26223;&#65292;&#21017;&#34920;&#31034;&#20013;&#26029;&#26159;&#19968;&#27425;&#24615;&#35302;&#21457;&#30340;&#65292;&#19981;&#33021;&#23884;&#22871;&#12290;&#23545;&#20110;primary handler&#65292;&#24403;&#28982;&#26159;&#19981;&#20250;&#23884;&#22871;&#65292;&#20294;&#26159;&#23545;&#20110;threaded interrupt handler&#65292;&#25105;&#20204;&#26377;&#20004;&#31181;&#36873;&#25321;&#65292;&#19968;&#31181;&#26159;mask&#35813;interrupt source&#65292;&#21478;&#22806;&#19968;&#31181;&#26159;unmask&#35813;interrupt source&#12290;&#19968;&#26086;mask&#20303;&#35813;interrupt source&#65292;&#37027;&#20040;&#35813;interrupt source&#30340;&#20013;&#26029;&#22312;&#25972;&#20010;threaded interrupt handler&#22788;&#29702;&#36807;&#31243;&#20013;&#37117;&#26159;&#19981;&#20250;&#20877;&#27425;&#35302;&#21457;&#30340;&#65292;&#20063;&#23601;&#26159;one shot&#20102;&#12290;&#36825;&#31181;handler&#19981;&#38656;&#35201;&#32771;&#34385;&#37325;&#20837;&#38382;&#39064;&#12290; <BR>&#20855;&#20307;&#26159;&#21542;&#35201;&#35774;&#23450;one shot&#30340;flag&#26159;&#21644;&#30828;&#20214;&#31995;&#32479;&#26377;&#20851;&#30340;&#65292;&#25105;&#20204;&#20030;&#19968;&#20010;&#20363;&#23376;&#65292;&#27604;&#22914;&#30005;&#27744;&#39537;&#21160;&#65292;&#30005;&#27744;&#37324;&#38754;&#26377;&#19968;&#20010;&#30005;&#37327;&#35745;&#65292;&#26159;&#20351;&#29992;HDQ&#21327;&#35758;&#36827;&#34892;&#36890;&#20449;&#30340;&#65292;&#30005;&#27744;&#39537;&#21160;&#20250;&#27880;&#20876;&#19968;&#20010;threaded interrupt handler&#65292;&#22312;&#36825;&#20010;handler&#20013;&#65292;&#20250;&#36890;&#36807;HDQ&#21327;&#35758;&#21644;&#30005;&#37327;&#35745;&#36827;&#34892;&#36890;&#20449;&#12290;&#23545;&#20110;&#36825;&#20010;handler&#65292;&#36890;&#36807;HDQ&#36827;&#34892;&#36890;&#20449;&#26159;&#38656;&#35201;&#19968;&#20010;&#23436;&#25972;&#30340;HDQ&#20132;&#20114;&#36807;&#31243;&#65292;&#22914;&#26524;&#20013;&#38388;&#34987;&#25171;&#26029;&#65292;&#25972;&#20010;&#36890;&#20449;&#36807;&#31243;&#20250;&#20986;&#38382;&#39064;&#65292;&#22240;&#27492;&#65292;&#36825;&#20010;handler&#23601;&#24517;&#39035;&#26159;one shot&#30340;&#12290; </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_NO_SUSPEND </TD>
<TD vAlign=top width=549>&#36825;&#20010;flag&#27604;&#36739;&#22909;&#29702;&#35299;&#65292;&#23601;&#26159;&#35828;&#22312;&#31995;&#32479;suspend&#30340;&#26102;&#20505;&#65292;&#19981;&#29992;disable&#36825;&#20010;&#20013;&#26029;&#65292;&#22914;&#26524;disable&#65292;&#21487;&#33021;&#20250;&#23548;&#33268;&#31995;&#32479;&#19981;&#33021;&#27491;&#24120;&#30340;resume&#12290; </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_FORCE_RESUME </TD>
<TD vAlign=top width=549>&#22312;&#31995;&#32479;resume&#30340;&#36807;&#31243;&#20013;&#65292;&#24378;&#21046;&#24517;&#39035;&#36827;&#34892;enable&#30340;&#21160;&#20316;&#65292;&#21363;&#20415;&#26159;&#35774;&#23450;&#20102;IRQF_NO_SUSPEND&#36825;&#20010;flag&#12290;&#36825;&#26159;&#21644;&#29305;&#23450;&#30340;&#30828;&#20214;&#34892;&#20026;&#30456;&#20851;&#30340;&#12290; </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_NO_THREAD </TD>
<TD vAlign=top width=549>&#26377;&#20123;low level&#30340;interrupt&#26159;&#19981;&#33021;&#32447;&#31243;&#21270;&#30340;&#65288;&#20363;&#22914;&#31995;&#32479;timer&#30340;&#20013;&#26029;&#65289;&#65292;&#36825;&#20010;flag&#23601;&#26159;&#36215;&#36825;&#20010;&#20316;&#29992;&#30340;&#12290;&#21478;&#22806;&#65292;&#26377;&#20123;&#32423;&#32852;&#30340;interrupt controller&#23545;&#24212;&#30340;IRQ&#20063;&#26159;&#19981;&#33021;&#32447;&#31243;&#21270;&#30340;&#65288;&#20363;&#22914;secondary GIC&#23545;&#24212;&#30340;IRQ&#65289;&#65292;&#23427;&#30340;&#32447;&#31243;&#21270;&#21487;&#33021;&#20250;&#24433;&#21709;&#19968;&#22823;&#25209;&#38468;&#23646;&#20110;&#35813;interrupt controller&#30340;&#22806;&#35774;&#30340;&#20013;&#26029;&#21709;&#24212;&#24310;&#36831;&#12290; </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_EARLY_RESUME </TD>
<TD vAlign=top width=549>&nbsp; </TD></TR>
<TR>
<TD vAlign=top width=151>IRQF_TIMER </TD>
<TD vAlign=top width=549>&nbsp; </TD></TR></TBODY></TABLE>
<P>&nbsp; </P>
<P>&#22235;&#12289;request_threaded_irq&#20195;&#30721;&#20998;&#26512; </P>
<P>1&#12289;request_threaded_irq&#20027;&#27969;&#31243; </P>
<BLOCKQUOTE>
<P>int request_threaded_irq(unsigned int irq, irq_handler_t handler, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; irq_handler_t thread_fn, unsigned long irqflags, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *devname, void *dev_id) <BR>{&nbsp; <BR>&nbsp;&nbsp;&nbsp; if ((irqflags &amp; IRQF_SHARED) &amp;&amp; !dev_id)&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;1&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return -EINVAL; </P>
<P>&nbsp;&nbsp;&nbsp; desc = irq_to_desc(irq); &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;2&#65289; <BR>&nbsp;&nbsp;&nbsp; if (!desc)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return -EINVAL; </P>
<P>&nbsp;&nbsp;&nbsp; if (!irq_settings_can_request(desc) || &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;3&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WARN_ON(irq_settings_is_per_cpu_devid(desc))) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return -EINVAL; </P>
<P>&nbsp;&nbsp;&nbsp; if (!handler) { &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;4&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!thread_fn) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return -EINVAL; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; handler = irq_default_primary_handler; <BR>&nbsp;&nbsp;&nbsp; } </P>
<P>&nbsp;&nbsp;&nbsp; action = kzalloc(sizeof(struct irqaction), GFP_KERNEL); </P>
<P>&nbsp;&nbsp;&nbsp; action-&gt;handler = handler; <BR>&nbsp;&nbsp;&nbsp; action-&gt;thread_fn = thread_fn; <BR>&nbsp;&nbsp;&nbsp; action-&gt;flags = irqflags; <BR>&nbsp;&nbsp;&nbsp; action-&gt;name = devname; <BR>&nbsp;&nbsp;&nbsp; action-&gt;dev_id = dev_id; </P>
<P>&nbsp;&nbsp;&nbsp; chip_bus_lock(desc); <BR>&nbsp;&nbsp;&nbsp; retval = __setup_irq(irq, desc, action); &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;5&#65289; <BR>&nbsp;&nbsp;&nbsp; chip_bus_sync_unlock(desc); <BR>} </P></BLOCKQUOTE>
<P>&#65288;1&#65289;&#23545;&#20110;&#37027;&#20123;&#38656;&#35201;&#20849;&#20139;&#30340;&#20013;&#26029;&#65292;&#22312;request irq&#30340;&#26102;&#20505;&#38656;&#35201;&#32473;&#20986;dev id&#65292;&#21542;&#21017;&#20250;&#20986;&#38169;&#36864;&#20986;&#12290;&#20026;&#20309;&#23545;&#20110;IRQF_SHARED&#30340;&#20013;&#26029;&#24517;&#39035;&#35201;&#32473;&#20986;dev id&#21602;&#65311;&#23454;&#38469;&#19978;&#65292;&#22312;&#20849;&#20139;&#30340;&#24773;&#20917;&#19979;&#65292;&#19968;&#20010;IRQ number&#23545;&#24212;&#33509;&#24178;&#20010;irqaction&#65292;&#24403;&#25805;&#20316;irqaction&#30340;&#26102;&#20505;&#65292;&#20165;&#20165;&#32473;&#20986;IRQ number&#23601;&#19981;&#26159;&#38750;&#24120;&#30340;&#36275;&#22815;&#20102;&#65292;&#36825;&#26102;&#20505;&#65292;&#38656;&#35201;&#19968;&#20010;ID&#34920;&#31034;&#20855;&#20307;&#30340;irqaction&#65292;&#36825;&#37324;&#23601;&#26159;dev_id&#30340;&#20316;&#29992;&#20102;&#12290;&#25105;&#20204;&#20030;&#19968;&#20010;&#20363;&#23376;&#65306; </P>
<BLOCKQUOTE>
<P>void free_irq(unsigned int irq, void *dev_id) </P></BLOCKQUOTE>
<P>&#24403;&#37322;&#25918;&#19968;&#20010;IRQ&#36164;&#28304;&#30340;&#26102;&#20505;&#65292;&#19981;&#20294;&#35201;&#32473;&#20986;IRQ number&#65292;&#36824;&#35201;&#32473;&#20986;device ID&#12290;&#21482;&#26377;&#36825;&#26679;&#65292;&#25165;&#33021;&#31934;&#20934;&#30340;&#25226;&#35201;&#37322;&#25918;&#30340;&#37027;&#20010;irqaction &#20174;irq action list&#19978;&#31227;&#38500;&#12290;dev_id&#22312;&#20013;&#26029;&#22788;&#29702;&#20013;&#26377;&#27809;&#26377;&#20316;&#29992;&#21602;&#65311;&#25105;&#20204;&#26469;&#30475;&#30475;source code&#65306; </P>
<BLOCKQUOTE>
<P>irqreturn_t handle_irq_event_percpu(struct irq_desc *desc, struct irqaction *action) <BR>{ </P>
<P>&nbsp;&nbsp;&nbsp; do { <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; irqreturn_t res;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; res = action-&gt;handler(irq, action-&gt;dev_id); </P>
<P>&#8230;&#8230; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; action = action-&gt;next; <BR>&nbsp;&nbsp;&nbsp; } while (action); </P>
<P>&#8230;&#8230; <BR>} </P></BLOCKQUOTE>
<P>linux interrupt framework&#34429;&#28982;&#25903;&#25345;&#20013;&#26029;&#20849;&#20139;&#65292;&#20294;&#26159;&#23427;&#24182;&#19981;&#20250;&#21327;&#21161;&#35299;&#20915;&#35782;&#21035;&#38382;&#39064;&#65292;&#23427;&#21482;&#20250;&#36941;&#21382;&#35813;IRQ number&#19978;&#27880;&#20876;&#30340;irqaction&#30340;callback&#20989;&#25968;&#65292;&#36825;&#26679;&#65292;&#34429;&#28982;&#21482;&#26159;&#19968;&#20010;&#22806;&#35774;&#20135;&#29983;&#30340;&#20013;&#26029;&#65292;linux kernel&#36824;&#26159;&#25226;&#25152;&#26377;&#20849;&#20139;&#30340;&#37027;&#20123;&#20013;&#26029;handler&#37117;&#36880;&#20010;&#35843;&#29992;&#25191;&#34892;&#12290;&#20026;&#20102;&#35753;&#31995;&#32479;&#30340;performance&#19981;&#21463;&#24433;&#21709;&#65292;irqaction&#30340;callback&#20989;&#25968;&#24517;&#39035;&#22312;&#20989;&#25968;&#30340;&#26368;&#24320;&#22987;&#36827;&#34892;&#21028;&#26029;&#65292;&#26159;&#21542;&#26159;&#33258;&#24049;&#30340;&#30828;&#20214;&#35774;&#22791;&#20135;&#29983;&#20102;&#20013;&#26029;&#65288;&#35835;&#21462;&#30828;&#20214;&#30340;&#23492;&#23384;&#22120;&#65289;&#65292;&#22914;&#26524;&#19981;&#26159;&#65292;&#23613;&#24555;&#30340;&#36864;&#20986;&#12290; </P>
<P>&#38656;&#35201;&#27880;&#24847;&#30340;&#26159;&#65292;&#36825;&#37324;dev_id&#24182;&#19981;&#33021;&#22312;&#20013;&#26029;&#35302;&#21457;&#30340;&#26102;&#20505;&#29992;&#26469;&#26631;&#35782;&#38656;&#35201;&#35843;&#29992;&#21738;&#19968;&#20010;irqaction&#30340;callback&#20989;&#25968;&#65292;&#36890;&#36807;&#19978;&#38754;&#30340;&#20195;&#30721;&#20063;&#21487;&#20197;&#30475;&#20986;&#65292;dev_id&#26377;&#20123;&#31867;&#20284;&#19968;&#20010;&#21442;&#25968;&#20256;&#36882;&#30340;&#36807;&#31243;&#65292;&#21487;&#20197;&#25226;&#20855;&#20307;driver&#30340;&#19968;&#20123;&#30828;&#20214;&#20449;&#24687;&#65292;&#32452;&#21512;&#25104;&#19968;&#20010;structure&#65292;&#22312;&#35302;&#21457;&#20013;&#26029;&#30340;&#26102;&#20505;&#21487;&#20197;&#25226;&#36825;&#20010;structure&#20256;&#36882;&#32473;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#12290; </P>
<P>&#65288;2&#65289;&#36890;&#36807;IRQ number&#33719;&#21462;&#23545;&#24212;&#30340;&#20013;&#26029;&#25551;&#36848;&#31526;&#12290;&#22312;&#24341;&#20837;CONFIG_SPARSE_IRQ&#36873;&#39033;&#21518;&#65292;&#36825;&#20010;&#36716;&#25442;&#21464;&#24471;&#19981;&#26159;&#37027;&#20040;&#31616;&#21333;&#20102;&#12290;&#22312;&#36807;&#21435;&#65292;&#25105;&#20204;&#20250;&#20197;IRQ number&#20026;index&#65292;&#20174;irq_desc&#36825;&#20010;&#20840;&#23616;&#25968;&#32452;&#20013;&#30452;&#25509;&#33719;&#21462;&#20013;&#26029;&#25551;&#36848;&#31526;&#12290;&#22914;&#26524;&#37197;&#32622;CONFIG_SPARSE_IRQ&#36873;&#39033;&#65292;&#21017;&#38656;&#35201;&#20174;radix tree&#20013;&#25628;&#32034;&#12290;CONFIG_SPARSE_IRQ&#36873;&#39033;&#30340;&#26356;&#35814;&#32454;&#30340;&#20171;&#32461;&#35831;&#21442;&#32771;<A href="http://www.wowotech.net/linux_kenrel/interrupt_descriptor.html">IRQ number&#21644;&#20013;&#26029;&#25551;&#36848;&#31526;</A> </P>
<P>&#65288;3&#65289;&#24182;&#38750;&#31995;&#32479;&#20013;&#25152;&#26377;&#30340;IRQ number&#37117;&#21487;&#20197;request&#65292;&#26377;&#20123;&#20013;&#26029;&#25551;&#36848;&#31526;&#34987;&#26631;&#35760;&#20026;IRQ_NOREQUEST&#65292;&#26631;&#35782;&#35813;IRQ number&#19981;&#33021;&#34987;&#20854;&#20182;&#30340;&#39537;&#21160;request&#12290;&#19968;&#33324;&#32780;&#35328;&#65292;&#36825;&#20123;IRQ number&#26377;&#29305;&#27530;&#30340;&#20316;&#29992;&#65292;&#20363;&#22914;&#29992;&#20110;&#32423;&#32852;&#30340;&#37027;&#20010;IRQ number&#26159;&#19981;&#33021;request&#12290;irq_settings_can_request&#20989;&#25968;&#23601;&#26159;&#21028;&#26029;&#19968;&#20010;IRQ&#26159;&#21542;&#21487;&#20197;&#34987;request&#12290; </P>
<P>irq_settings_is_per_cpu_devid&#20989;&#25968;&#29992;&#26469;&#21028;&#26029;&#19968;&#20010;&#20013;&#26029;&#25551;&#36848;&#31526;&#26159;&#21542;&#38656;&#35201;&#20256;&#36882;per cpu&#30340;device ID&#12290;per cpu&#30340;&#20013;&#26029;&#19978;&#38754;&#24050;&#32463;&#25551;&#36848;&#30340;&#24456;&#28165;&#26970;&#20102;&#65292;&#36825;&#37324;&#19981;&#20877;&#32454;&#36848;&#12290;&#22914;&#26524;&#19968;&#20010;&#20013;&#26029;&#25551;&#36848;&#31526;&#23545;&#24212;&#30340;&#20013;&#26029; ID&#26159;per cpu&#30340;&#65292;&#37027;&#20040;&#22312;&#30003;&#35831;&#20854;handler&#30340;&#26102;&#20505;&#23601;&#26377;&#20004;&#31181;&#24773;&#20917;&#65292;&#19968;&#31181;&#26159;&#20256;&#36882;&#32479;&#19968;&#30340;dev_id&#21442;&#25968;&#65288;&#20256;&#20837;request_threaded_irq&#30340;&#26368;&#21518;&#19968;&#20010;&#21442;&#25968;&#65289;&#65292;&#21478;&#22806;&#19968;&#31181;&#24773;&#20917;&#26159;&#38024;&#23545;&#27599;&#20010;CPU&#65292;&#20256;&#36882;&#19981;&#21516;&#30340;dev_id&#21442;&#25968;&#12290;&#22312;&#36825;&#31181;&#24773;&#20917;&#19979;&#65292;&#25105;&#20204;&#38656;&#35201;&#35843;&#29992;request_percpu_irq&#25509;&#21475;&#20989;&#25968;&#32780;&#19981;&#26159;request_threaded_irq&#12290; </P>
<P>&#65288;4&#65289;&#20256;&#20837;request_threaded_irq&#30340;primary handler&#21644;threaded handler&#21442;&#25968;&#26377;&#19979;&#38754;&#22235;&#31181;&#32452;&#21512;&#65306; </P>
<TABLE class=ke-zeroborder cellSpacing=0 cellPadding=2 width=700 border=0>
<TBODY>
<TR>
<TD vAlign=top width=142>primary handler </TD>
<TD vAlign=top width=151>threaded handler </TD>
<TD vAlign=top width=406>&#25551;&#36848; </TD></TR>
<TR>
<TD vAlign=top width=142>NULL </TD>
<TD vAlign=top width=151>NULL </TD>
<TD vAlign=top width=406>&#20989;&#25968;&#20986;&#38169;&#65292;&#36820;&#22238;-EINVAL </TD></TR>
<TR>
<TD vAlign=top width=142>&#35774;&#23450; </TD>
<TD vAlign=top width=151>&#35774;&#23450; </TD>
<TD vAlign=top width=406>&#27491;&#24120;&#27969;&#31243;&#12290;&#20013;&#26029;&#22788;&#29702;&#34987;&#21512;&#29702;&#30340;&#20998;&#37197;&#21040;primary handler&#21644;threaded handler&#20013;&#12290; </TD></TR>
<TR>
<TD vAlign=top width=142>&#35774;&#23450; </TD>
<TD vAlign=top width=151>NULL </TD>
<TD vAlign=top width=406>&#20013;&#26029;&#22788;&#29702;&#37117;&#26159;&#22312;primary handler&#20013;&#23436;&#25104; </TD></TR>
<TR>
<TD vAlign=top width=142>NULL </TD>
<TD vAlign=top width=151>&#35774;&#23450; </TD>
<TD vAlign=top width=406>&#36825;&#31181;&#24773;&#20917;&#19979;&#65292;&#31995;&#32479;&#20250;&#24110;&#24537;&#35774;&#23450;&#19968;&#20010;default&#30340;primary handler&#65306;irq_default_primary_handler&#65292;&#21327;&#21161;&#21796;&#37266;threaded handler&#32447;&#31243; </TD></TR></TBODY></TABLE>
<P>&#65288;5&#65289;&#36825;&#37096;&#20998;&#30340;&#20195;&#30721;&#24456;&#31616;&#21333;&#65292;&#20998;&#37197;struct irqaction&#65292;&#36171;&#20540;&#65292;&#35843;&#29992;__setup_irq&#36827;&#34892;&#23454;&#38469;&#30340;&#27880;&#20876;&#36807;&#31243;&#12290;&#36825;&#37324;&#35201;&#32599;&#21990;&#20960;&#21477;&#30340;&#26159;&#38145;&#30340;&#25805;&#20316;&#65292;&#22312;&#20869;&#26680;&#20013;&#65292;&#26377;&#24456;&#22810;&#20989;&#25968;&#65292;&#26377;&#30340;&#26159;&#38656;&#35201;&#35843;&#29992;&#32773;&#33258;&#24049;&#21152;&#38145;&#20445;&#25252;&#30340;&#65292;&#26377;&#20123;&#26159;&#19981;&#38656;&#35201;&#21152;&#38145;&#20445;&#25252;&#30340;&#12290;&#23545;&#20110;&#36825;&#20123;&#22330;&#26223;&#65292;linux kernel&#37319;&#21462;&#20102;&#32479;&#19968;&#30340;&#31574;&#30053;&#65306;&#22522;&#26412;&#20989;&#25968;&#21517;&#23383;&#26159;&#19968;&#26679;&#30340;&#65292;&#21482;&#19981;&#36807;&#38656;&#35201;&#35843;&#29992;&#32773;&#33258;&#24049;&#21152;&#38145;&#20445;&#25252;&#30340;&#37027;&#20010;&#20989;&#25968;&#38656;&#35201;&#22686;&#21152;__&#30340;&#21069;&#32512;&#65292;&#20363;&#22914;&#20869;&#26680;&#26377;&#26377;&#19979;&#38754;&#20004;&#20010;&#20989;&#25968;&#65306;setup_irq&#21644;__setup_irq&#12290;&#36825;&#37324;&#65292;&#25105;&#20204;&#22312;setup irq&#30340;&#26102;&#20505;&#24050;&#32463;&#35843;&#29992;chip_bus_lock&#36827;&#34892;&#20445;&#25252;&#65292;&#22240;&#27492;&#20351;&#29992;lock free&#30340;&#29256;&#26412;__setup_irq&#12290; </P>
<P>chip_bus_lock&#23450;&#20041;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>static inline void chip_bus_lock(struct irq_desc *desc) <BR>{ <BR>&nbsp;&nbsp;&nbsp; if (unlikely(desc-&gt;irq_data.chip-&gt;irq_bus_lock)) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; desc-&gt;irq_data.chip-&gt;irq_bus_lock(&amp;desc-&gt;irq_data); <BR>} </P></BLOCKQUOTE>
<P>&#22823;&#37096;&#20998;&#30340;interrupt controller&#24182;&#27809;&#26377;&#23450;&#20041;irq_bus_lock&#36825;&#20010;callback&#20989;&#25968;&#65292;&#22240;&#27492;chip_bus_lock&#36825;&#20010;&#20989;&#25968;&#23545;&#22823;&#22810;&#25968;&#30340;&#20013;&#26029;&#25511;&#21046;&#22120;&#32780;&#35328;&#26159;&#27809;&#26377;&#23454;&#38469;&#24847;&#20041;&#30340;&#12290;&#20294;&#26159;&#65292;&#26377;&#20123;interrupt controller&#26159;&#36830;&#25509;&#21040;&#24930;&#36895;&#24635;&#32447;&#19978;&#30340;&#65292;&#20363;&#22914;&#19968;&#20010;i2c&#25509;&#21475;&#30340;IO expander&#33455;&#29255;&#65288;&#36825;&#31181;&#33455;&#29255;&#24448;&#24448;&#20063;&#25552;&#20379;&#33509;&#24178;&#26377;&#20013;&#26029;&#21151;&#33021;&#30340;GPIO&#65292;&#22240;&#27492;&#20063;&#26159;&#19968;&#20010;interrupt controller&#65289;&#65292;&#22312;&#35775;&#38382;&#36825;&#31181;interrupt controller&#30340;&#26102;&#20505;&#38656;&#35201;lock&#20303;&#37027;&#20010;&#24930;&#36895;bus&#65288;&#21482;&#33021;&#26377;&#19968;&#20010;client&#22312;&#20351;&#29992;I2C bus&#65289;&#12290; </P>
<P>&nbsp; </P>
<P>2&#12289;&#27880;&#20876;irqaction </P>
<P>&#65288;1&#65289;nested IRQ&#30340;&#22788;&#29702;&#20195;&#30721; </P>
<P>&#22312;&#30475;&#20855;&#20307;&#30340;&#20195;&#30721;&#20043;&#21069;&#65292;&#25105;&#20204;&#39318;&#20808;&#35201;&#29702;&#35299;&#20160;&#20040;&#26159;nested IRQ&#12290;nested IRQ&#19981;&#26159;cascade IRQ&#65292;&#22312;<A href="http://www.wowotech.net/linux_kenrel/gic_driver.html">GIC&#20195;&#30721;&#20998;&#26512;</A>&#20013;&#25105;&#20204;&#26377;&#25551;&#36848;&#36807;cascade IRQ&#36825;&#20010;&#27010;&#24565;&#65292;&#20027;&#35201;&#29992;&#22312;interrupt controller&#32423;&#32852;&#30340;&#24773;&#20917;&#19979;&#12290;&#20026;&#20102;&#26041;&#20415;&#22823;&#23478;&#29702;&#35299;&#65292;&#25105;&#36824;&#26159;&#32473;&#20986;&#19968;&#20010;&#20855;&#20307;&#30340;&#20363;&#23376;&#21543;&#65292;&#20855;&#20307;&#30340;HW block&#35831;&#21442;&#32771;&#19979;&#22270;&#65306; </P>
<P><A href="http://www.wowotech.net/content/uploadfile/201409/a03daab0b60c21e763d7f367c449fb8820140922103330.gif"><IMG title=SOC-INT style="BORDER-LEFT-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px" border=0 alt=SOC-INT src="http://www.wowotech.net/content/uploadfile/201409/f2140c5be79f3100a5c54fdf4228a51a20140922103331.gif" width=681 height=178></A> </P>
<P>&#19978;&#22270;&#26159;&#19968;&#20010;&#20004;&#20010;GIC&#32423;&#32852;&#30340;&#20363;&#23376;&#65292;&#25152;&#26377;&#30340;HW block&#23553;&#35013;&#22312;&#20102;&#19968;&#20010;SOC chip&#20013;&#12290;&#20026;&#20102;&#26041;&#20415;&#25551;&#36848;&#65292;&#25105;&#20204;&#20808;&#36827;&#34892;&#32534;&#21495;&#65306;Secondary GIC&#30340;IRQ number&#26159;A&#65292;&#22806;&#35774;1&#30340;IRQ number&#26159;B&#65292;&#22806;&#35774;2&#30340;IRQ number&#26159;C&#12290;&#23545;&#20110;&#19978;&#38754;&#30340;&#30828;&#20214;&#65292;linux kernel&#22788;&#29702;&#22914;&#19979;&#65306; </P>
<P>&#65288;a&#65289;IRQ A&#30340;&#20013;&#26029;&#25551;&#36848;&#31526;&#34987;&#35774;&#23450;&#20026;&#19981;&#33021;&#27880;&#20876;irqaction&#65288;&#19981;&#33021;&#27880;&#20876;specific interrupt handler&#65292;&#25110;&#32773;&#21483;&#20013;&#26029;&#26381;&#21153;&#31243;&#24207;&#65289; </P>
<P>&#65288;b&#65289;IRQ A&#30340;highlevel irq-events handler&#65288;&#22788;&#29702;interrupt flow control&#65289;&#36127;&#36131;&#36827;&#34892;IRQ number&#30340;&#26144;&#23556;&#65292;&#22312;&#20854;irq domain&#19978;&#32763;&#35793;&#20986;&#20855;&#20307;&#22806;&#35774;&#30340;IRQ number&#65292;&#24182;&#37325;&#26032;&#23450;&#21521;&#21040;&#22806;&#35774;IRQ number&#23545;&#24212;&#30340;highlevel irq-events handler&#12290; </P>
<P>&#65288;c&#65289;&#25152;&#26377;&#22806;&#35774;&#39537;&#21160;&#30340;&#20013;&#26029;&#27491;&#24120;request irq&#65292;&#21487;&#20197;&#20219;&#24847;&#36873;&#25321;&#32447;&#31243;&#21270;&#30340;handler&#65292;&#25110;&#32773;&#21482;&#27880;&#20876;primary handler&#12290; </P>
<P>&#38656;&#35201;&#27880;&#24847;&#30340;&#26159;&#65292;&#23545;root GIC&#21644;Secondary GIC&#23492;&#23384;&#22120;&#30340;&#35775;&#38382;&#38750;&#24120;&#24555;&#65292;&#22240;&#27492;ack&#12289;mask&#12289;EOI&#31561;&#25805;&#20316;&#20063;&#38750;&#24120;&#24555;&#12290; </P>
<P>&#25105;&#20204;&#20877;&#30475;&#30475;&#21478;&#22806;&#19968;&#20010;interrupt controller&#32423;&#32852;&#30340;&#24773;&#20917;&#65306; </P>
<P><A href="http://www.wowotech.net/content/uploadfile/201409/123d27cb3ef3f846a1f12b7ff969be0120140922103332.gif"><IMG title=nested style="BORDER-LEFT-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px" border=0 alt=nested src="http://www.wowotech.net/content/uploadfile/201409/eb9047b8462ce224c9958af7e42dcc6820140922103334.gif" width=720 height=182></A> </P>
<P>IO expander HW block&#25552;&#20379;&#20102;&#26377;&#20013;&#26029;&#21151;&#33021;&#30340;GPIO&#65292;&#22240;&#27492;&#23427;&#20063;&#26159;&#19968;&#20010;interrupt controller&#65292;&#26377;&#23427;&#33258;&#24049;&#30340;irq domain&#21644;irq chip&#12290;&#19978;&#22270;&#20013;&#22806;&#35774;1&#21644;&#22806;&#35774;2&#20351;&#29992;&#20102;IO expander&#19978;&#26377;&#20013;&#26029;&#21151;&#33021;&#30340;GPIO&#65292;&#23427;&#20204;&#26377;&#23646;&#20110;&#33258;&#24049;&#30340;IRQ number&#20197;&#21450;&#20013;&#26029;&#25551;&#36848;&#31526;&#12290;IO expander HW block&#30340;IRQ line&#36830;&#25509;&#21040;SOC&#20869;&#37096;&#30340;interrupt controller&#19978;&#65292;&#22240;&#27492;&#65292;&#36825;&#20063;&#26159;&#19968;&#20010;interrupt controller&#32423;&#32852;&#30340;&#24773;&#20917;&#65292;&#23545;&#20110;&#36825;&#31181;&#24773;&#20917;&#65292;&#25105;&#20204;&#26159;&#21542;&#21487;&#20197;&#37319;&#29992;&#21644;&#19978;&#38754;GIC&#32423;&#32852;&#30340;&#22788;&#29702;&#26041;&#24335;&#21602;&#65311; </P>
<P>&#19981;&#34892;&#65292;&#23545;&#20110;GIC&#32423;&#32852;&#30340;&#24773;&#20917;&#65292;&#22914;&#26524;secondary GIC&#19978;&#30340;&#22806;&#35774;1&#20135;&#29983;&#20102;&#20013;&#26029;&#65292;&#25972;&#20010;&#20851;&#20013;&#26029;&#30340;&#26102;&#38388;&#26159;IRQ A&#30340;&#20013;&#26029;&#25551;&#36848;&#31526;&#30340;highlevel irq-events handler&#22788;&#29702;&#26102;&#38388;&#65291;IRQ B&#30340;&#30340;&#20013;&#26029;&#25551;&#36848;&#31526;&#30340;highlevel irq-events handler&#22788;&#29702;&#26102;&#38388;&#65291;&#22806;&#35774;1&#30340;primary handler&#30340;&#22788;&#29702;&#26102;&#38388;&#12290;&#25152;&#24184;&#23545;root GIC&#21644;Secondary GIC&#23492;&#23384;&#22120;&#30340;&#35775;&#38382;&#38750;&#24120;&#24555;&#65292;&#22240;&#27492;&#25972;&#20010;&#20851;&#20013;&#26029;&#30340;&#26102;&#38388;&#20063;&#19981;&#26159;&#38750;&#24120;&#30340;&#38271;&#12290;&#20294;&#26159;&#22914;&#26524;&#26159;IO expander&#36825;&#20010;&#24773;&#20917;&#65292;&#22914;&#26524;&#37319;&#21462;&#21644;&#19978;&#38754;GIC&#32423;&#32852;&#30340;&#22788;&#29702;&#26041;&#24335;&#19968;&#26679;&#30340;&#35805;&#65292;&#20851;&#20013;&#26029;&#30340;&#26102;&#38388;&#38750;&#24120;&#38271;&#12290;&#25105;&#20204;&#36824;&#26159;&#29992;&#22806;&#35774;1&#20135;&#29983;&#30340;&#20013;&#26029;&#20026;&#20363;&#23376;&#22909;&#20102;&#12290;&#36825;&#26102;&#20505;&#65292;&#30001;&#20110;IRQ B&#30340;&#30340;&#20013;&#26029;&#25551;&#36848;&#31526;&#30340;highlevel irq-events handler&#22788;&#29702;&#35774;&#35745;I2C&#30340;&#25805;&#20316;&#65292;&#22240;&#27492;&#26102;&#38388;&#38750;&#24120;&#30340;&#38271;&#65292;&#36825;&#26102;&#20505;&#65292;&#23545;&#20110;&#25972;&#20010;&#31995;&#32479;&#30340;&#23454;&#26102;&#24615;&#32780;&#35328;&#26159;&#33268;&#21629;&#30340;&#25171;&#20987;&#12290;&#23545;&#36825;&#31181;&#30828;&#20214;&#24773;&#20917;&#65292;linux kernel&#22788;&#29702;&#22914;&#19979;&#65306; </P>
<P>&#65288;a&#65289;IRQ A&#30340;&#20013;&#26029;&#25551;&#36848;&#31526;&#30340;highlevel irq-events handler&#26681;&#25454;&#23454;&#38469;&#24773;&#20917;&#36827;&#34892;&#35774;&#23450;&#65292;&#24182;&#19988;&#20801;&#35768;&#27880;&#20876;irqaction&#12290;&#23545;&#20110;&#36830;&#25509;&#21040;IO expander&#19978;&#30340;&#22806;&#35774;&#65292;&#23427;&#26159;&#27809;&#26377;real time&#30340;&#35201;&#27714;&#30340;&#65288;&#21542;&#21017;&#20063;&#19981;&#20250;&#25509;&#21040;IO expander&#19978;&#65289;&#65292;&#22240;&#27492;&#19968;&#33324;&#20250;&#36827;&#34892;&#32447;&#31243;&#21270;&#22788;&#29702;&#12290;&#30001;&#20110;threaded handler&#20013;&#28041;&#21450;I2C&#25805;&#20316;&#65292;&#22240;&#27492;&#35201;&#35774;&#23450;IRQF_ONESHOT&#30340;flag&#12290; </P>
<P>&#65288;b&#65289;&#22312;IRQ A&#30340;&#20013;&#26029;&#25551;&#36848;&#31526;&#30340;threaded interrupt handler&#20013;&#36827;&#34892;&#36827;&#34892;IRQ number&#30340;&#26144;&#23556;&#65292;&#22312;IO expander irq domain&#19978;&#32763;&#35793;&#20986;&#20855;&#20307;&#22806;&#35774;&#30340;IRQ number&#65292;&#24182;&#30452;&#25509;&#35843;&#29992;handle_nested_irq&#20989;&#25968;&#22788;&#29702;&#35813;IRQ&#12290; </P>
<P>&#65288;c&#65289;&#22806;&#35774;&#23545;&#24212;&#30340;&#20013;&#26029;&#25551;&#36848;&#31526;&#35774;&#23450;IRQ_NESTED_THREAD&#30340;flag&#65292;&#34920;&#26126;&#36825;&#26159;&#19968;&#20010;nested IRQ&#12290;nested IRQ&#27809;&#26377;highlevel irq-events handler&#65292;&#20063;&#27809;&#26377;primary handler&#65292;&#23427;&#30340;threaded interrupt handler&#26159;&#38468;&#30528;&#22312;&#20854;parent IRQ&#30340;threaded handler&#19978;&#30340;&#12290; </P>
<P>&#20855;&#20307;&#30340;nested IRQ&#30340;&#22788;&#29702;&#20195;&#30721;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>static int __setup_irq(unsigned int irq, struct irq_desc *desc, struct irqaction *new) <BR>{ </P>
<P>&#8230;&#8230; <BR>&nbsp;&nbsp;&nbsp; <STRONG>nested = irq_settings_is_nested_thread(desc); <BR>&nbsp;&nbsp;&nbsp; if (nested) { <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!new-&gt;thread_fn) { <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret = -EINVAL; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto out_mput; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new-&gt;handler = irq_nested_primary_handler;</STRONG> <BR>&nbsp;&nbsp;&nbsp; } else {&nbsp; <BR>&#8230;&#8230; <BR>&nbsp;&nbsp;&nbsp; } </P>
<P>&#8230;&#8230; </P>
<P>} </P></BLOCKQUOTE>
<P>&#22914;&#26524;&#19968;&#20010;&#20013;&#26029;&#25551;&#36848;&#31526;&#26159;nested thread type&#30340;&#65292;&#35828;&#26126;&#36825;&#20010;&#20013;&#26029;&#25551;&#36848;&#31526;&#24212;&#35813;&#35774;&#23450;threaded interrupt handler&#65288;&#24403;&#28982;&#65292;&#20869;&#26680;&#26159;&#19981;&#20250;&#21333;&#29420;&#21019;&#24314;&#19968;&#20010;thread&#30340;&#65292;&#23427;&#26159;&#20511;&#30528;&#20854;parent IRQ&#30340;interrupt thread&#25191;&#34892;&#65289;&#65292;&#21542;&#21017;&#23601;&#20250;&#20986;&#38169;&#36820;&#22238;&#12290;&#23545;&#20110;primary handler&#65292;&#23427;&#24212;&#35813;&#27809;&#26377;&#26426;&#20250;&#34987;&#35843;&#29992;&#21040;&#65292;&#24403;&#28982;&#20026;&#20102;&#35843;&#35797;&#65292;kernel&#23558;&#20854;&#35774;&#23450;&#20026;irq_nested_primary_handler&#65292;&#20197;&#20415;&#22312;&#35843;&#29992;&#30340;&#26102;&#20505;&#25171;&#21360;&#19968;&#20123;&#20449;&#24687;&#65292;&#35753;&#24037;&#31243;&#24072;&#30452;&#21040;&#21457;&#29983;&#20102;&#20160;&#20040;&#29366;&#20917;&#12290; </P>
<P>&#65288;2&#65289;forced irq threading&#22788;&#29702; </P>
<P>&#20855;&#20307;&#30340;forced irq threading&#30340;&#22788;&#29702;&#20195;&#30721;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>static int __setup_irq(unsigned int irq, struct irq_desc *desc, struct irqaction *new) <BR>{ </P>
<P>&#8230;&#8230; <BR>&nbsp;&nbsp;&nbsp; nested = irq_settings_is_nested_thread(desc); <BR>&nbsp;&nbsp;&nbsp; if (nested) {&nbsp; <BR>&#8230;&#8230; <BR>&nbsp;&nbsp;&nbsp; } else { <BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (irq_settings_can_thread(desc)) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; irq_setup_forced_threading(new);</STRONG> <BR>&nbsp;&nbsp;&nbsp; } </P>
<P>&#8230;&#8230; </P>
<P>} </P></BLOCKQUOTE>
<P>forced irq threading&#20854;&#23454;&#23601;&#26159;&#23558;&#31995;&#32479;&#20013;&#25152;&#26377;&#21487;&#20197;&#34987;&#32447;&#31243;&#21270;&#30340;&#20013;&#26029;handler&#20840;&#37096;&#32447;&#31243;&#21270;&#65292;&#21363;&#20415;&#20320;&#22312;request irq&#30340;&#26102;&#20505;&#65292;&#35774;&#23450;&#30340;&#26159;primary handler&#65292;&#32780;&#19981;&#26159;threaded handler&#12290;&#24403;&#28982;&#37027;&#20123;&#19981;&#33021;&#34987;&#32447;&#31243;&#21270;&#30340;&#20013;&#26029;&#65288;&#26631;&#27880;&#20102;IRQF_NO_THREAD&#30340;&#20013;&#26029;&#65292;&#20363;&#22914;&#31995;&#32479;timer&#65289;&#36824;&#26159;&#25490;&#38500;&#22312;&#22806;&#30340;&#12290;irq_settings_can_thread&#20989;&#25968;&#23601;&#26159;&#21028;&#26029;&#19968;&#20010;&#20013;&#26029;&#26159;&#21542;&#21487;&#20197;&#34987;&#32447;&#31243;&#21270;&#65292;&#22914;&#26524;&#21487;&#20197;&#30340;&#35805;&#65292;&#21017;&#35843;&#29992;irq_setup_forced_threading&#22312;set irq&#30340;&#26102;&#20505;&#24378;&#21046;&#36827;&#34892;&#32447;&#31243;&#21270;&#12290;&#20855;&#20307;&#20195;&#30721;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>static void irq_setup_forced_threading(struct irqaction *new) <BR>{ <BR>&nbsp;&nbsp;&nbsp; if (!force_irqthreads)&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;a&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return; <BR>&nbsp;&nbsp;&nbsp; if (new-&gt;flags &amp; (IRQF_NO_THREAD | IRQF_PERCPU | IRQF_ONESHOT))&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;b&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return; </P>
<P>&nbsp;&nbsp;&nbsp; new-&gt;flags |= IRQF_ONESHOT; &#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;d&#65289; </P>
<P>&nbsp;&nbsp;&nbsp; if (!new-&gt;thread_fn) {&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;c&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set_bit(IRQTF_FORCED_THREAD, &amp;new-&gt;thread_flags); <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new-&gt;thread_fn = new-&gt;handler; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new-&gt;handler = irq_default_primary_handler; <BR>&nbsp;&nbsp;&nbsp; } <BR>} </P></BLOCKQUOTE>
<P>&#65288;a&#65289;&#31995;&#32479;&#20013;&#26377;&#19968;&#20010;&#24378;&#21046;&#32447;&#31243;&#21270;&#30340;&#36873;&#39033;&#65306;CONFIG_IRQ_FORCED_THREADING&#65292;&#22914;&#26524;&#27809;&#26377;&#25171;&#24320;&#35813;&#36873;&#39033;&#65292;force_irqthreads&#24635;&#26159;0&#65292;&#22240;&#27492;irq_setup_forced_threading&#20063;&#23601;&#27809;&#26377;&#20160;&#20040;&#20316;&#29992;&#65292;&#30452;&#25509;return&#20102;&#12290;&#22914;&#26524;&#25171;&#24320;&#20102;CONFIG_IRQ_FORCED_THREADING&#65292;&#35828;&#26126;&#31995;&#32479;&#25903;&#25345;&#24378;&#21046;&#32447;&#31243;&#21270;&#65292;&#20294;&#26159;&#20855;&#20307;&#26159;&#21542;&#23545;&#25152;&#26377;&#30340;&#20013;&#26029;&#36827;&#34892;&#24378;&#21046;&#32447;&#31243;&#21270;&#22788;&#29702;&#36824;&#26159;&#35201;&#30475;&#21629;&#20196;&#34892;&#21442;&#25968;threadirqs&#12290;&#22914;&#26524;kernel&#21551;&#21160;&#30340;&#26102;&#20505;&#27809;&#26377;&#20256;&#20837;&#35813;&#21442;&#25968;&#65292;&#37027;&#20040;&#21516;&#26679;&#30340;&#65292;irq_setup_forced_threading&#20063;&#23601;&#27809;&#26377;&#20160;&#20040;&#20316;&#29992;&#65292;&#30452;&#25509;return&#20102;&#12290;&#21482;&#26377;bootloader&#21521;&#20869;&#26680;&#20256;&#20837;threadirqs&#36825;&#20010;&#21629;&#20196;&#34892;&#21442;&#25968;&#65292;&#20869;&#26680;&#25165;&#30495;&#27491;&#22312;&#21551;&#21160;&#36807;&#31243;&#20013;&#65292;&#36827;&#34892;&#21508;&#20010;&#20013;&#26029;&#30340;&#24378;&#21046;&#32447;&#31243;&#21270;&#30340;&#25805;&#20316;&#12290; </P>
<P>&#65288;b&#65289;&#30475;&#21040;IRQF_NO_THREAD&#36873;&#39033;&#20320;&#21487;&#33021;&#20250;&#22855;&#24618;&#65292;&#21069;&#38754;irq_settings_can_thread&#20989;&#25968;&#19981;&#26159;&#26816;&#26597;&#36807;&#20102;&#21527;&#65311;&#20026;&#20309;&#36824;&#35201;&#37325;&#22797;&#26816;&#26597;&#65311;&#20854;&#23454;&#19968;&#20010;&#20013;&#26029;&#26159;&#21542;&#21487;&#20197;&#36827;&#34892;&#32447;&#31243;&#21270;&#21487;&#20197;&#20174;&#20004;&#20010;&#23618;&#38754;&#30475;&#65306;&#19968;&#20010;&#26159;&#20174;&#24213;&#23618;&#30475;&#65292;&#20063;&#23601;&#26159;&#20174;&#20013;&#26029;&#25551;&#36848;&#31526;&#12289;&#20174;&#23454;&#38469;&#30340;&#20013;&#26029;&#30828;&#20214;&#25299;&#25169;&#31561;&#26041;&#38754;&#30475;&#12290;&#21478;&#22806;&#19968;&#20010;&#26159;&#20174;&#20013;&#26029;&#23376;&#31995;&#32479;&#30340;&#29992;&#25143;&#23618;&#38754;&#30475;&#65292;&#20063;&#23601;&#26159;&#21508;&#20010;&#22806;&#35774;&#22312;&#27880;&#20876;&#33258;&#24049;&#30340;handler&#30340;&#26102;&#20505;&#26159;&#21542;&#24819;&#36827;&#34892;&#32447;&#31243;&#21270;&#22788;&#29702;&#12290;&#25152;&#26377;&#30340;IRQF_XXX&#37117;&#26159;&#20174;&#29992;&#25143;&#23618;&#38754;&#30475;&#30340;flag&#65292;&#22240;&#27492;&#22914;&#26524;&#29992;&#25143;&#36890;&#36807;IRQF_NO_THREAD&#36825;&#20010;flag&#21578;&#30693;kernel&#65292;&#35813;interrupt&#19981;&#33021;&#34987;&#32447;&#31243;&#21270;&#65292;&#37027;&#20040;&#24378;&#21046;&#32447;&#31243;&#21270;&#30340;&#26426;&#21046;&#36824;&#26159;&#23562;&#37325;&#29992;&#25143;&#30340;&#36873;&#25321;&#30340;&#12290; </P>
<P>PER CPU&#30340;&#20013;&#26029;&#37117;&#26159;&#19968;&#20123;&#36739;&#20026;&#29305;&#27530;&#30340;&#20013;&#26029;&#65292;&#19981;&#26159;&#19968;&#33324;&#24847;&#20041;&#19978;&#30340;&#22806;&#35774;&#20013;&#26029;&#65292;&#22240;&#27492;&#23545;PER CPU&#30340;&#20013;&#26029;&#19981;&#24378;&#21046;&#36827;&#34892;&#32447;&#31243;&#21270;&#12290;IRQF_ONESHOT&#36873;&#39033;&#35828;&#26126;&#35813;&#20013;&#26029;&#24050;&#32463;&#34987;&#32447;&#31243;&#21270;&#20102;&#65288;&#32780;&#19988;&#26159;&#29305;&#27530;&#30340;one shot&#31867;&#22411;&#30340;&#65289;&#65292;&#22240;&#27492;&#20063;&#26159;&#30452;&#25509;&#36820;&#22238;&#20102;&#12290; </P>
<P>&#65288;c&#65289;&#24378;&#21046;&#32447;&#31243;&#21270;&#21482;&#23545;&#37027;&#20123;&#27809;&#26377;&#35774;&#23450;thread_fn&#30340;&#20013;&#26029;&#36827;&#34892;&#22788;&#29702;&#65292;&#36825;&#31181;&#20013;&#26029;&#23558;&#20840;&#37096;&#30340;&#22788;&#29702;&#25918;&#22312;&#20102;primary interrupt handler&#20013;&#65288;&#24403;&#28982;&#65292;&#22914;&#26524;&#20013;&#26029;&#22788;&#29702;&#27604;&#36739;&#32791;&#26102;&#65292;&#37027;&#20040;&#20063;&#21487;&#33021;&#20250;&#37319;&#29992;bottom half&#30340;&#26426;&#21046;&#65289;&#65292;&#30001;&#20110;primary interrupt handler&#26159;&#20840;&#31243;&#20851;&#38381;CPU&#20013;&#26029;&#30340;&#65292;&#22240;&#27492;&#21487;&#33021;&#23545;&#31995;&#32479;&#30340;&#23454;&#26102;&#24615;&#36896;&#25104;&#24433;&#21709;&#65292;&#22240;&#27492;&#32771;&#34385;&#23558;&#20854;&#24378;&#21046;&#32447;&#31243;&#21270;&#12290;struct irqaction&#20013;&#30340;thread_flags&#26159;&#21644;&#32447;&#31243;&#30456;&#20851;&#30340;flag&#65292;&#25105;&#20204;&#32473;&#23427;&#25171;&#19978;IRQTF_FORCED_THREAD&#30340;&#26631;&#31614;&#65292;&#34920;&#26126;&#35813;threaded handler&#26159;&#34987;&#24378;&#21046;threaded&#30340;&#12290;new-&gt;thread_fn = new-&gt;handler&#36825;&#27573;&#20195;&#30721;&#34920;&#31034;&#23558;&#21407;&#26469;primary handler&#20013;&#30340;&#20869;&#23481;&#20840;&#37096;&#25918;&#21040;threaded handler&#20013;&#22788;&#29702;&#65292;&#26032;&#30340;primary handler&#34987;&#35774;&#23450;&#20026;default handler&#12290; </P>
<P>&#65288;d&#65289;&#24378;&#21046;&#32447;&#31243;&#21270;&#26159;&#19968;&#20010;&#21644;&#23454;&#26102;&#24615;&#30456;&#20851;&#30340;&#36873;&#39033;&#65292;&#20174;&#25105;&#30340;&#35282;&#24230;&#26469;&#30475;&#26159;&#19968;&#20010;&#24456;&#19981;&#22909;&#30340;&#35774;&#35745;&#65288;&#20010;&#20154;&#35266;&#28857;&#65289;&#65292;&#21508;&#20010;&#39537;&#21160;&#24037;&#31243;&#24072;&#22312;&#25776;&#20889;&#33258;&#24049;&#30340;&#39537;&#21160;&#20195;&#30721;&#30340;&#26102;&#20505;&#24050;&#32463;&#23433;&#25490;&#22909;&#20102;&#33258;&#24049;&#30340;&#19978;&#19979;&#25991;&#29615;&#22659;&#12290;&#26377;&#30340;&#26159;&#36827;&#31243;&#19978;&#19979;&#25991;&#65292;&#26377;&#30340;&#26159;&#20013;&#26029;&#19978;&#19979;&#25991;&#65292;&#22312;&#21508;&#33258;&#30340;&#19978;&#19979;&#25991;&#29615;&#22659;&#20013;&#65292;&#39537;&#21160;&#24037;&#31243;&#24072;&#21448;&#36873;&#25321;&#20102;&#36866;&#21512;&#30340;&#20869;&#26680;&#21516;&#27493;&#26426;&#21046;&#12290;&#20294;&#26159;&#65292;&#24378;&#21046;&#32447;&#31243;&#21270;&#23548;&#33268;&#21407;&#26469;&#36816;&#34892;&#22312;&#20013;&#26029;&#19978;&#19979;&#25991;&#30340;primary handler&#29616;&#22312;&#36816;&#34892;&#22312;&#36827;&#31243;&#19978;&#19979;&#25991;&#65292;&#36825;&#26377;&#21487;&#33021;&#23548;&#33268;&#19968;&#20123;&#38590;&#20197;&#36319;&#36394;&#21644;&#23450;&#20301;&#30340;bug&#12290; </P>
<P>&#24403;&#28982;&#65292;&#20316;&#20026;&#20869;&#26680;&#30340;&#24320;&#21457;&#32773;&#65292;&#26082;&#28982;&#21516;&#24847;&#23558;&#24378;&#21046;&#32447;&#31243;&#21270;&#36825;&#20010;&#29305;&#24615;&#24182;&#20837;linux kernel&#65292;&#30456;&#20449;&#20182;&#20204;&#26377;&#20182;&#20204;&#33258;&#24049;&#30340;&#32771;&#34385;&#12290;&#25105;&#29468;&#27979;&#36825;&#26159;&#21644;&#19968;&#20123;&#26087;&#30340;&#39537;&#21160;&#20195;&#30721;&#32500;&#25252;&#30456;&#20851;&#30340;&#12290;linux kernel&#20013;&#30340;&#20013;&#26029;&#23376;&#31995;&#32479;&#30340;API&#30340;&#20462;&#25913;&#20250;&#24341;&#36215;&#38750;&#24120;&#22823;&#30340;&#38663;&#21160;&#65292;&#22240;&#20026;&#20869;&#26680;&#20013;&#25104;&#21315;&#19978;&#19975;&#30340;&#39537;&#21160;&#37117;&#26159;&#38656;&#35201;&#35843;&#29992;&#26087;&#30340;&#25509;&#21475;&#26469;&#30003;&#35831;linux kernel&#20013;&#26029;&#23376;&#31995;&#32479;&#30340;&#26381;&#21153;&#65292;&#23545;&#27599;&#19968;&#20010;&#39537;&#21160;&#37117;&#36827;&#34892;&#20462;&#25913;&#26159;&#19968;&#20010;&#38750;&#24120;&#32791;&#26102;&#30340;&#24037;&#20316;&#65292;&#20026;&#20102;&#35753;&#37027;&#20123;&#26087;&#30340;&#39537;&#21160;&#20195;&#30721;&#21487;&#20197;&#36816;&#34892;&#22312;&#26032;&#30340;&#20013;&#26029;&#23376;&#31995;&#32479;&#19978;&#65292;&#22240;&#27492;&#65292;&#22312;kernel&#20013;&#65292;&#23454;&#38469;&#19978;&#20173;&#28982;&#25552;&#20379;&#20102;&#26087;&#30340;request_irq&#25509;&#21475;&#20989;&#25968;&#65292;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>static inline int __must_check <BR>request_irq(unsigned int irq, irq_handler_t handler, unsigned long flags, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *name, void *dev) <BR>{ <BR>&nbsp;&nbsp;&nbsp; return request_threaded_irq(irq, handler, NULL, flags, name, dev); <BR>} </P></BLOCKQUOTE>
<P>&#25509;&#21475;&#26159;OK&#20102;&#65292;&#20294;&#26159;&#65292;&#26032;&#30340;&#20013;&#26029;&#23376;&#31995;&#32479;&#30340;&#24605;&#36335;&#26159;&#23558;&#20013;&#26029;&#22788;&#29702;&#20998;&#25104;primary handler&#21644;threaded handler&#65292;&#32780;&#26087;&#30340;&#39537;&#21160;&#20195;&#30721;&#19968;&#33324;&#26159;&#23558;&#20013;&#26029;&#22788;&#29702;&#20998;&#25104;top half&#21644;bottom half&#65292;&#22914;&#20309;&#23558;&#36825;&#37096;&#20998;&#30340;&#19981;&#21516;&#25273;&#24179;&#65311;linux kernel&#26159;&#36825;&#26679;&#22788;&#29702;&#30340;&#65288;&#36825;&#26159;&#25105;&#20010;&#20154;&#30340;&#29702;&#35299;&#65292;&#19981;&#20445;&#35777;&#26159;&#27491;&#30830;&#30340;&#65289;&#65306; </P>
<P>&#65288;d-1&#65289;&#20869;&#26680;&#20026;&#37027;&#20123;&#34987;&#24378;&#21046;&#32447;&#31243;&#21270;&#30340;&#20013;&#26029;handler&#35774;&#23450;&#20102;IRQF_ONESHOT&#30340;&#26631;&#35782;&#12290;&#36825;&#26159;&#22240;&#20026;&#22312;&#26087;&#30340;&#20013;&#26029;&#22788;&#29702;&#26426;&#21046;&#20013;&#65292;top half&#26159;&#19981;&#21487;&#37325;&#20837;&#30340;&#65292;&#24378;&#21046;&#32447;&#31243;&#21270;&#20043;&#21518;&#65292;&#24378;&#21046;&#35774;&#23450;IRQF_ONESHOT&#21487;&#20197;&#20445;&#35777;threaded handler&#26159;&#19981;&#20250;&#37325;&#20837;&#30340;&#12290; </P>
<P>&#65288;d-2&#65289;&#22312;&#37027;&#20123;&#34987;&#24378;&#21046;&#32447;&#31243;&#21270;&#30340;&#20013;&#26029;&#32447;&#31243;&#20013;&#65292;disable bottom half&#30340;&#22788;&#29702;&#12290;&#36825;&#26159;&#22240;&#20026;&#22312;&#26087;&#30340;&#20013;&#26029;&#22788;&#29702;&#26426;&#21046;&#20013;&#65292;botton half&#26159;&#19981;&#21487;&#33021;&#25250;&#21344;top half&#30340;&#25191;&#34892;&#65292;&#24378;&#21046;&#32447;&#31243;&#21270;&#20043;&#21518;&#65292;&#24212;&#35813;&#20445;&#25345;&#36825;&#19968;&#28857;&#12290; </P>
<P>&nbsp; </P>
<P>&#65288;3&#65289;&#21019;&#24314;interrupt&#32447;&#31243;&#12290;&#20195;&#30721;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>if (new-&gt;thread_fn &amp;&amp; !nested) { <BR>&nbsp;&nbsp;&nbsp; struct task_struct *t; <BR>&nbsp;&nbsp;&nbsp; static const struct sched_param param = { <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .sched_priority = MAX_USER_RT_PRIO/2, <BR>&nbsp;&nbsp;&nbsp; }; </P>
<P>&nbsp;&nbsp;&nbsp; t = kthread_create(irq_thread, new, "irq/%d-%s", irq,&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;a&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new-&gt;name); </P>
<P>&nbsp;&nbsp;&nbsp; sched_setscheduler_nocheck(t, SCHED_FIFO, &#182;m); </P>
<P><BR>&nbsp;&nbsp;&nbsp; get_task_struct(t);&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;b&#65289; <BR>&nbsp;&nbsp;&nbsp; new-&gt;thread = t; <BR><BR>&nbsp;&nbsp;&nbsp; set_bit(IRQTF_AFFINITY, &amp;new-&gt;thread_flags);&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;c&#65289; <BR>} </P>
<P>if (!alloc_cpumask_var(&amp;mask, GFP_KERNEL)) {&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;d&#65289; <BR>&nbsp;&nbsp;&nbsp; ret = -ENOMEM; <BR>&nbsp;&nbsp;&nbsp; goto out_thread; <BR>} <BR>if (desc-&gt;irq_data.chip-&gt;flags &amp; IRQCHIP_ONESHOT_SAFE)&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;e&#65289; <BR>&nbsp;&nbsp;&nbsp; new-&gt;flags &amp;= ~IRQF_ONESHOT; </P></BLOCKQUOTE>
<P>&#65288;a&#65289;&#35843;&#29992;kthread_create&#26469;&#21019;&#24314;&#19968;&#20010;&#20869;&#26680;&#32447;&#31243;&#65292;&#24182;&#35843;&#29992;sched_setscheduler_nocheck&#26469;&#35774;&#23450;&#36825;&#20010;&#20013;&#26029;&#32447;&#31243;&#30340;&#35843;&#24230;&#31574;&#30053;&#21644;&#35843;&#24230;&#20248;&#20808;&#32423;&#12290;&#36825;&#20123;&#26159;&#21644;&#36827;&#31243;&#31649;&#29702;&#30456;&#20851;&#30340;&#20869;&#23481;&#65292;&#25105;&#20204;&#30041;&#21040;&#19979;&#19968;&#20010;&#19987;&#39064;&#20877;&#35814;&#32454;&#25551;&#36848;&#21543;&#12290; </P>
<P>&#65288;b&#65289;&#35843;&#29992;get_task_struct&#21487;&#20197;&#20026;&#36825;&#20010;threaded handler&#30340;task struct&#22686;&#21152;&#19968;&#27425;reference count&#65292;&#36825;&#26679;&#65292;&#21363;&#20415;&#26159;&#35813;thread&#24322;&#24120;&#36864;&#20986;&#20063;&#21487;&#20197;&#20445;&#35777;&#23427;&#30340;task struct&#19981;&#20250;&#34987;&#37322;&#25918;&#25481;&#12290;&#36825;&#21487;&#20197;&#20445;&#35777;&#20013;&#26029;&#31995;&#32479;&#30340;&#20195;&#30721;&#19981;&#20250;&#35775;&#38382;&#21040;&#19968;&#20123;&#34987;&#37322;&#25918;&#30340;&#20869;&#23384;&#12290;irqaction&#30340;thread &#25104;&#21592;&#34987;&#35774;&#23450;&#20026;&#21018;&#21018;&#21019;&#24314;&#30340;task&#65292;&#36825;&#26679;&#65292;primary handler&#23601;&#30693;&#36947;&#21796;&#37266;&#21738;&#19968;&#20010;&#20013;&#26029;&#32447;&#31243;&#20102;&#12290; </P>
<P>&#65288;c&#65289;&#35774;&#23450;IRQTF_AFFINITY&#30340;&#26631;&#24535;&#65292;&#22312;threaded handler&#20013;&#20250;&#26816;&#26597;&#35813;&#26631;&#24535;&#24182;&#36827;&#34892;IRQ affinity&#30340;&#35774;&#23450;&#12290; </P>
<P>&#65288;d&#65289;&#20998;&#37197;&#19968;&#20010;cpu mask&#30340;&#21464;&#37327;&#30340;&#20869;&#23384;&#65292;&#21518;&#38754;&#20250;&#20351;&#29992;&#21040; </P>
<P>&#65288;e&#65289;&#39537;&#21160;&#24037;&#31243;&#24072;&#26159;&#25776;&#20889;&#20855;&#20307;&#22806;&#35774;&#39537;&#21160;&#30340;&#65292;&#20182;/&#22905;&#26410;&#24517;&#20250;&#20102;&#35299;&#21040;&#24213;&#23618;&#30340;&#19968;&#20123;&#20855;&#20307;&#30340;interrupt controller&#30340;&#20449;&#24687;&#12290;&#26377;&#20123;interrupt controller&#65288;&#20363;&#22914;MSI based interrupt&#65289;&#26412;&#36136;&#19978;&#23601;&#26159;&#23601;&#26159;one shot&#30340;&#65288;&#36890;&#36807;IRQCHIP_ONESHOT_SAFE&#26631;&#35760;&#65289;&#65292;&#22240;&#27492;&#39537;&#21160;&#24037;&#31243;&#24072;&#35774;&#23450;&#30340;IRQF_ONESHOT&#20854;&#23454;&#26159;&#30011;&#34503;&#28155;&#36275;&#65292;&#22240;&#27492;&#21487;&#20197;&#21435;&#25481;&#12290; </P>
<P>&nbsp; </P>
<P>&#65288;4&#65289;&#20849;&#20139;&#20013;&#26029;&#30340;&#26816;&#26597;&#12290;&#20195;&#30721;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>old_ptr = &amp;desc-&gt;action; <BR>old = *old_ptr; </P>
<P>if (old) { <BR>&nbsp;&nbsp;&nbsp; if (!((old-&gt;flags &amp; new-&gt;flags) &amp; IRQF_SHARED) ||&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;a&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((old-&gt;flags ^ new-&gt;flags) &amp; IRQF_TRIGGER_MASK) || <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((old-&gt;flags ^ new-&gt;flags) &amp; IRQF_ONESHOT)) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto mismatch; </P>
<P>&nbsp;&nbsp;&nbsp; /* All handlers must agree on per-cpuness */ <BR>&nbsp;&nbsp;&nbsp; if ((old-&gt;flags &amp; IRQF_PERCPU) != (new-&gt;flags &amp; IRQF_PERCPU)) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto mismatch; </P>
<P>&nbsp;&nbsp;&nbsp; /* add new interrupt at end of irq queue */ <BR>&nbsp;&nbsp;&nbsp; do {&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;b&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; thread_mask |= old-&gt;thread_mask; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; old_ptr = &amp;old-&gt;next; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; old = *old_ptr; <BR>&nbsp;&nbsp;&nbsp; } while (old); <BR>&nbsp;&nbsp;&nbsp; shared = 1; <BR>} </P></BLOCKQUOTE>
<P>&#65288;a&#65289;old&#25351;&#21521;&#27880;&#20876;&#20043;&#21069;&#30340;action list&#65292;&#22914;&#26524;&#19981;&#26159;NULL&#65292;&#37027;&#20040;&#35828;&#26126;&#38656;&#35201;&#20849;&#20139;interrupt line&#12290;&#20294;&#26159;&#22914;&#26524;&#35201;&#20849;&#20139;&#65292;&#38656;&#35201;&#27599;&#19968;&#20010;irqaction&#37117;&#21516;&#24847;&#20849;&#20139;&#65288;IRQF_SHARED&#65289;&#65292;&#27599;&#19968;&#20010;irqaction&#30340;&#35302;&#21457;&#26041;&#24335;&#30456;&#21516;&#65288;&#37117;&#26159;level trigger&#25110;&#32773;&#37117;&#26159;edge trigger&#65289;&#65292;&#30456;&#21516;&#30340;oneshot&#31867;&#22411;&#30340;&#20013;&#26029;&#65288;&#37117;&#26159;one shot&#25110;&#32773;&#37117;&#19981;&#26159;&#65289;&#65292;per cpu&#31867;&#22411;&#30340;&#30456;&#21516;&#20013;&#26029;&#65288;&#37117;&#26159;per cpu&#30340;&#20013;&#26029;&#25110;&#32773;&#37117;&#19981;&#26159;&#65289;&#12290; </P>
<P>&#65288;b&#65289;&#23558;&#35813;irqaction&#25346;&#20837;&#38431;&#21015;&#30340;&#23614;&#37096;&#12290; </P>
<P>&nbsp; </P>
<P>&#65288;5&#65289;thread mask&#30340;&#35774;&#23450;&#12290;&#20195;&#30721;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>if (new-&gt;flags &amp; IRQF_ONESHOT) { <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (thread_mask == ~0UL) {&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;a&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret = -EBUSY; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto out_mask; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new-&gt;thread_mask = 1 &lt;&lt; ffz(thread_mask); </P>
<P>&nbsp;&nbsp;&nbsp; } else if (new-&gt;handler == irq_default_primary_handler &amp;&amp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; !(desc-&gt;irq_data.chip-&gt;flags &amp; IRQCHIP_ONESHOT_SAFE)) {&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65293;&#65288;b&#65289; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret = -EINVAL; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto out_mask; <BR>&nbsp;&nbsp;&nbsp; } </P></BLOCKQUOTE>
<P>&#23545;&#20110;one shot&#31867;&#22411;&#30340;&#20013;&#26029;&#65292;&#25105;&#20204;&#36824;&#38656;&#35201;&#35774;&#23450;thread mask&#12290;&#22914;&#26524;&#19968;&#20010;one shot&#31867;&#22411;&#30340;&#20013;&#26029;&#21482;&#26377;&#19968;&#20010;threaded handler&#65288;&#19981;&#25903;&#25345;&#20849;&#20139;&#65289;&#65292;&#37027;&#20040;&#20107;&#24773;&#23601;&#24456;&#31616;&#21333;&#65288;&#20020;&#26102;&#21464;&#37327;thread_mask&#31561;&#20110;0&#65289;&#65292;&#35813;irqaction&#30340;thread_mask&#25104;&#21592;&#24635;&#26159;&#20351;&#29992;&#31532;&#19968;&#20010;bit&#26469;&#26631;&#35782;&#35813;irqaction&#12290;&#20294;&#26159;&#65292;&#22914;&#26524;&#25903;&#25345;&#20849;&#20139;&#30340;&#35805;&#65292;&#20107;&#24773;&#21464;&#24471;&#26377;&#28857;&#22797;&#26434;&#12290;&#25105;&#20204;&#20551;&#35774;&#36825;&#20010;one shot&#31867;&#22411;&#30340;IRQ&#19978;&#26377;A&#65292;B&#21644;C&#19977;&#20010;irqaction&#65292;&#37027;&#20040;A&#65292;B&#21644;C&#19977;&#20010;irqaction&#30340;thread_mask&#25104;&#21592;&#20250;&#26377;&#19981;&#21516;&#30340;bit&#26469;&#26631;&#35782;&#33258;&#24049;&#12290;&#20363;&#22914;A&#30340;thread_mask&#25104;&#21592;&#26159;0x01&#65292;B&#30340;&#26159;0x02&#65292;C&#30340;&#26159;0x04&#65292;&#22914;&#26524;&#26377;&#26356;&#22810;&#20849;&#20139;&#30340;irqaction&#65288;&#24517;&#39035;&#26159;oneshot&#31867;&#22411;&#65289;&#65292;&#37027;&#20040;&#20854;thread_mask&#25104;&#21592;&#20250;&#20381;&#27425;&#35774;&#23450;&#20026;0x08&#65292;0x10&#8230;&#8230; </P>
<P>&#65288;a&#65289;&#22312;&#19978;&#38754;&#8220;&#20849;&#20139;&#20013;&#26029;&#30340;&#26816;&#26597;&#8221;&#36825;&#20010;section&#20013;&#65292;thread_mask&#21464;&#37327;&#20445;&#23384;&#20102;&#25152;&#26377;&#30340;&#23646;&#20110;&#35813;interrupt line&#30340;thread_mask&#65292;&#36825;&#26102;&#20505;&#65292;&#22914;&#26524;thread_mask&#21464;&#37327;&#22914;&#26524;&#26159;&#20840;1&#65292;&#37027;&#20040;&#35828;&#26126;irqaction list&#19978;&#24050;&#32463;&#26377;&#20102;&#22826;&#22810;&#30340;irq action&#65288;&#22823;&#20110;32&#25110;&#32773;64&#65292;&#21644;&#20855;&#20307;&#31995;&#32479;&#21644;&#32534;&#35793;&#22120;&#30456;&#20851;&#65289;&#12290;&#22914;&#26524;&#27809;&#26377;&#28385;&#65292;&#37027;&#20040;&#36890;&#36807;ffz&#20989;&#25968;&#25214;&#21040;&#31532;&#19968;&#20010;&#20026;0&#30340;bit&#20316;&#20026;&#35813;irq action&#30340;thread bit mask&#12290; </P>
<P>&#65288;b&#65289;irq_default_primary_handler&#30340;&#20195;&#30721;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>static irqreturn_t irq_default_primary_handler(int irq, void *dev_id) <BR>{ <BR>&nbsp;&nbsp;&nbsp; return IRQ_WAKE_THREAD; <BR>} </P></BLOCKQUOTE>
<P>&#20195;&#30721;&#38750;&#24120;&#30340;&#31616;&#21333;&#65292;&#36820;&#22238;IRQ_WAKE_THREAD&#65292;&#35753;kernel&#21796;&#37266;threaded handler&#23601;OK&#20102;&#12290;&#20351;&#29992;irq_default_primary_handler&#34429;&#28982;&#31616;&#21333;&#65292;&#20294;&#26159;&#26377;&#19968;&#20010;&#39118;&#38505;&#65306;&#22914;&#26524;&#26159;&#30005;&#24179;&#35302;&#21457;&#30340;&#20013;&#26029;&#65292;&#25105;&#20204;&#38656;&#35201;&#25805;&#20316;&#22806;&#35774;&#30340;&#23492;&#23384;&#22120;&#25165;&#21487;&#20197;&#35753;&#37027;&#20010;asserted&#30340;&#30005;&#24179;&#20449;&#21495;&#28040;&#22833;&#65292;&#21542;&#21017;&#23427;&#20250;&#19968;&#30452;&#25345;&#32493;&#12290;&#19968;&#33324;&#65292;&#25105;&#20204;&#37117;&#26159;&#30452;&#25509;&#22312;primary&#20013;&#25805;&#20316;&#22806;&#35774;&#23492;&#23384;&#22120;&#65288;slow bus&#31867;&#22411;&#30340;interrupt controller&#19981;&#34892;&#65289;&#65292;&#23613;&#26089;&#30340;clear interrupt&#65292;&#20294;&#26159;&#65292;&#23545;&#20110;irq_default_primary_handler&#65292;&#23427;&#20165;&#20165;&#26159;wakeup&#20102;threaded interrupt handler&#65292;&#24182;&#27809;&#26377;clear interrupt&#65292;&#36825;&#26679;&#65292;&#25191;&#34892;&#23436;&#20102;primary handler&#65292;&#22806;&#35774;&#20013;&#26029;&#20173;&#28982;&#26159;asserted&#65292;&#19968;&#26086;&#25171;&#24320;CPU&#20013;&#26029;&#65292;&#31435;&#21051;&#35302;&#21457;&#19979;&#19968;&#27425;&#30340;&#20013;&#26029;&#65292;&#28982;&#21518;&#19981;&#26029;&#30340;&#24490;&#29615;&#12290;&#22240;&#27492;&#65292;&#22914;&#26524;&#27880;&#20876;&#20013;&#26029;&#30340;&#26102;&#20505;&#27809;&#26377;&#25351;&#23450;primary interrupt handler&#65292;&#24182;&#19988;&#27809;&#26377;&#35774;&#23450;IRQF_ONESHOT&#65292;&#37027;&#20040;&#31995;&#32479;&#26159;&#20250;&#25253;&#38169;&#30340;&#12290;&#24403;&#28982;&#65292;&#26377;&#19968;&#31181;&#24773;&#20917;&#21487;&#20197;&#35905;&#20813;&#65292;&#24403;&#24213;&#23618;&#30340;irq chip&#26159;one shot safe&#30340;&#65288;IRQCHIP_ONESHOT_SAFE&#65289;&#12290; </P>
<P>&#65288;6&#65289;&#29992;&#25143;IRQ flag&#21644;&#24213;&#23618;interrupt flag&#30340;&#21516;&#27493;&#65288;TODO&#65289;