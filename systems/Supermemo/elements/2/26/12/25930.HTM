<H2>Concurrency Managed Workqueue&#20043;&#65288;&#20108;&#65289;&#65306;CMWQ&#27010;&#36848;</H2>
<P class=date>&#20316;&#32773;&#65306;<A href="http://www.wowotech.net/author/3">linuxer</A> &#21457;&#24067;&#20110;&#65306;2015-7-31 12:29 &#20998;&#31867;&#65306;<A href="http://www.wowotech.net/sort/irq_subsystem">&#20013;&#26029;&#23376;&#31995;&#32479;</A> </P>
<P>&#19968;&#12289;&#21069;&#35328; </P>
<P>&#19968;&#31181;&#26032;&#30340;&#26426;&#21046;&#20986;&#29616;&#30340;&#21407;&#22240;&#24448;&#24448;&#26159;&#20026;&#20102;&#35299;&#20915;&#23454;&#38469;&#30340;&#38382;&#39064;&#65292;&#34429;&#28982;linux kernel&#20013;&#24050;&#32463;&#25552;&#20379;&#20102;workqueue&#30340;&#26426;&#21046;&#65292;&#37027;&#20040;&#20026;&#20309;&#36824;&#35201;&#24341;&#20837;cmwq&#21602;&#65311;&#20063;&#23601;&#26159;&#35828;&#65306;&#26087;&#30340;workqueue&#26426;&#21046;&#23384;&#22312;&#20160;&#20040;&#26679;&#30340;&#38382;&#39064;&#65311;&#22312;&#26032;&#30340;cmwq&#21448;&#26159;&#22914;&#20309;&#35299;&#20915;&#36825;&#20123;&#38382;&#39064;&#30340;&#21602;&#65311;&#23427;&#25509;&#21475;&#26159;&#22914;&#20309;&#21576;&#29616;&#30340;&#21602;&#65288;&#39537;&#21160;&#24037;&#31243;&#24072;&#26368;&#20851;&#24515;&#36825;&#20010;&#20102;&#65289;&#65311;&#22914;&#20309;&#20860;&#23481;&#26087;&#30340;&#39537;&#21160;&#21602;&#65311;&#26412;&#25991;&#24076;&#26395;&#21487;&#20197;&#35299;&#24320;&#36825;&#20123;&#35868;&#39064;&#12290; </P>
<P>&#26412;&#25991;&#30340;&#20195;&#30721;&#26469;&#33258;linux kernel 4.0&#12290; </P>
<P>&nbsp; </P>
<P>&#20108;&#12289;&#20026;&#20309;&#38656;&#35201;CMWQ&#65311; </P>
<P>&#20869;&#26680;&#20013;&#24456;&#22810;&#22330;&#26223;&#38656;&#35201;&#24322;&#27493;&#25191;&#34892;&#29615;&#22659;&#65288;&#22312;&#39537;&#21160;&#20013;&#23588;&#20854;&#24120;&#35265;&#65289;&#65292;&#36825;&#26102;&#20505;&#65292;&#25105;&#20204;&#38656;&#35201;&#23450;&#20041;&#19968;&#20010;work&#65288;&#25191;&#34892;&#21738;&#19968;&#20010;&#20989;&#25968;&#65289;&#24182;&#25346;&#20837;workqueue&#12290;&#22788;&#29702;&#35813;work&#30340;&#32447;&#31243;&#21483;&#20570;worker&#65292;&#19981;&#26029;&#30340;&#22788;&#29702;&#38431;&#21015;&#20013;&#30340;work&#65292;&#24403;&#22788;&#29702;&#23436;&#27605;&#21518;&#21017;&#20241;&#30496;&#65292;&#38431;&#21015;&#20013;&#26377;work&#30340;&#26102;&#20505;&#23601;&#37266;&#26469;&#22788;&#29702;&#65292;&#22914;&#27492;&#21608;&#32780;&#22797;&#22987;&#12290;&#19968;&#20999;&#30475;&#36215;&#26469;&#27604;&#36739;&#23436;&#32654;&#65292;&#38382;&#39064;&#20986;&#22312;&#21738;&#37324;&#21602;&#65311; </P>
<P>&#65288;1&#65289;&#20869;&#26680;&#32447;&#31243;&#25968;&#37327;&#22826;&#22810;&#12290;&#22914;&#26524;&#27809;&#26377;&#36275;&#22815;&#30340;&#20869;&#26680;&#30693;&#35782;&#65292;&#31243;&#24207;&#21592;&#26377;&#21487;&#33021;&#20250;&#38169;&#35823;&#30340;&#20351;&#29992;workqueue&#26426;&#21046;&#65292;&#20174;&#32780;&#23548;&#33268;&#36825;&#20010;&#26426;&#21046;&#34987;&#29609;&#22351;&#12290;&#20363;&#22914;&#26126;&#26126;&#21487;&#20197;&#20351;&#29992;default workqueue&#65292;&#20559;&#20559;&#33258;&#24049;&#21019;&#24314;&#23646;&#20110;&#33258;&#24049;&#30340;workqueue&#65292;&#36825;&#26679;&#19968;&#26469;&#65292;&#23545;&#20110;&#37027;&#20123;&#27604;&#36739;&#22823;&#22411;&#30340;&#31995;&#32479;&#65288;CPU&#20010;&#25968;&#27604;&#36739;&#22810;&#65289;&#65292;&#24456;&#21487;&#33021;&#20869;&#26680;&#21551;&#21160;&#32467;&#26463;&#21518;&#23601;&#32791;&#23613;&#20102;PID space&#65288;default&#26368;&#22823;&#20540;&#26159;65535&#65289;&#65292;&#36825;&#31181;&#24773;&#20917;&#19979;&#65292;&#20320;&#35753;user space&#30340;&#31243;&#24207;&#24773;&#20309;&#20197;&#22570;&#65311;&#34429;&#28982;default&#26368;&#22823;&#20540;&#26159;&#21487;&#20197;&#20462;&#25913;&#30340;&#65292;&#20174;&#32780;&#25193;&#22823;PID space&#26469;&#35299;&#20915;&#36825;&#20010;&#38382;&#39064;&#65292;&#19981;&#36807;&#31995;&#32479;&#22826;&#22810;&#30340;task&#20250;&#23545;&#25972;&#20307;performance&#36896;&#25104;&#36127;&#38754;&#24433;&#21709;&#12290; </P>
<P>&#65288;2&#65289;&#23613;&#31649;&#28040;&#32791;&#20102;&#24456;&#22810;&#36164;&#28304;&#65292;&#20294;&#26159;&#24182;&#21457;&#24615;&#22914;&#20309;&#21602;&#65311;&#25105;&#20204;&#20808;&#30475;single threaded&#30340;workqueue&#65292;&#36825;&#31181;&#24773;&#20917;&#23436;&#20840;&#27809;&#26377;&#24182;&#21457;&#30340;&#27010;&#24565;&#65292;&#20219;&#20309;&#30340;work&#37117;&#26159;&#25490;&#38431;&#25191;&#34892;&#65292;&#22914;&#26524;&#27491;&#22312;&#25191;&#34892;&#30340;work&#24456;&#24930;&#65292;&#20363;&#22914;4&#65374;5&#31186;&#30340;&#26102;&#38388;&#65292;&#37027;&#20040;&#38431;&#21015;&#20013;&#30340;&#20854;&#20182;work&#38500;&#20102;&#31561;&#24453;&#21035;&#26080;&#36873;&#25321;&#12290;multi threaded&#65288;&#26356;&#20934;&#30830;&#30340;&#26159;per-CPU threaded&#65289;&#24773;&#20917;&#24403;&#28982;&#20250;&#22909;&#19968;&#20123;&#65288;&#27605;&#31455;&#22810;&#28040;&#32791;&#20102;&#36164;&#28304;&#65289;&#65292;&#20294;&#26159;&#23545;&#24182;&#21457;&#20173;&#28982;&#22788;&#29702;&#30340;&#19981;&#26159;&#24456;&#22909;&#12290;&#23545;&#20110;multi threaded workqueue&#65292;&#34429;&#28982;&#21019;&#24314;&#20102;thread pool&#65292;&#20294;&#26159;thread pool&#30340;&#25968;&#30446;&#26159;&#22266;&#23450;&#30340;&#65306;&#27599;&#20010;oneline&#30340;cpu&#19978;&#36816;&#34892;&#19968;&#20010;&#65292;&#32780;&#19988;&#26159;&#20005;&#26684;&#30340;&#32465;&#23450;&#20851;&#31995;&#12290;&#20063;&#23601;&#26159;&#35828;&#26412;&#26469;&#32447;&#31243;&#27744;&#26159;&#19968;&#20010;&#24456;&#22909;&#30340;&#27010;&#24565;&#65292;&#20294;&#26159;&#20256;&#32479;workqueue&#19978;&#30340;&#32447;&#31243;&#27744;&#65288;&#25110;&#32773;&#21483;&#20570;worker pool&#65289;&#21364;&#20998;&#21106;&#20102;&#27599;&#20010;&#32447;&#31243;&#65292;&#32447;&#31243;&#20043;&#38388;&#19981;&#33021;&#20114;&#36890;&#26377;&#26080;&#12290;&#20363;&#22914;cpu0&#19978;&#30340;worker thread&#30001;&#20110;&#22788;&#29702;work&#32780;&#36827;&#20837;&#38459;&#22622;&#29366;&#24577;&#65292;&#37027;&#20040;&#35813;worker thread&#22788;&#29702;&#30340;work queue&#20013;&#30340;&#20854;&#20182;work&#37117;&#38459;&#22622;&#20303;&#65292;&#19981;&#33021;&#36716;&#31227;&#21040;&#20854;&#20182;cpu&#19978;&#30340;worker thread&#21435;&#65292;&#26356;&#26377;&#29978;&#32773;&#65292;cpu0&#19978;&#38543;&#21518;&#25346;&#20837;&#30340;work&#20063;&#25509;&#21463;&#21516;&#26679;&#30340;&#21629;&#36816;&#65288;&#22312;&#26576;&#20010;cpu&#19978;schedule&#30340;work&#19968;&#23450;&#20250;&#36816;&#34892;&#22312;&#37027;&#20010;cpu&#19978;&#65289;&#65292;&#19981;&#33021;&#21435;&#20854;&#20182;&#31354;&#38386;&#30340;worker thread&#19978;&#25191;&#34892;&#12290;&#30001;&#20110;&#19981;&#33021;&#25552;&#20379;&#24456;&#22909;&#30340;&#24182;&#21457;&#24615;&#65292;&#26377;&#20123;&#20869;&#26680;&#27169;&#22359;&#65288;fscache&#65289;&#29978;&#33267;&#33258;&#24049;&#21019;&#24314;&#20102;thread pool&#65288;slow work&#20063;&#26366;&#32463;&#30701;&#26242;&#30340;&#20986;&#29616;&#22312;kernel&#20013;&#65289;&#12290; </P>
<P>&#65288;3&#65289;dead lock&#38382;&#39064;&#12290;&#25105;&#20204;&#20030;&#19968;&#20010;&#31616;&#21333;&#30340;&#20363;&#23376;&#65306;&#25105;&#20204;&#30693;&#36947;&#65292;&#31995;&#32479;&#26377;default workqueue&#65292;&#22914;&#26524;&#27809;&#26377;&#29305;&#21035;&#38656;&#27714;&#65292;&#39537;&#21160;&#24037;&#31243;&#24072;&#37117;&#21916;&#27426;&#29992;&#36825;&#20010;workqueue&#12290;&#25105;&#20204;&#30340;&#39537;&#21160;&#27169;&#22359;&#22312;&#22788;&#29702;release&#65288;userspace close&#35813;&#35774;&#22791;&#65289;&#20989;&#25968;&#30340;&#26102;&#20505;&#65292;&#30001;&#20110;&#20351;&#29992;&#20102;workqueue&#65292;&#37027;&#20040;&#19968;&#33324;&#20250;flush&#25972;&#20010;workqueue&#65292;&#20197;&#20415;&#30830;&#20445;&#26412;driver&#30340;&#25152;&#26377;&#20107;&#23452;&#37117;&#24050;&#32463;&#22788;&#29702;&#23436;&#27605;&#65288;&#22312;close&#30340;&#26102;&#20505;&#24456;&#26377;&#21487;&#33021;&#26377;pending&#30340;work&#65292;&#22240;&#27492;&#35201;flush&#65289;&#65292;&#22823;&#27010;&#30340;&#20195;&#30721;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P><SPAN style="BACKGROUND-COLOR: rgb(255,255,255)">&#33719;&#21462;&#38145;A</SPAN> </P>
<P><SPAN style="BACKGROUND-COLOR: rgb(255,255,255)">flush workqueue</SPAN> </P>
<P><SPAN style="BACKGROUND-COLOR: rgb(255,255,255)">&#37322;&#25918;&#38145;A</SPAN> </P></BLOCKQUOTE>
<P>flush work&#26159;&#19968;&#20010;&#38271;&#26399;&#36807;&#31243;&#65292;&#22240;&#27492;&#24456;&#26377;&#21487;&#33021;&#34987;&#35843;&#24230;&#20986;&#21435;&#65292;&#36825;&#26679;&#35843;&#29992;close&#30340;&#36827;&#31243;&#34987;&#38459;&#22622;&#65292;&#31561;&#21040;keventd_wq&#36825;&#20010;&#20869;&#26680;&#32447;&#31243;&#32452;&#23436;&#25104;flush&#25805;&#20316;&#21518;&#23601;&#20250;wakeup&#35813;&#36827;&#31243;&#12290;&#20294;&#26159;&#36825;&#20010;default workqueue&#20351;&#29992;&#24456;&#24191;&#65292;&#20854;&#20182;&#30340;&#27169;&#22359;&#20063;&#21487;&#33021;&#20250;schedule work&#21040;&#35813;workqueue&#20013;&#65292;&#24182;&#19988;&#22914;&#26524;&#36825;&#20123;&#27169;&#22359;&#30340;work&#20063;&#38656;&#35201;&#33719;&#21462;&#38145;A&#65292;&#37027;&#20040;&#23601;&#20250;deadlock&#65288;keventd_wq&#38459;&#22622;&#65292;&#20877;&#20063;&#26080;&#27861;&#21796;&#37266;&#31561;&#24453;flush&#30340;&#36827;&#31243;&#65289;&#12290;&#35299;&#20915;&#36825;&#20010;&#38382;&#39064;&#30340;&#26041;&#27861;&#26159;&#21019;&#24314;&#22810;&#20010;workqueue&#65292;&#20294;&#26159;&#36825;&#26679;&#21448;&#22238;&#21040;&#20102;&#20869;&#26680;&#32447;&#31243;&#25968;&#37327;&#22823;&#22810;&#30340;&#38382;&#39064;&#19978;&#26469;&#12290; </P>
<P>&#25105;&#20204;&#20877;&#30475;&#19968;&#20010;&#20363;&#23376;&#65306;&#20551;&#35774;&#26576;&#20010;&#39537;&#21160;&#27169;&#22359;&#27604;&#36739;&#22797;&#26434;&#65292;&#20351;&#29992;&#20102;&#20004;&#20010;work struct&#65292;&#20998;&#21035;&#26159;A&#21644;B&#65292;&#22914;&#26524;work A&#20381;&#36182; work B&#30340;&#25191;&#34892;&#32467;&#26524;&#65292;&#37027;&#20040;&#65292;&#22914;&#26524;&#36825;&#20004;&#20010;work&#37117;schedule&#21040;&#19968;&#20010;worker thread&#30340;&#26102;&#20505;&#23601;&#20986;&#29616;&#38382;&#39064;&#65292;&#30001;&#20110;worker thread&#19981;&#33021;&#24182;&#21457;&#30340;&#25191;&#34892;work A&#21644;work B&#65292;&#22240;&#27492;&#35813;&#39537;&#21160;&#27169;&#22359;&#20250;&#27515;&#38145;&#12290;Multi threaded workqueue&#33021;&#20943;&#36731;&#36825;&#20010;&#38382;&#39064;&#65292;&#20294;&#26159;&#26080;&#27861;&#35299;&#20915;&#35813;&#38382;&#39064;&#65292;&#27605;&#31455;work A&#21644;work B&#36824;&#26159;&#26377;&#26426;&#20250;&#35843;&#24230;&#21040;&#19968;&#20010;cpu&#19978;&#25191;&#34892;&#12290;&#36896;&#25104;&#36825;&#20123;&#38382;&#39064;&#30340;&#26681;&#26412;&#21407;&#22240;&#26159;&#20247;&#22810;&#30340;work&#31454;&#20105;&#19968;&#20010;&#25191;&#34892;&#19978;&#19979;&#25991;&#23548;&#33268;&#30340;&#12290; </P>
<P>&#65288;4&#65289;&#20108;&#20803;&#21270;&#30340;&#32447;&#31243;&#27744;&#26426;&#21046;&#12290;&#22522;&#26412;&#19978;workqueue&#20063;&#26159;thread pool&#30340;&#19968;&#31181;&#65292;&#20294;&#26159;&#21019;&#24314;&#30340;&#32447;&#31243;&#25968;&#30446;&#26159;&#20108;&#20803;&#21270;&#30340;&#35774;&#23450;&#65306;&#35201;&#20040;&#26159;1&#65292;&#35201;&#20040;&#26159;number of CPU&#65292;&#20294;&#26159;&#65292;&#26377;&#20123;&#22330;&#26223;&#20013;&#65292;&#21019;&#24314;number of CPU&#22826;&#22810;&#65292;&#32780;&#21019;&#24314;&#19968;&#20010;&#32447;&#31243;&#21448;&#22826;&#23569;&#65292;&#36825;&#26102;&#20505;&#65292;&#21193;&#24378;&#20351;&#29992;&#20102;single threaded workqueue&#65292;&#20294;&#26159;&#19981;&#24471;&#19981;&#25509;&#21463;&#20018;&#34892;&#22788;&#29702;work&#65292;&#20351;&#29992;multi threaded workqueue&#21543;&#65292;&#21344;&#29992;&#36164;&#28304;&#22826;&#22810;&#12290;&#20108;&#20803;&#21270;&#30340;&#32447;&#31243;&#27744;&#26426;&#21046;&#35753;&#29992;&#25143;&#26080;&#25152;&#36866;&#20174;&#12290; </P>
<P>&nbsp; </P>
<P>&#19977;&#12289;CMWQ&#22914;&#20309;&#35299;&#20915;&#38382;&#39064;&#30340;&#21602;&#65311; </P>
<P>1&#12289;&#35774;&#35745;&#21407;&#21017;&#12290;&#22312;&#36827;&#34892;CMWQ&#30340;&#26102;&#20505;&#36981;&#24490;&#19979;&#38754;&#20004;&#20010;&#21407;&#21017;&#65306; </P>
<P>&#65288;1&#65289;&#21644;&#26087;&#30340;workqueue&#25509;&#21475;&#20860;&#23481;&#12290; </P>
<P>&#65288;2&#65289;&#26126;&#30830;&#30340;&#21010;&#20998;&#20102;workqueue&#30340;&#21069;&#31471;&#25509;&#21475;&#21644;&#21518;&#31471;&#23454;&#29616;&#26426;&#21046;&#12290;CMWQ&#30340;&#25972;&#20307;&#26550;&#26500;&#22914;&#19979;&#65306; </P>
<P><A href="http://www.wowotech.net/content/uploadfile/201507/9c45a683d212959582073233b703346720150731042811.gif"><IMG title=cmwq style="BORDER-LEFT-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px" border=0 alt=cmwq src="http://www.wowotech.net/content/uploadfile/201507/fa89b634ddda99e7d302bee62a00f57520150731042913.gif" width=705 height=320></A> </P>
<P>&#23545;&#20110;workqueue&#30340;&#29992;&#25143;&#32780;&#35328;&#65292;&#21069;&#31471;&#30340;&#25805;&#20316;&#21253;&#25324;&#20108;&#31181;&#65292;&#19968;&#20010;&#26159;&#21019;&#24314;workqueue&#12290;&#21487;&#20197;&#36873;&#25321;&#21019;&#24314;&#33258;&#24049;&#30340;workqueue&#65292;&#24403;&#28982;&#20063;&#21487;&#20197;&#19981;&#21019;&#24314;&#32780;&#26159;&#20351;&#29992;&#31995;&#32479;&#32570;&#30465;&#30340;workqueue&#12290;&#21478;&#22806;&#19968;&#20010;&#25805;&#20316;&#23601;&#26159;&#23558;&#25351;&#23450;&#30340;work&#28155;&#21152;&#21040;workqueue&#12290;&#22312;&#26087;&#30340;workqueue&#26426;&#21046;&#20013;&#65292;workqueue&#21644;worker thread&#26159;&#23494;&#20999;&#32852;&#31995;&#30340;&#27010;&#24565;&#65292;&#23545;&#20110;single workqueue&#65292;&#21019;&#24314;&#19968;&#20010;&#31995;&#32479;&#33539;&#22260;&#30340;worker thread&#65292;&#23545;&#20110;multi workqueue&#65292;&#21019;&#24314;per-CPU&#30340;worker thread&#65292;&#19968;&#20999;&#37117;&#26159;&#22266;&#23450;&#27515;&#30340;&#12290;&#38024;&#23545;&#36825;&#26679;&#30340;&#35774;&#35745;&#65292;&#25105;&#20204;&#21487;&#20197;&#36827;&#19968;&#27493;&#24605;&#32771;&#20854;&#21512;&#29702;&#24615;&#12290;workqueue&#29992;&#25143;&#30340;&#38656;&#27714;&#23601;&#26159;&#19968;&#20010;&#24322;&#27493;&#25191;&#34892;&#30340;&#29615;&#22659;&#65292;&#25226;&#21019;&#24314;workqueue&#21644;&#21019;&#24314;worker thread&#32465;&#23450;&#36215;&#26469;&#22823;&#22823;&#38480;&#23450;&#20102;&#36164;&#28304;&#30340;&#20351;&#29992;&#65292;&#20854;&#23454;&#20855;&#20307;&#21518;&#21488;&#26159;&#22914;&#20309;&#22788;&#29702;work&#65292;&#26159;&#21542;&#21542;&#21551;&#21160;&#20102;&#22810;&#20010;thread&#65292;&#22914;&#20309;&#31649;&#29702;&#22810;&#20010;&#32447;&#31243;&#20043;&#38388;&#30340;&#21327;&#35843;&#65292;workqueue&#30340;&#29992;&#25143;&#24182;&#19981;&#20851;&#24515;&#12290; </P>
<P>&#22522;&#20110;&#36825;&#26679;&#30340;&#24605;&#32771;&#65292;&#22312;CMWQ&#20013;&#65292;&#23558;&#36825;&#31181;&#22266;&#23450;&#30340;&#20851;&#31995;&#34987;&#25171;&#30772;&#65292;&#25552;&#20986;&#20102;worker pool&#36825;&#26679;&#30340;&#27010;&#24565;&#65288;&#20854;&#23454;&#23601;&#26159;&#19968;&#31181;thread pool&#30340;&#27010;&#24565;&#65289;&#65292;&#20063;&#23601;&#26159;&#35828;&#65292;&#31995;&#32479;&#20013;&#23384;&#22312;&#33509;&#24178;worker pool&#65292;&#19981;&#21644;&#29305;&#23450;&#30340;workqueue&#20851;&#32852;&#65292;&#32780;&#26159;&#25152;&#26377;&#30340;workqueue&#20849;&#20139;&#12290;&#29992;&#25143;&#21487;&#20197;&#21019;&#24314;workqueue&#65288;&#19981;&#21019;&#24314;worker pool&#65289;&#24182;&#36890;&#36807;flag&#26469;&#32422;&#26463;&#25346;&#20837;&#35813;workqueue&#19978;work&#30340;&#22788;&#29702;&#26041;&#24335;&#12290;workqueue&#20250;&#26681;&#25454;&#20854;flag&#23558;work&#20132;&#20184;&#32473;&#31995;&#32479;&#20013;&#26576;&#20010;worker pool&#22788;&#29702;&#12290;&#20363;&#22914;&#22914;&#26524;&#35813;workqueue&#26159;bounded&#31867;&#22411;&#24182;&#19988;&#35774;&#23450;&#20102;high priority&#65292;&#37027;&#20040;&#25346;&#20837;&#35813;workqueue&#30340;work&#23558;&#30001;per cpu&#30340;highpri worker-pool&#26469;&#22788;&#29702;&#12290; </P>
<P>&#35753;&#25152;&#26377;&#30340;workqueue&#20849;&#20139;&#31995;&#32479;&#20013;&#30340;worker pool&#65292;&#21363;&#20943;&#23569;&#20102;&#36164;&#28304;&#30340;&#28010;&#36153;&#65288;&#27809;&#26377;&#21019;&#24314;&#37027;&#20040;&#22810;&#30340;kernel thread&#65289;&#65292;&#21448;&#20445;&#35777;&#20102;&#28789;&#27963;&#30340;&#24182;&#21457;&#24615;&#65288;worker pool&#20250;&#26681;&#25454;&#24773;&#20917;&#28789;&#27963;&#30340;&#21019;&#24314;thread&#26469;&#22788;&#29702;work&#65289;&#12290; </P>
<P>3&#12289;&#22914;&#20309;&#35299;&#20915;&#32447;&#31243;&#25968;&#30446;&#36807;&#22810;&#30340;&#38382;&#39064;&#65311; </P>
<P>&#22312;CMWQ&#20013;&#65292;&#29992;&#25143;&#21487;&#20197;&#26681;&#25454;&#33258;&#24049;&#30340;&#38656;&#27714;&#21019;&#24314;workqueue&#65292;&#20294;&#26159;&#24050;&#32463;&#21644;&#21518;&#31471;&#30340;&#32447;&#31243;&#27744;&#26159;&#21542;&#21019;&#24314;worker&#32447;&#31243;&#26080;&#20851;&#20102;&#65292;&#26159;&#21542;&#21019;&#24314;&#26032;&#30340;work&#32447;&#31243;&#26159;&#30001;worker&#32447;&#31243;&#27744;&#26469;&#31649;&#29702;&#12290;&#31995;&#32479;&#20013;&#30340;&#32447;&#31243;&#27744;&#21253;&#25324;&#20004;&#31181;&#65306; </P>
<P>&#65288;1&#65289;&#21644;&#29305;&#23450;CPU&#32465;&#23450;&#30340;&#32447;&#31243;&#27744;&#12290;&#36825;&#31181;&#32447;&#31243;&#27744;&#26377;&#20004;&#31181;&#65292;&#19968;&#31181;&#21483;&#20570;normal thread pool&#65292;&#21478;&#22806;&#19968;&#31181;&#21483;&#20570;high priority thread pool&#65292;&#20998;&#21035;&#29992;&#26469;&#31649;&#29702;&#26222;&#36890;&#30340;worker thread&#21644;&#39640;&#20248;&#20808;&#32423;&#30340;worker thread&#65292;&#32780;&#36825;&#20004;&#31181;thread&#20998;&#21035;&#29992;&#26469;&#22788;&#29702;&#26222;&#36890;&#30340;&#21644;&#39640;&#20248;&#20808;&#32423;&#30340;work&#12290;&#36825;&#31181;&#31867;&#22411;&#30340;&#32447;&#31243;&#27744;&#25968;&#30446;&#26159;&#22266;&#23450;&#30340;&#65292;&#21644;&#31995;&#32479;&#20013;cpu&#30340;&#25968;&#30446;&#30456;&#20851;&#65292;&#22914;&#26524;&#31995;&#32479;&#26377;n&#20010;cpu&#65292;&#22914;&#26524;&#37117;&#26159;online&#30340;&#65292;&#37027;&#20040;&#20250;&#21019;&#24314;2n&#20010;&#32447;&#31243;&#27744;&#12290; </P>
<P>&#65288;2&#65289;unbound &#32447;&#31243;&#27744;&#65292;&#21487;&#20197;&#36816;&#34892;&#22312;&#20219;&#24847;&#30340;cpu&#19978;&#12290;&#36825;&#31181;thread pool&#26159;&#21160;&#24577;&#21019;&#24314;&#30340;&#65292;&#26159;&#21644;thread pool&#30340;&#23646;&#24615;&#30456;&#20851;&#65292;&#21253;&#25324;&#35813;thread pool&#21019;&#24314;worker thread&#30340;&#20248;&#20808;&#32423;&#65288;nice value&#65289;&#65292;&#21487;&#20197;&#36816;&#34892;&#30340;cpu&#38142;&#34920;&#31561;&#12290;&#22914;&#26524;&#31995;&#32479;&#20013;&#24050;&#32463;&#26377;&#20102;&#30456;&#21516;&#23646;&#24615;&#30340;thread pool&#65292;&#37027;&#20040;&#19981;&#38656;&#35201;&#21019;&#24314;&#26032;&#30340;&#32447;&#31243;&#27744;&#65292;&#21542;&#21017;&#38656;&#35201;&#21019;&#24314;&#12290; </P>
<P>OK&#65292;&#19978;&#38754;&#35762;&#20102;&#32447;&#31243;&#27744;&#30340;&#21019;&#24314;&#65292;&#20102;&#35299;&#21040;&#21019;&#24314;workqueue&#21644;&#21019;&#24314;worker thread&#36825;&#20004;&#20010;&#20107;&#20214;&#24050;&#32463;&#35299;&#38500;&#20851;&#32852;&#65292;&#29992;&#25143;&#21019;&#24314;workqueue&#20165;&#20165;&#26159;&#36873;&#25321;&#19968;&#20010;&#25110;&#32773;&#22810;&#20010;&#32447;&#31243;&#27744;&#32780;&#24050;&#65292;&#23545;&#20110;bound thread pool&#65292;&#27599;&#20010;cpu&#26377;&#20004;&#20010;thread pool&#65292;&#20851;&#31995;&#26159;&#22266;&#23450;&#30340;&#65292;&#23545;&#20110;unbound thread pool&#65292;&#26377;&#21487;&#33021;&#26681;&#25454;&#23646;&#24615;&#21160;&#24577;&#21019;&#24314;thread pool&#12290;&#37027;&#20040;worker thread pool&#22914;&#20309;&#21019;&#24314;worker thread&#21602;&#65311;&#26159;&#21542;&#20250;&#25968;&#30446;&#36807;&#22810;&#21602;&#65311; </P>
<P>&#32570;&#30465;&#24773;&#20917;&#19979;&#65292;&#21019;&#24314;thread pool&#30340;&#26102;&#20505;&#20250;&#21019;&#24314;&#19968;&#20010;worker thread&#26469;&#22788;&#29702;work&#65292;&#38543;&#30528;work&#30340;&#25552;&#20132;&#20197;&#21450;work&#30340;&#25191;&#34892;&#24773;&#20917;&#65292;thread pool&#20250;&#21160;&#24577;&#21019;&#24314;worker thread&#12290;&#20855;&#20307;&#21019;&#24314;worker thread&#30340;&#31574;&#30053;&#20026;&#20309;&#65311;&#26412;&#36136;&#19978;&#36825;&#26159;&#19968;&#20010;&#38656;&#35201;&#22312;&#24182;&#21457;&#24615;&#21644;&#31995;&#32479;&#36164;&#28304;&#28040;&#32791;&#19978;&#36827;&#34892;&#24179;&#34913;&#30340;&#38382;&#39064;&#65292;CMWQ&#20351;&#29992;&#20102;&#19968;&#20010;&#38750;&#24120;&#31616;&#21333;&#30340;&#31574;&#30053;&#65306;&#24403;thread pool&#20013;&#22788;&#20110;&#36816;&#34892;&#29366;&#24577;&#30340;worker thread&#31561;&#20110;0&#65292;&#24182;&#19988;&#26377;&#38656;&#35201;&#22788;&#29702;&#30340;work&#30340;&#26102;&#20505;&#65292;thread pool&#23601;&#20250;&#21019;&#24314;&#26032;&#30340;worker&#32447;&#31243;&#12290;&#24403;worker&#32447;&#31243;&#22788;&#20110;idle&#30340;&#26102;&#20505;&#65292;&#19981;&#20250;&#31435;&#21051;&#38144;&#27585;&#23427;&#65292;&#32780;&#26159;&#20445;&#25345;&#19968;&#27573;&#26102;&#38388;&#65292;&#22914;&#26524;&#36825;&#26102;&#20505;&#26377;&#21019;&#24314;&#26032;&#30340;worker&#30340;&#38656;&#27714;&#30340;&#26102;&#20505;&#65292;&#37027;&#20040;&#30452;&#25509;wakeup idle&#30340;worker&#21363;&#21487;&#12290;&#19968;&#27573;&#26102;&#38388;&#36807;&#21435;&#20173;&#28982;&#27809;&#26377;&#20107;&#24773;&#22788;&#29702;&#65292;&#37027;&#20040;&#35813;worker thread&#20250;&#34987;&#38144;&#27585;&#12290; </P>
<P>4&#12289;&#22914;&#20309;&#35299;&#20915;&#24182;&#21457;&#38382;&#39064;&#65311; </P>
<P>&#25105;&#20204;&#29992;&#26576;&#20010;cpu&#19978;&#30340;bound workqueue&#26469;&#25551;&#36848;&#35813;&#38382;&#39064;&#12290;&#20551;&#35774;&#26377;A B C D&#22235;&#20010;work&#22312;&#35813;cpu&#19978;&#36816;&#34892;&#65292;&#32570;&#30465;&#30340;&#24773;&#20917;&#19979;&#65292;thread pool&#20250;&#21019;&#24314;&#19968;&#20010;worker&#26469;&#22788;&#29702;&#36825;&#22235;&#20010;work&#12290;&#22312;&#26087;&#30340;workqueue&#20013;&#65292;A B C D&#22235;&#20010;work&#27627;&#26080;&#30097;&#38382;&#26159;&#20018;&#34892;&#22312;cpu&#19978;&#25191;&#34892;&#65292;&#20551;&#35774;B work&#38459;&#22622;&#20102;&#65292;&#37027;&#20040;C D&#37117;&#26159;&#26080;&#27861;&#25191;&#34892;&#19979;&#21435;&#65292;&#19968;&#30452;&#35201;&#31561;&#21040;B&#35299;&#38500;&#38459;&#22622;&#24182;&#25191;&#34892;&#23436;&#27605;&#12290; </P>
<P>&#23545;&#20110;CMWQ&#65292;&#24403;B work&#38459;&#22622;&#20102;&#65292;thread pool&#21487;&#20197;&#24863;&#30693;&#21040;&#36825;&#19968;&#20107;&#20214;&#65292;&#36825;&#26102;&#20505;&#23427;&#20250;&#21019;&#24314;&#19968;&#20010;&#26032;&#30340;worker thread&#26469;&#22788;&#29702;C D&#36825;&#20004;&#20010;work&#65292;&#20174;&#32780;&#35299;&#20915;&#20102;&#24182;&#21457;&#30340;&#38382;&#39064;&#12290;&#30001;&#20110;&#35299;&#20915;&#20102;&#24182;&#21457;&#38382;&#39064;&#65292;&#23454;&#38469;&#19978;&#20063;&#35299;&#20915;&#20102;&#30001;&#20110;&#31454;&#20105;&#19968;&#20010;execution context&#32780;&#24341;&#20837;&#30340;&#21508;&#31181;&#38382;&#39064;&#65288;&#20363;&#22914;dead lock&#65289;&#12290; </P>
<P>&nbsp; </P>
<P>&#22235;&#12289;&#25509;&#21475;API </P>
<P>1&#12289;&#21021;&#22987;&#21270;work&#30340;&#25509;&#21475;&#20445;&#25345;&#19981;&#21464;&#65292;&#21487;&#20197;&#38745;&#24577;&#25110;&#32773;&#21160;&#24577;&#21019;&#24314;work&#12290; </P>
<P>2&#12289;&#35843;&#24230;work&#25191;&#34892;&#20063;&#20445;&#25345;&#21644;&#26087;&#30340;workqueue&#19968;&#33268;&#12290; </P>
<P>3&#12289;&#21019;&#24314;workqueue&#12290;&#21644;&#26087;&#30340;create_workqueue&#25509;&#21475;&#19981;&#21516;&#65292;CMWQ&#37319;&#29992;&#20102;alloc_workqueue&#36825;&#26679;&#30340;&#25509;&#21475;&#31526;&#21495;&#65292;&#30456;&#20851;&#30340;&#25509;&#21475;&#23450;&#20041;&#22914;&#19979;&#65306; </P>
<BLOCKQUOTE>
<P>#define alloc_workqueue(fmt, flags, max_active, args...)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \ <BR>&nbsp;&nbsp;&nbsp; __alloc_workqueue_key((fmt), (flags), (max_active),&nbsp; NULL, NULL, ##args) </P>
<P>#define alloc_ordered_workqueue(fmt, flags, args...)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \ <BR>&nbsp;&nbsp;&nbsp; alloc_workqueue(fmt, WQ_UNBOUND | __WQ_ORDERED | (flags), 1, ##args) </P>
<P>#define create_freezable_workqueue(name)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \ <BR>&nbsp;&nbsp;&nbsp; alloc_workqueue("%s", WQ_FREEZABLE | WQ_UNBOUND | WQ_MEM_RECLAIM, 1, (name)) </P>
<P>#define create_workqueue(name)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \ <BR>&nbsp;&nbsp;&nbsp; alloc_workqueue("%s", WQ_MEM_RECLAIM, 1, (name)) </P>
<P>#define create_singlethread_workqueue(name)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \ <BR>&nbsp;&nbsp;&nbsp; alloc_ordered_workqueue("%s", WQ_MEM_RECLAIM, name) </P></BLOCKQUOTE>
<P>&#22312;&#25551;&#36848;&#36825;&#20123;workqueue&#30340;&#25509;&#21475;&#20043;&#21069;&#65292;&#25105;&#20204;&#38656;&#35201;&#20934;&#22791;&#19968;&#20123;workqueue flag&#30340;&#30693;&#35782;&#12290; </P>
<P>&#26631;&#26377;WQ_UNBOUND&#36825;&#20010;flag&#30340;workqueue&#35828;&#26126;&#20854;work&#30340;&#22788;&#29702;&#19981;&#38656;&#35201;&#32465;&#23450;&#22312;&#29305;&#23450;&#30340;CPU&#19978;&#25191;&#34892;&#65292;workqueue&#38656;&#35201;&#20851;&#32852;&#19968;&#20010;&#31995;&#32479;&#20013;&#30340;unbound worker thread pool&#12290;&#22914;&#26524;&#31995;&#32479;&#20013;&#33021;&#25214;&#21040;&#21305;&#37197;&#30340;&#32447;&#31243;&#27744;&#65288;&#26681;&#25454;workqueue&#30340;&#23646;&#24615;&#65288;attribute&#65289;&#65289;&#65292;&#37027;&#20040;&#23601;&#36873;&#25321;&#19968;&#20010;&#65292;&#22914;&#26524;&#25214;&#19981;&#21040;&#36866;&#21512;&#30340;&#32447;&#31243;&#27744;&#65292;workqueue&#23601;&#20250;&#21019;&#24314;&#19968;&#20010;worker thread pool&#26469;&#22788;&#29702;work&#12290; </P>
<P>WQ_FREEZABLE&#26159;&#19968;&#20010;&#21644;&#30005;&#28304;&#31649;&#29702;&#30456;&#20851;&#30340;&#20869;&#23481;&#12290;&#22312;&#31995;&#32479;Hibernation&#25110;&#32773;suspend&#30340;&#26102;&#20505;&#65292;&#26377;&#19968;&#20010;&#27493;&#39588;&#23601;&#26159;&#20923;&#32467;&#29992;&#25143;&#31354;&#38388;&#30340;&#36827;&#31243;&#20197;&#21450;&#37096;&#20998;&#65288;&#26631;&#27880;freezable&#30340;&#65289;&#20869;&#26680;&#32447;&#31243;&#65288;&#21253;&#25324;workqueue&#30340;worker thread&#65289;&#12290;&#26631;&#35760;WQ_FREEZABLE&#30340;workqueue&#38656;&#35201;&#21442;&#19982;&#21040;&#36827;&#31243;&#20923;&#32467;&#30340;&#36807;&#31243;&#20013;&#65292;worker thread&#34987;&#20923;&#32467;&#30340;&#26102;&#20505;&#65292;&#20250;&#22788;&#29702;&#23436;&#24403;&#21069;&#25152;&#26377;&#30340;work&#65292;&#19968;&#26086;&#20923;&#32467;&#23436;&#25104;&#65292;&#37027;&#20040;&#23601;&#19981;&#20250;&#21551;&#21160;&#26032;&#30340;work&#30340;&#25191;&#34892;&#65292;&#30452;&#21040;&#36827;&#31243;&#34987;&#35299;&#20923;&#12290; </P>
<P>&#21644;WQ_MEM_RECLAIM&#36825;&#20010;flag&#30456;&#20851;&#30340;&#27010;&#24565;&#26159;rescuer thread&#12290;&#21069;&#38754;&#25105;&#20204;&#25551;&#36848;&#35299;&#20915;&#24182;&#21457;&#38382;&#39064;&#30340;&#26102;&#20505;&#35828;&#21040;&#65306;&#23545;&#20110;A B C D&#22235;&#20010;work&#65292;&#24403;&#27491;&#22312;&#22788;&#29702;&#30340;B work&#34987;&#38459;&#22622;&#21518;&#65292;worker pool&#20250;&#21019;&#24314;&#19968;&#20010;&#26032;&#30340;worker thread&#26469;&#22788;&#29702;&#20854;&#20182;&#30340;work&#65292;&#20294;&#26159;&#65292;&#22312;memory&#36164;&#28304;&#27604;&#36739;&#32039;&#24352;&#30340;&#26102;&#20505;&#65292;&#21019;&#24314;worker thread&#26410;&#24517;&#33021;&#22815;&#25104;&#21151;&#65292;&#36825;&#26102;&#20505;&#65292;&#22914;&#26524;B work&#26159;&#20381;&#36182;C&#25110;&#32773;D work&#30340;&#25191;&#34892;&#32467;&#26524;&#30340;&#26102;&#20505;&#65292;&#31995;&#32479;&#36827;&#20837;dead lock&#12290;&#36825;&#31181;&#29366;&#24577;&#26159;&#30001;&#20110;&#19981;&#33021;&#21019;&#24314;&#26032;&#30340;worker thread&#23548;&#33268;&#30340;&#65292;&#22914;&#20309;&#35299;&#20915;&#21602;&#65311;&#23545;&#20110;&#27599;&#19968;&#20010;&#26631;&#35760;WQ_MEM_RECLAIM flag&#30340;work queue&#65292;&#31995;&#32479;&#37117;&#20250;&#21019;&#24314;&#19968;&#20010;rescuer thread&#65292;&#24403;&#21457;&#29983;&#36825;&#31181;&#24773;&#20917;&#30340;&#26102;&#20505;&#65292;C&#25110;&#32773;D work&#20250;&#34987;rescuer thread&#25509;&#25163;&#22788;&#29702;&#65292;&#20174;&#32780;&#35299;&#38500;&#20102;dead lock&#12290; </P>
<P>WQ_HIGHPRI&#35828;&#26126;&#25346;&#20837;&#35813;workqueue&#30340;work&#26159;&#23646;&#20110;&#39640;&#20248;&#20808;&#32423;&#30340;work&#65292;&#38656;&#35201;&#39640;&#20248;&#20808;&#32423;&#65288;&#27604;&#36739;&#20302;&#30340;nice value&#65289;&#30340;worker thread&#26469;&#22788;&#29702;&#12290; </P>
<P>WQ_CPU_INTENSIVE&#36825;&#20010;flag&#35828;&#26126;&#25346;&#20837;&#35813;workqueue&#30340;work&#26159;&#23646;&#20110;&#29305;&#21035;&#28040;&#32791;cpu&#30340;&#37027;&#19968;&#31867;&#12290;&#20026;&#20309;&#35201;&#25552;&#20379;&#36825;&#26679;&#30340;flag&#21602;&#65311;&#25105;&#20204;&#36824;&#26159;&#29992;&#32769;&#20363;&#23376;&#26469;&#35828;&#26126;&#12290;&#23545;&#20110;A B C D&#22235;&#20010;work&#65292;B&#26159;cpu intersive&#30340;&#65292;&#24403;thread&#27491;&#22312;&#22788;&#29702;B work&#30340;&#26102;&#20505;&#65292;&#35813;worker thread&#19968;&#30452;&#25191;&#34892;B work&#65292;&#22240;&#20026;&#23427;&#26159;cpu intensive&#30340;&#65292;&#29305;&#21035;&#21507;cpu&#65292;&#36825;&#26102;&#20505;&#65292;thread pool&#26159;&#19981;&#20250;&#21019;&#24314;&#26032;&#30340;worker&#30340;&#65292;&#22240;&#20026;&#24403;&#21069;&#36824;&#26377;&#19968;&#20010;worker&#26159;running&#29366;&#24577;&#65292;&#27491;&#22312;&#22788;&#29702;B work&#12290;&#36825;&#26102;&#20505;C Dwork&#23454;&#38469;&#19978;&#26159;&#24471;&#19981;&#21040;&#25191;&#34892;&#65292;&#24433;&#21709;&#20102;&#24182;&#21457;&#12290; </P>
<P>&#20102;&#35299;&#20102;&#19978;&#38754;&#30340;&#20869;&#23481;&#65292;&#37027;&#20040;&#22522;&#26412;&#19978;alloc_workqueue&#20013;flag&#21442;&#25968;&#23601;&#26126;&#30333;&#20102;&#65292;&#19979;&#38754;&#25105;&#20204;&#36716;&#21521;max_active&#36825;&#20010;&#21442;&#25968;&#12290;&#31995;&#32479;&#19981;&#33021;&#20801;&#35768;&#21019;&#24314;&#22826;&#22810;&#30340;thread&#26469;&#22788;&#29702;&#25346;&#20837;&#26576;&#20010;workqueue&#30340;work&#65292;&#26368;&#22810;&#33021;&#21019;&#24314;&#30340;&#32447;&#31243;&#25968;&#30446;&#26159;&#23450;&#20041;&#22312;max_active&#21442;&#25968;&#20013;&#12290; </P>
<P>&#38500;&#20102;alloc_workqueue&#25509;&#21475;API&#20043;&#22806;&#65292;&#36824;&#21487;&#20197;&#36890;&#36807;alloc_ordered_workqueue&#36825;&#20010;&#25509;&#21475;API&#26469;&#21019;&#24314;&#19968;&#20010;&#20005;&#26684;&#20018;&#34892;&#25191;&#34892;work&#30340;&#19968;&#20010;workqueue&#65292;&#24182;&#19988;&#35813;workqueue&#26159;unbound&#31867;&#22411;&#30340;&#12290;create_*&#30340;&#25509;&#21475;&#37117;&#26159;&#20026;&#20102;&#20860;&#23481;&#36807;&#21435;&#25509;&#21475;&#32780;&#35774;&#31435;&#30340;&#65292;&#22823;&#23478;&#21487;&#20197;&#33258;&#34892;&#29702;&#35299;&#65292;&#36825;&#37324;&#23601;&#19981;&#22810;&#35828;&#20102;&#12290;