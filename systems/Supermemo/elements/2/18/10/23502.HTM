# Documentation/IRQ-affinity.txt
<P></P>
<P>ChangeLog:<BR>&nbsp;Started by Ingo Molnar &lt;<A href="mailto:mingo@redhat.com">mingo@redhat.com</A>&gt;<BR>&nbsp;Update by Max Krasnyansky &lt;<A href="mailto:maxk@qualcomm.com">maxk@qualcomm.com</A>&gt;</P>
<P></P>
<P>SMP IRQ affinity</P>
<P>/proc/irq/IRQ#/smp_affinity and /proc/irq/IRQ#/smp_affinity_list specify<BR>which target CPUs are permitted for a given IRQ source.&nbsp; It's a bitmask<BR>(smp_affinity) or cpu list (smp_affinity_list) of allowed CPUs.&nbsp; It's not<BR>allowed to turn off all CPUs, and if an IRQ controller does not support<BR>IRQ affinity then the value will not change from the default of all cpus.</P>
<P>/proc/irq/default_smp_affinity specifies default affinity mask that applies<BR>to all non-active IRQs. Once IRQ is allocated/activated its affinity bitmask<BR>will be set to the default mask. It can then be changed as described above.<BR>Default mask is 0xffffffff.</P>
<P>Here is an example of restricting IRQ44 (eth1) to CPU0-3 then restricting<BR>it to CPU4-7 (this is an 8-CPU SMP box):</P>
<P>[root@moon 44]# cd /proc/irq/44<BR>[root@moon 44]# cat smp_affinity<BR>ffffffff</P>
<P>[root@moon 44]# echo 0f &gt; smp_affinity<BR>[root@moon 44]# cat smp_affinity<BR>0000000f<BR>[root@moon 44]# ping -f h<BR>PING hell (195.4.7.3): 56 data bytes<BR>...<BR>--- hell ping statistics ---<BR>6029 packets transmitted, 6027 packets received, 0% packet loss<BR>round-trip min/avg/max = 0.1/0.1/0.4 ms<BR>[root@moon 44]# cat /proc/interrupts | grep 'CPU\|44:'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU7<BR>&nbsp;44:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1068&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1785&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1785&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1783&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; IO-APIC-level&nbsp; eth1</P>
<P>As can be seen from the line above IRQ44 was delivered only to the first four<BR>processors (0-3).<BR>Now lets restrict that IRQ to CPU(4-7).</P>
<P>[root@moon 44]# echo f0 &gt; smp_affinity<BR>[root@moon 44]# cat smp_affinity<BR>000000f0<BR>[root@moon 44]# ping -f h<BR>PING hell (195.4.7.3): 56 data bytes<BR>..<BR>--- hell ping statistics ---<BR>2779 packets transmitted, 2777 packets received, 0% packet loss<BR>round-trip min/avg/max = 0.1/0.5/585.4 ms<BR>[root@moon 44]# cat /proc/interrupts |&nbsp; 'CPU\|44:'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU7<BR>&nbsp;44:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1068&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1785&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1785&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1783&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1784&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1069&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1070&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1069&nbsp;&nbsp; IO-APIC-level&nbsp; eth1</P>
<P>This time around IRQ44 was delivered only to the last four processors.<BR>i.e counters for the CPU0-3 did not change.</P>
<P>Here is an example of limiting that same irq (44) to cpus 1024 to 1031:</P>
<P>[root@moon 44]# echo 1024-1031 &gt; smp_affinity<BR>[root@moon 44]# cat smp_affinity<BR>1024-1031</P>
<P>Note that to do this with a bitmask would require 32 bitmasks of zero<BR>to follow the pertinent one.