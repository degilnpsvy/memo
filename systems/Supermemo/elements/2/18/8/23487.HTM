<HEAD></HEAD>
<BODY><B><SPAN lang=EN-US style='FONT-SIZE: 24pt; FONT-FAMILY: "Futura-Bold","sans-serif"; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: Futura-Bold; mso-font-kerning: 0pt'>49.11 Nonlinear Mappings: </SPAN></B><B><SPAN lang=EN-US style='FONT-SIZE: 24pt; FONT-FAMILY: "NewBaskervilleEF-BoldIta","sans-serif"; mso-bidi-font-size: 12.5pt; mso-bidi-font-family: NewBaskervilleEF-BoldIta; mso-font-kerning: 0pt'>remap_file_pages()</SPAN></B>
<P></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>File mappings created with </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>mmap() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>are linear: there is a sequential, one-to-one correspondence between the pages of the mapped file and the pages of the memory region. For most applications, a linear mapping suffices. However, some applications need to create large numbers of nonlinear mappings&#8212;mappings where the pages of the file appear in a different order within contiguous memory. We show an example of a nonlinear mapping in Figure 49-5.</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>We described one way of creating nonlinear mappings in the previous section: using multiple calls to </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>mmap() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>with the </SPAN><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt; mso-hansi-font-family: NewBaskervilleEF-Roman"><FONT face=Calibri>MAP_FIXED </FONT></SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>flag. However, this approach doesn&#8217;t scale well. The problem is that each of these </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>mmap() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>calls creates a separate kernel virtual memory area (VMA) data structure. Each VMA takes time to set up and consumes some nonswappable kernel memory. Furthermore, the presence of a large number of VMAs can degrade the performance of the virtual memory manager; in particular, the time taken to process each page fault can significantly increase when there are tens of thousands of VMAs. (This was a problem for some large database management systems that maintain multiple different views in a database file.)</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 16pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>Each line in the </SPAN><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.0pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt; mso-hansi-font-family: NewBaskervilleEF-Roman"><FONT face=Calibri>/proc/</FONT></SPAN><SPAN lang=EN-US style='FONT-SIZE: 16pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>PID</SPAN><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.0pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt; mso-hansi-font-family: NewBaskervilleEF-Roman"><FONT face=Calibri>/maps </FONT></SPAN><SPAN lang=EN-US style='FONT-SIZE: 16pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>file (Section 48.5) represents one VMA.</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>From kernel 2.6 onward, Linux provides the </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>remap_file_pages() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>system call to create nonlinear mappings without creating multiple VMAs. We do this as follows:</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>1. Create a mapping with </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>mmap()</SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>.</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>2. Use one or more calls to </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>remap_file_pages() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>to rearrange the correspondence between the pages of memory and the pages of the file. (All that </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>remap_file_pages() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>is doing is manipulating process page tables.)</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 16pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>It is possible to use </SPAN><SPAN lang=EN-US style='FONT-SIZE: 16pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>remap_file_pages() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 16pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>to map the same page of a file into multiple locations within the mapped region.</SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt"><FONT face=Calibri>#define _GNU_SOURCE</FONT></SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt"><FONT face=Calibri>#include &lt;sys/mman.h&gt;</FONT></SPAN></P>
<P><FONT face=Calibri><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt">int </SPAN><B><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Bold; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Bold; mso-font-kerning: 0pt">remap_file_pages</SPAN></B><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt">(void *</SPAN></FONT><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt; mso-fareast-font-family: TheSansMonoCondensed-Plain'>addr</SPAN><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt"><FONT face=Calibri>, size_t </FONT></SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt; mso-fareast-font-family: TheSansMonoCondensed-Plain'>size</SPAN><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt"><FONT face=Calibri>, int </FONT></SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt; mso-fareast-font-family: TheSansMonoCondensed-Plain'>prot</SPAN><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt"><FONT face=Calibri>, size_t </FONT></SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt; mso-fareast-font-family: TheSansMonoCondensed-Plain'>pgoff</SPAN><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt"><FONT face=Calibri>, int </FONT></SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt; mso-fareast-font-family: TheSansMonoCondensed-Plain'>flags</SPAN><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt"><FONT face=Calibri>);</FONT></SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt; mso-fareast-font-family: TheSansMonoCondensed-Plain'>Returns 0 on success, or &#8211;1 on error</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>The </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>pgoff </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>and </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>size </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>arguments identify a file region whose position in memory is to be changed. The </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>pgoff </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>argument specifies the start of the file region in units of the system page size (as returned by </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>sysconf(_SC_PAGESIZE)</SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>). The </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>size </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>argument specifies the length of the file region, in bytes. The </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>addr </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>argument serves two purposes:</SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 12pt; FONT-FAMILY: Wingdings; mso-bidi-font-size: 6.0pt; mso-bidi-font-family: Wingdings; mso-font-kerning: 0pt">&#56256;&#56442; </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>It identifies the existing mapping whose pages we want to rearrange. In other words, </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>addr </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>must be an address that falls somewhere within a region that was previously mapped with </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>mmap()</SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>.</SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 12pt; FONT-FAMILY: Wingdings; mso-bidi-font-size: 6.0pt; mso-bidi-font-family: Wingdings; mso-font-kerning: 0pt">&#56256;&#56442; </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>It specifies the memory address at which the file pages identified by </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>pgoff </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>and </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>size </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>are to be located.</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>Both </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>addr </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>and </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>size </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>should be specified as multiples of the system page size. If they are not, they are rounded down to the nearest multiple of the page size.</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>Suppose that we use the following call to </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>mmap() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>to map three pages of the open file referred to by the descriptor </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>fd</SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>, and that the call assigns the returned address </SPAN><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt; mso-hansi-font-family: NewBaskervilleEF-Roman"><FONT face=Calibri>0x4001a000 </FONT></SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>to </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>addr</SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>:</SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt; mso-hansi-font-family: NewBaskervilleEF-Roman"><FONT face=Calibri>ps = sysconf(_SC_PAGESIZE); /* Obtain system page size */</FONT></SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt; mso-hansi-font-family: NewBaskervilleEF-Roman"><FONT face=Calibri>addr = mmap(0, 3 * ps, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);</FONT></SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>The following calls would then create the nonlinear mapping shown in Figure 49-5:</SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt; mso-hansi-font-family: NewBaskervilleEF-Roman"><FONT face=Calibri>remap_file_pages(addr, ps, 0, 2, 0);</FONT></SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt; mso-hansi-font-family: NewBaskervilleEF-Roman"><FONT face=Calibri>/* Maps page 0 of file into page 2 of region */</FONT></SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt; mso-hansi-font-family: NewBaskervilleEF-Roman"><FONT face=Calibri>remap_file_pages(addr + 2 * ps, ps, 0, 0, 0);</FONT></SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt; mso-hansi-font-family: NewBaskervilleEF-Roman"><FONT face=Calibri>/* Maps page 2 of file into page 0 of region */</FONT></SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 16.5pt; mso-bidi-font-size: 11.0pt; mso-no-proof: yes"><?xml:namespace prefix = "v" /><v:shapetype id=_x0000_t75 coordsize="21600,21600" o:spt="75" o:preferrelative="t" path="m@4@5l@4@11@9@11@9@5xe" filled="f" stroked="f"><v:stroke joinstyle="miter"></v:stroke><v:formulas><v:f eqn="if lineDrawn pixelLineWidth 0"></v:f><v:f eqn="sum @0 1 0"></v:f><v:f eqn="sum 0 0 @1"></v:f><v:f eqn="prod @2 1 2"></v:f><v:f eqn="prod @3 21600 pixelWidth"></v:f><v:f eqn="prod @3 21600 pixelHeight"></v:f><v:f eqn="sum @0 0 1"></v:f><v:f eqn="prod @6 1 2"></v:f><v:f eqn="prod @7 21600 pixelWidth"></v:f><v:f eqn="sum @8 21600 0"></v:f><v:f eqn="prod @7 21600 pixelHeight"></v:f><v:f eqn="sum @10 21600 0"></v:f></v:formulas><v:path o:extrusionok="f" gradientshapeok="t" o:connecttype="rect"></v:path><?xml:namespace prefix = "o" /><o:lock v:ext="edit" aspectratio="t"></o:lock></v:shapetype><v:shape id=&#22270;&#29255;_x0020_5 style="HEIGHT: 199.5pt; WIDTH: 384.75pt; VISIBILITY: visible" o:spid="_x0000_i1025" type="#_x0000_t75"><v:imagedata src="file:///C:\Users\DONPOP~1\AppData\Local\Temp\msohtmlclip1\01\clip_image001.emz" o:title=""></v:imagedata></v:shape></SPAN><SPAN lang=EN-US style="FONT-SIZE: 16.5pt; mso-bidi-font-size: 11.0pt"></SPAN></P>
<P><B><SPAN lang=EN-US style='FONT-SIZE: 16pt; FONT-FAMILY: "Futura-Heavy","sans-serif"; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: Futura-Heavy; mso-font-kerning: 0pt'>Figure 49-5: </SPAN></B><SPAN lang=EN-US style='FONT-SIZE: 16pt; FONT-FAMILY: "Futura-Book","sans-serif"; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: Futura-Book; mso-font-kerning: 0pt'>A nonlinear file mapping</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>There are two other arguments to </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>remap_file_pages() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>that we haven&#8217;t yet described:</SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 12pt; FONT-FAMILY: Wingdings; mso-bidi-font-size: 6.0pt; mso-bidi-font-family: Wingdings; mso-font-kerning: 0pt">&#56256;&#56442; </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>The </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>prot </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>argument is ignored, and must be specified as 0. In the future, it may be possible to use this argument to change the protection of the memory region affected by </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>remap_file_pages()</SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>. In the current implementation, the protection remains the same as that on the entire VMA.</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 16pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>Virtual machines and garbage collectors are other applications that employ multiple VMAs. Some of these applications need to be able to write-protect individual pages. It was intended that </SPAN><SPAN lang=EN-US style='FONT-SIZE: 16pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>remap_file_pages() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 16pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 9.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>would allow permissions on individual pages within a VMA to be changed, but this facility has not so far been implemented.</SPAN></P>
<P><SPAN lang=EN-US style="FONT-SIZE: 12pt; FONT-FAMILY: Wingdings; mso-bidi-font-size: 6.0pt; mso-bidi-font-family: Wingdings; mso-font-kerning: 0pt">&#56256;&#56442; </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>The </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>flags </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>argument is currently unused.</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>As currently implemented, </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>remap_file_pages() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>can be applied only to shared (</SPAN><SPAN lang=EN-US style="FONT-SIZE: 14pt; FONT-FAMILY: TheSansMonoCondensed-Plain; mso-bidi-font-size: 8.5pt; mso-bidi-font-family: TheSansMonoCondensed-Plain; mso-font-kerning: 0pt; mso-hansi-font-family: NewBaskervilleEF-Roman"><FONT face=Calibri>MAP_SHARED</FONT></SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>) mappings.</SPAN></P>
<P><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>The </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-RomanIta","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-RomanIta; mso-font-kerning: 0pt'>remap_file_pages() </SPAN><SPAN lang=EN-US style='FONT-SIZE: 18pt; FONT-FAMILY: "NewBaskervilleEF-Roman","sans-serif"; mso-bidi-font-size: 10.0pt; mso-bidi-font-family: NewBaskervilleEF-Roman; mso-font-kerning: 0pt'>system call is Linux-specific; it is not specified in SUSv3 and is not available on other UNIX implementations.</SPAN></P></BODY>