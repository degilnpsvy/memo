TakePreserveFPException() Handles any exception during a PreserveFPState() operation Exceptions while saving FP state on page B1-688</P>
<P>// TakePreserveFPException()<BR>// =========================</P>
<P>TakePreserveFPException(Exception)<BR>&nbsp;&nbsp;&nbsp; // Exception can be DebugMonitor, MemManage or BusFault<BR>&nbsp;&nbsp;&nbsp; // The Exception might be escalated to a lockup condition<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; if FPCCR.MONRDY == &#8216;1&#8217; AND FPCCR.HFRDY == &#8216;0&#8217; then UNPREDICTABLE;<BR>&nbsp;&nbsp;&nbsp; if FPCCR.BFRDY == &#8216;1&#8217; AND FPCCR.HFRDY == &#8216;0&#8217; then UNPREDICTABLE;<BR>&nbsp;&nbsp;&nbsp; if FPCCR.MMRDY == &#8216;1&#8217; AND FPCCR.HFRDY == &#8216;0&#8217; then UNPREDICTABLE;<BR>&nbsp;&nbsp;&nbsp; if Exception == DebugMonitor AND FPCCR.MONRDY == &#8216;0&#8217; then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ignore DebugMonitor exception&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; // Record appropriate fault status information<BR>&nbsp;&nbsp;&nbsp; if Exception == MemManage then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MMFSR.MLSPERR = &#8216;1&#8217;;<BR>&nbsp;&nbsp;&nbsp; if Exception == BusFault then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BFSR.LSPERR = &#8216;1&#8217;;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; // Escalate faults for handlers that are masked<BR>&nbsp;&nbsp;&nbsp; if Exception == MemManage AND FPCCR.MMRDY == &#8216;0&#8217; then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HFSR.FORCED = 1;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Exception = HardFault;<BR>&nbsp;&nbsp;&nbsp; if Exception == BusFault AND FPCCR.BFRDY == &#8216;0&#8217; then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HFSR.FORCED = 1;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Exception = HardFault;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; // Promote HardFault exceptions to lockup if priority permits<BR>&nbsp;&nbsp;&nbsp; if ExecutionPriority() &lt; 0 AND FPCCR.HFRDY == &#8216;0&#8217; then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BranchWritePC(0xFFFFFFFE); // Lockup at current priority, lock-up address = 0xFFFFFFFE<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; // Either pend or preempt based upon current priority<BR>&nbsp;&nbsp;&nbsp; if ExceptionGroupPriority(Exception) &lt; ExecutionPriority() AND ExceptionEnabled(Exception) then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExceptionEntry(Exception);<BR>&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetPending(Exception);