/* Execute a TB, and fix up the CPU state afterwards if necessary */<BR>static inline tcg_target_ulong cpu_tb_exec(CPUState *cpu, TranslationBlock *itb)<BR>{<BR>&nbsp;&nbsp;&nbsp; CPUArchState *env = cpu-&gt;env_ptr;<BR>&nbsp;&nbsp;&nbsp; uintptr_t ret;<BR>&nbsp;&nbsp;&nbsp; TranslationBlock *last_tb;<BR>&nbsp;&nbsp;&nbsp; int tb_exit;<BR>&nbsp;&nbsp;&nbsp; uint8_t *tb_ptr = itb-&gt;tc_ptr;</P>
<P>&nbsp;&nbsp;&nbsp; qemu_log_mask_and_addr(CPU_LOG_EXEC, itb-&gt;pc,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Trace %p [" TARGET_FMT_lx "] %s\n",<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; itb-&gt;tc_ptr, itb-&gt;pc, lookup_symbol(itb-&gt;pc));</P>
<P>#if defined(DEBUG_DISAS)<BR>&nbsp;&nbsp;&nbsp; if (qemu_loglevel_mask(CPU_LOG_TB_CPU)) {<BR>#if defined(TARGET_I386)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log_cpu_state(cpu, CPU_DUMP_CCOP);<BR>#elif defined(TARGET_M68K)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* ??? Should not modify env state for dumping.&nbsp; */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cpu_m68k_flush_flags(env, env-&gt;cc_op);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; env-&gt;cc_op = CC_OP_FLAGS;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; env-&gt;sr = (env-&gt;sr &amp; 0xffe0) | env-&gt;cc_dest | (env-&gt;cc_x &lt;&lt; 4);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log_cpu_state(cpu, 0);<BR>#else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log_cpu_state(cpu, 0);<BR>#endif<BR>&nbsp;&nbsp;&nbsp; }<BR>#endif /* DEBUG_DISAS */</P>
<P>&nbsp;&nbsp;&nbsp; cpu-&gt;can_do_io = !use_icount;<BR>&nbsp;&nbsp;&nbsp; ret = tcg_qemu_tb_exec(env, tb_ptr);<BR>&nbsp;&nbsp;&nbsp; cpu-&gt;can_do_io = 1;<BR>&nbsp;&nbsp;&nbsp; last_tb = (TranslationBlock *)(ret &amp; ~TB_EXIT_MASK);<BR>&nbsp;&nbsp;&nbsp; tb_exit = ret &amp; TB_EXIT_MASK;<BR>&nbsp;&nbsp;&nbsp; trace_exec_tb_exit(last_tb, tb_exit);</P>
<P>&nbsp;&nbsp;&nbsp; if (tb_exit &gt; TB_EXIT_IDX1) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* We didn't start executing this TB (eg because the instruction<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * counter hit zero); we must restore the guest PC to the address<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * of the start of the TB.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPUClass *cc = CPU_GET_CLASS(cpu);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; qemu_log_mask_and_addr(CPU_LOG_EXEC, last_tb-&gt;pc,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Stopped execution of TB chain before %p ["<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TARGET_FMT_lx "] %s\n",<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_tb-&gt;tc_ptr, last_tb-&gt;pc,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lookup_symbol(last_tb-&gt;pc));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (cc-&gt;synchronize_from_tb) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cc-&gt;synchronize_from_tb(cpu, last_tb);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; assert(cc-&gt;set_pc);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cc-&gt;set_pc(cpu, last_tb-&gt;pc);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; if (tb_exit == TB_EXIT_REQUESTED) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* We were asked to stop executing TBs (probably a pending<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * interrupt. We've now stopped, so clear the flag.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cpu-&gt;tcg_exit_req = 0;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; return ret;<BR>}