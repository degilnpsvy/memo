static void do_v7m_exception_exit(CPUARMState *env)<BR>{<BR>&nbsp;&nbsp;&nbsp; uint32_t type;<BR>&nbsp;&nbsp;&nbsp; uint32_t xpsr;
<P></P>
<P>&nbsp;&nbsp;&nbsp; type = env-&gt;regs[15];<BR>&nbsp;&nbsp;&nbsp; if (env-&gt;v7m.exception != 0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; armv7m_nvic_complete_irq(env-&gt;nvic, env-&gt;v7m.exception);</P>
<P>&nbsp;&nbsp;&nbsp; /* Switch to the target stack.&nbsp; */<BR>&nbsp;&nbsp;&nbsp; switch_v7m_sp(env, (type &amp; 4) != 0);<BR>&nbsp;&nbsp;&nbsp; /* Pop registers.&nbsp; */<BR>&nbsp;&nbsp;&nbsp; env-&gt;regs[0] = v7m_pop(env);<BR>&nbsp;&nbsp;&nbsp; env-&gt;regs[1] = v7m_pop(env);<BR>&nbsp;&nbsp;&nbsp; env-&gt;regs[2] = v7m_pop(env);<BR>&nbsp;&nbsp;&nbsp; env-&gt;regs[3] = v7m_pop(env);<BR>&nbsp;&nbsp;&nbsp; env-&gt;regs[12] = v7m_pop(env);<BR>&nbsp;&nbsp;&nbsp; env-&gt;regs[14] = v7m_pop(env);<BR>&nbsp;&nbsp;&nbsp; env-&gt;regs[15] = v7m_pop(env);<BR>&nbsp;&nbsp;&nbsp; if (env-&gt;regs[15] &amp; 1) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; qemu_log_mask(LOG_GUEST_ERROR,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "M profile return from interrupt with misaligned "<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "PC is UNPREDICTABLE\n");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Actual hardware seems to ignore the lsbit, and there are several<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * RTOSes out there which incorrectly assume the r15 in the stack<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * frame should be a Thumb-style "lsbit indicates ARM/Thumb" value.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; env-&gt;regs[15] &amp;= ~1U;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; xpsr = v7m_pop(env);<BR>&nbsp;&nbsp;&nbsp; xpsr_write(env, xpsr, 0xfffffdff);<BR>&nbsp;&nbsp;&nbsp; /* Undo stack alignment.&nbsp; */<BR>&nbsp;&nbsp;&nbsp; if (xpsr &amp; 0x200)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; env-&gt;regs[13] |= 4;<BR>&nbsp;&nbsp;&nbsp; /* ??? The exception return type specifies Thread/Handler mode.&nbsp; However<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this is also implied by the xPSR value. Not sure what to do<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if there is a mismatch.&nbsp; */<BR>&nbsp;&nbsp;&nbsp; /* ??? Likewise for mismatches between the CONTROL register and the stack<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pointer.&nbsp; */<BR>}