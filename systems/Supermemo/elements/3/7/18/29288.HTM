static inline long __sched<BR>do_wait_for_common(struct completion *x,<BR>&nbsp;&nbsp;&nbsp;&nbsp; long (*action)(long), long timeout, int state)<BR>{<BR>&nbsp;if (!x-&gt;done) {<BR>&nbsp;&nbsp;DECLARE_WAITQUEUE(wait, current);</P>
<P>&nbsp;&nbsp;__add_wait_queue_tail_exclusive(&amp;x-&gt;wait, &amp;wait);<BR>&nbsp;&nbsp;do {<BR>&nbsp;&nbsp;&nbsp;if (signal_pending_state(state, current)) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;timeout = -ERESTARTSYS;<BR>&nbsp;&nbsp;&nbsp;&nbsp;break;<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;__set_current_state(state);<BR>&nbsp;&nbsp;&nbsp;spin_unlock_irq(&amp;x-&gt;wait.lock);<BR>&nbsp;&nbsp;&nbsp;timeout = action(timeout);<BR>&nbsp;&nbsp;&nbsp;spin_lock_irq(&amp;x-&gt;wait.lock);<BR>&nbsp;&nbsp;} while (!x-&gt;done &amp;&amp; timeout);<BR>&nbsp;&nbsp;__remove_wait_queue(&amp;x-&gt;wait, &amp;wait);<BR>&nbsp;&nbsp;if (!x-&gt;done)<BR>&nbsp;&nbsp;&nbsp;return timeout;<BR>&nbsp;}<BR>&nbsp;x-&gt;done--;<BR>&nbsp;return timeout ?: 1;<BR>}