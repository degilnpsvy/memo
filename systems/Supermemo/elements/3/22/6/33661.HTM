#if defined(CONFIG_USER_ONLY)<BR>/* Currently it is not recommended to allocate big chunks of data in<BR>&nbsp;&nbsp; user mode. It will change when a dedicated libc will be used.&nbsp; */<BR>/* ??? 64-bit hosts ought to have no problem mmaping data outside the<BR>&nbsp;&nbsp; region in which the guest needs to run.&nbsp; Revisit this.&nbsp; */<BR>#define USE_STATIC_CODE_GEN_BUFFER<BR>#endif
<P></P>
<P>/* Minimum size of the code gen buffer.&nbsp; This number is randomly chosen,<BR>&nbsp;&nbsp; but not so small that we can't have a fair number of TB's live.&nbsp; */<BR>#define MIN_CODE_GEN_BUFFER_SIZE&nbsp;&nbsp;&nbsp;&nbsp; (1024u * 1024)</P>
<P>/* Maximum size of the code gen buffer we'd like to use.&nbsp; Unless otherwise<BR>&nbsp;&nbsp; indicated, this is constrained by the range of direct branches on the<BR>&nbsp;&nbsp; host cpu, as used by the TCG implementation of goto_tb.&nbsp; */<BR>#if defined(__x86_64__)<BR># define MAX_CODE_GEN_BUFFER_SIZE&nbsp; (2ul * 1024 * 1024 * 1024)<BR>#elif defined(__sparc__)<BR># define MAX_CODE_GEN_BUFFER_SIZE&nbsp; (2ul * 1024 * 1024 * 1024)<BR>#elif defined(__powerpc64__)<BR># define MAX_CODE_GEN_BUFFER_SIZE&nbsp; (2ul * 1024 * 1024 * 1024)<BR>#elif defined(__aarch64__)<BR># define MAX_CODE_GEN_BUFFER_SIZE&nbsp; (128ul * 1024 * 1024)<BR>#elif defined(__arm__)<BR># define MAX_CODE_GEN_BUFFER_SIZE&nbsp; (16u * 1024 * 1024)<BR>#elif defined(__s390x__)<BR>&nbsp; /* We have a +- 4GB range on the branches; leave some slop.&nbsp; */<BR># define MAX_CODE_GEN_BUFFER_SIZE&nbsp; (3ul * 1024 * 1024 * 1024)<BR>#elif defined(__mips__)<BR>&nbsp; /* We have a 256MB branch region, but leave room to make sure the<BR>&nbsp;&nbsp;&nbsp;&nbsp; main executable is also within that region.&nbsp; */<BR># define MAX_CODE_GEN_BUFFER_SIZE&nbsp; (128ul * 1024 * 1024)<BR>#else<BR># define MAX_CODE_GEN_BUFFER_SIZE&nbsp; ((size_t)-1)<BR>#endif</P>
<P>#define DEFAULT_CODE_GEN_BUFFER_SIZE_1 (32u * 1024 * 1024)</P>
<P>#define DEFAULT_CODE_GEN_BUFFER_SIZE \<BR>&nbsp; (DEFAULT_CODE_GEN_BUFFER_SIZE_1 &lt; MAX_CODE_GEN_BUFFER_SIZE \<BR>&nbsp;&nbsp; ? DEFAULT_CODE_GEN_BUFFER_SIZE_1 : MAX_CODE_GEN_BUFFER_SIZE)</P>
<P>static inline size_t size_code_gen_buffer(size_t tb_size)<BR>{<BR>&nbsp;&nbsp;&nbsp; /* Size the buffer.&nbsp; */<BR>&nbsp;&nbsp;&nbsp; if (tb_size == 0) {<BR>#ifdef USE_STATIC_CODE_GEN_BUFFER<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tb_size = DEFAULT_CODE_GEN_BUFFER_SIZE;<BR>#else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* ??? Needs adjustments.&nbsp; */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* ??? If we relax the requirement that CONFIG_USER_ONLY use the<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static buffer, we could size this on RESERVED_VA, on the text<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; segment size of the executable, or continue to use the default.&nbsp; */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tb_size = (unsigned long)(ram_size / 4);<BR>#endif<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; if (tb_size &lt; MIN_CODE_GEN_BUFFER_SIZE) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tb_size = MIN_CODE_GEN_BUFFER_SIZE;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; if (tb_size &gt; MAX_CODE_GEN_BUFFER_SIZE) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tb_size = MAX_CODE_GEN_BUFFER_SIZE;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; tcg_ctx.code_gen_buffer_size = tb_size;<BR>&nbsp;&nbsp;&nbsp; return tb_size;<BR>}