static inline void code_gen_alloc(size_t tb_size)<BR>{<BR>&nbsp;&nbsp;&nbsp; tcg_ctx.code_gen_buffer_size = size_code_gen_buffer(tb_size);<BR>&nbsp;&nbsp;&nbsp; tcg_ctx.code_gen_buffer = alloc_code_gen_buffer();<BR>&nbsp;&nbsp;&nbsp; if (tcg_ctx.code_gen_buffer == NULL) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fprintf(stderr, "Could not allocate dynamic translator buffer\n");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit(1);<BR>&nbsp;&nbsp;&nbsp; }
<P></P>
<P>&nbsp;&nbsp;&nbsp; /* Estimate a good size for the number of TBs we can support.&nbsp; We<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; still haven't deducted the prologue from the buffer size here,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; but that's minimal and won't affect the estimate much.&nbsp; */<BR>&nbsp;&nbsp;&nbsp; tcg_ctx.code_gen_max_blocks<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = tcg_ctx.code_gen_buffer_size / CODE_GEN_AVG_BLOCK_SIZE;<BR>&nbsp;&nbsp;&nbsp; tcg_ctx.tb_ctx.tbs = g_new(TranslationBlock, tcg_ctx.code_gen_max_blocks);</P>
<P>&nbsp;&nbsp;&nbsp; qemu_mutex_init(&amp;tcg_ctx.tb_ctx.tb_lock);<BR>}
<P>&nbsp;
<P>In translate-all.c, invoked in tcg_exec_init