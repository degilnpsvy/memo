set_current_state() is _always_ safe. __set_current_state() may be race prone if not used carefully in the wait_event interface.</P><PRE><A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#253" name=253>253</A>#<B>ifdef</B> <A href="http://172.21.12.145:8080/source/s?defs=CONFIG_DEBUG_ATOMIC_SLEEP&amp;project=linux-4.6">CONFIG_DEBUG_ATOMIC_SLEEP</A>
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#254" name=254>254</A>
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#255" name=255>255</A>#<B>define</B> <A class=xm name=__set_task_state></A><A class=xm href="http://172.21.12.145:8080/source/s?refs=__set_task_state&amp;project=linux-4.6">__set_task_state</A>(<A href="http://172.21.12.145:8080/source/s?defs=tsk&amp;project=linux-4.6">tsk</A>, <A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>)			\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#256" name=256>256</A>	<B>do</B> {							\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#257" name=257>257</A>		(<A href="http://172.21.12.145:8080/source/s?defs=tsk&amp;project=linux-4.6">tsk</A>)-&gt;<A class=d href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#task_state_change">task_state_change</A> = <A href="http://172.21.12.145:8080/source/s?defs=_THIS_IP_&amp;project=linux-4.6">_THIS_IP_</A>;		\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#258" name=258>258</A>		(<A href="http://172.21.12.145:8080/source/s?defs=tsk&amp;project=linux-4.6">tsk</A>)-&gt;<A href="http://172.21.12.145:8080/source/s?defs=state&amp;project=linux-4.6">state</A> = (<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>);			\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#259" name=259>259</A>	} <B>while</B> (0)
<A class=hl href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#260" name=260>260</A>#<B>define</B> <A class=xm name=set_task_state></A><A class=xm href="http://172.21.12.145:8080/source/s?refs=set_task_state&amp;project=linux-4.6">set_task_state</A>(<A href="http://172.21.12.145:8080/source/s?defs=tsk&amp;project=linux-4.6">tsk</A>, <A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>)			\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#261" name=261>261</A>	<B>do</B> {							\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#262" name=262>262</A>		(<A href="http://172.21.12.145:8080/source/s?defs=tsk&amp;project=linux-4.6">tsk</A>)-&gt;<A class=d href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#task_state_change">task_state_change</A> = <A href="http://172.21.12.145:8080/source/s?defs=_THIS_IP_&amp;project=linux-4.6">_THIS_IP_</A>;		\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#263" name=263>263</A>		<A href="http://172.21.12.145:8080/source/s?defs=smp_store_mb&amp;project=linux-4.6">smp_store_mb</A>((<A href="http://172.21.12.145:8080/source/s?defs=tsk&amp;project=linux-4.6">tsk</A>)-&gt;<A href="http://172.21.12.145:8080/source/s?defs=state&amp;project=linux-4.6">state</A>, (<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>));		\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#264" name=264>264</A>	} <B>while</B> (0)
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#265" name=265>265</A>
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#266" name=266>266</A><SPAN class=c>/*
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#267" name=267>267</A> * set_current_state() includes a barrier so that the write of current-&gt;state
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#268" name=268>268</A> * is correctly serialised wrt the caller's subsequent test of whether to
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#269" name=269>269</A> * actually sleep:
<A class=hl href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#270" name=270>270</A> *
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#271" name=271>271</A> *	set_current_state(TASK_UNINTERRUPTIBLE);
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#272" name=272>272</A> *	if (do_i_need_to_sleep())
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#273" name=273>273</A> *		schedule();
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#274" name=274>274</A> *
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#275" name=275>275</A> * If the caller does not need such serialisation then use __set_current_state()
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#276" name=276>276</A> */</SPAN>
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#277" name=277>277</A>#<B>define</B> <A class=xm name=__set_current_state></A><A class=xm href="http://172.21.12.145:8080/source/s?refs=__set_current_state&amp;project=linux-4.6">__set_current_state</A>(<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>)			\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#278" name=278>278</A>	<B>do</B> {							\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#279" name=279>279</A>		<A href="http://172.21.12.145:8080/source/s?defs=current&amp;project=linux-4.6">current</A>-&gt;<A class=d href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#task_state_change">task_state_change</A> = <A href="http://172.21.12.145:8080/source/s?defs=_THIS_IP_&amp;project=linux-4.6">_THIS_IP_</A>;		\
<A class=hl href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#280" name=280>280</A>		<A href="http://172.21.12.145:8080/source/s?defs=current&amp;project=linux-4.6">current</A>-&gt;<A href="http://172.21.12.145:8080/source/s?defs=state&amp;project=linux-4.6">state</A> = (<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>);			\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#281" name=281>281</A>	} <B>while</B> (0)
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#282" name=282>282</A>#<B>define</B> <A class=xm name=set_current_state></A><A class=xm href="http://172.21.12.145:8080/source/s?refs=set_current_state&amp;project=linux-4.6">set_current_state</A>(<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>)				\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#283" name=283>283</A>	<B>do</B> {							\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#284" name=284>284</A>		<A href="http://172.21.12.145:8080/source/s?defs=current&amp;project=linux-4.6">current</A>-&gt;<A class=d href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#task_state_change">task_state_change</A> = <A href="http://172.21.12.145:8080/source/s?defs=_THIS_IP_&amp;project=linux-4.6">_THIS_IP_</A>;		\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#285" name=285>285</A>		<A href="http://172.21.12.145:8080/source/s?defs=smp_store_mb&amp;project=linux-4.6">smp_store_mb</A>(<A href="http://172.21.12.145:8080/source/s?defs=current&amp;project=linux-4.6">current</A>-&gt;<A href="http://172.21.12.145:8080/source/s?defs=state&amp;project=linux-4.6">state</A>, (<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>));		\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#286" name=286>286</A>	} <B>while</B> (0)
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#287" name=287>287</A>
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#288" name=288>288</A>#<B>else</B>
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#289" name=289>289</A>
<A class=hl href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#290" name=290>290</A>#<B>define</B> <A class=xm name=__set_task_state></A><A class=xm href="http://172.21.12.145:8080/source/s?refs=__set_task_state&amp;project=linux-4.6">__set_task_state</A>(<A href="http://172.21.12.145:8080/source/s?defs=tsk&amp;project=linux-4.6">tsk</A>, <A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>)		\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#291" name=291>291</A>	<B>do</B> { (<A href="http://172.21.12.145:8080/source/s?defs=tsk&amp;project=linux-4.6">tsk</A>)-&gt;<A href="http://172.21.12.145:8080/source/s?defs=state&amp;project=linux-4.6">state</A> = (<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>); } <B>while</B> (0)
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#292" name=292>292</A>#<B>define</B> <A class=xm name=set_task_state></A><A class=xm href="http://172.21.12.145:8080/source/s?refs=set_task_state&amp;project=linux-4.6">set_task_state</A>(<A href="http://172.21.12.145:8080/source/s?defs=tsk&amp;project=linux-4.6">tsk</A>, <A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>)		\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#293" name=293>293</A>	<A href="http://172.21.12.145:8080/source/s?defs=smp_store_mb&amp;project=linux-4.6">smp_store_mb</A>((<A href="http://172.21.12.145:8080/source/s?defs=tsk&amp;project=linux-4.6">tsk</A>)-&gt;<A href="http://172.21.12.145:8080/source/s?defs=state&amp;project=linux-4.6">state</A>, (<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>))
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#294" name=294>294</A>
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#295" name=295>295</A><SPAN class=c>/*
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#296" name=296>296</A> * set_current_state() includes a barrier so that the write of current-&gt;state
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#297" name=297>297</A> * is correctly serialised wrt the caller's subsequent test of whether to
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#298" name=298>298</A> * actually sleep:
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#299" name=299>299</A> *
<A class=hl href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#300" name=300>300</A> *	set_current_state(TASK_UNINTERRUPTIBLE);
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#301" name=301>301</A> *	if (do_i_need_to_sleep())
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#302" name=302>302</A> *		schedule();
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#303" name=303>303</A> *
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#304" name=304>304</A> * If the caller does not need such serialisation then use __set_current_state()
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#305" name=305>305</A> */</SPAN>
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#306" name=306>306</A>#<B>define</B> <A class=xm name=__set_current_state></A><A class=xm href="http://172.21.12.145:8080/source/s?refs=__set_current_state&amp;project=linux-4.6">__set_current_state</A>(<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>)		\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#307" name=307>307</A>	<B>do</B> { <A href="http://172.21.12.145:8080/source/s?defs=current&amp;project=linux-4.6">current</A>-&gt;<A href="http://172.21.12.145:8080/source/s?defs=state&amp;project=linux-4.6">state</A> = (<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>); } <B>while</B> (0)
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#308" name=308>308</A>#<B>define</B> <A class=xm name=set_current_state></A><A class=xm href="http://172.21.12.145:8080/source/s?refs=set_current_state&amp;project=linux-4.6">set_current_state</A>(<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>)			\
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#309" name=309>309</A>	<A href="http://172.21.12.145:8080/source/s?defs=smp_store_mb&amp;project=linux-4.6">smp_store_mb</A>(<A href="http://172.21.12.145:8080/source/s?defs=current&amp;project=linux-4.6">current</A>-&gt;<A href="http://172.21.12.145:8080/source/s?defs=state&amp;project=linux-4.6">state</A>, (<A href="http://172.21.12.145:8080/source/s?defs=state_value&amp;project=linux-4.6">state_value</A>))
<A class=hl href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#310" name=310>310</A>
<A class=l href="http://172.21.12.145:8080/source/xref/linux-4.6/include/linux/sched.h#311" name=311>311</A>#<B>endif</B></PRE>