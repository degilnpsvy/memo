The above example could also be optimized using kref_get_unless_zero() in<BR>the following way: 
<P><SPAN class=cloze>[...]get_entry, release_entry, put_entry</SPAN></P>
<P>Which is useful to remove the mutex lock around kref_put() in put_entry(), but<BR>it's important that kref_get_unless_zero is enclosed in the same critical<BR>section that finds the entry in the lookup table,<BR>otherwise kref_get_unless_zero may reference already freed memory.<BR>Note that it is illegal to use kref_get_unless_zero without checking its<BR>return value. If you are sure (by already having a valid pointer) that<BR>kref_get_unless_zero() will return true, then use kref_get() instead.