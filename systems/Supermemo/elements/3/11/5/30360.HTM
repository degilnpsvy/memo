#if !defined(CONFIG_USER_ONLY)<BR>/* Return true if exception levels below EL3 are in secure state,<BR>&nbsp;* or would be following an exception return to that level.<BR>&nbsp;* Unlike arm_is_secure() (which is always a question about the<BR>&nbsp;* _current_ state of the CPU) this doesn't care about the current<BR>&nbsp;* EL or mode.<BR>&nbsp;*/<BR>static inline bool arm_is_secure_below_el3(CPUARMState *env)<BR>{<BR>&nbsp;&nbsp;&nbsp; if (arm_feature(env, ARM_FEATURE_EL3)) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return !(env-&gt;cp15.scr_el3 &amp; SCR_NS);<BR>&nbsp;&nbsp;&nbsp; } else {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* If EL3 is not supported then the secure state is implementation<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * defined, in which case QEMU defaults to non-secure.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<BR>&nbsp;&nbsp;&nbsp; }<BR>}</P>
<P>/* Return true if the CPU is AArch64 EL3 or AArch32 Mon */<BR>static inline bool arm_is_el3_or_mon(CPUARMState *env)<BR>{<BR>&nbsp;&nbsp;&nbsp; if (arm_feature(env, ARM_FEATURE_EL3)) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (is_a64(env) &amp;&amp; extract32(env-&gt;pstate, 2, 2) == 3) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* CPU currently in AArch64 state and EL3 */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else if (!is_a64(env) &amp;&amp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (env-&gt;uncached_cpsr &amp; CPSR_M) == ARM_CPU_MODE_MON) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* CPU currently in AArch32 state and monitor mode */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; return false;<BR>}</P>
<P>/* Return true if the processor is in secure state */<BR>static inline bool arm_is_secure(CPUARMState *env)<BR>{<BR>&nbsp;&nbsp;&nbsp; if (arm_is_el3_or_mon(env)) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; return arm_is_secure_below_el3(env);<BR>}</P>
<P>#else<BR>static inline bool arm_is_secure_below_el3(CPUARMState *env)<BR>{<BR>&nbsp;&nbsp;&nbsp; return false;<BR>}</P>
<P>static inline bool arm_is_secure(CPUARMState *env)<BR>{<BR>&nbsp;&nbsp;&nbsp; return false;<BR>}<BR>#endif